<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Plan Manager</title>
    <meta name="description" content="AI-assisted training plan manager for engineering teams">
    <meta name="author" content="Training Plan Manager">

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<style>
/* ============================================================================
   TRAINING PLAN MANAGER - CSS DESIGN SYSTEM
   ============================================================================ */

/* === ROOT VARIABLES === */
:root {
    /* Colors - Teal/Green Theme */
    --primary-color: #044d4b;
    --primary-light: #056663;
    --primary-dark: #033d3b;
    --secondary-color: #81b5a1;
    --secondary-light: #a3c9b8;
    --secondary-dark: #5f9a84;

    /* Neutrals */
    --neutral-50: #f8fafc;
    --neutral-100: #f1f5f9;
    --neutral-200: #e2e8f0;
    --neutral-300: #cbd5e1;
    --neutral-400: #94a3b8;
    --neutral-500: #64748b;
    --neutral-600: #475569;
    --neutral-700: #334155;
    --neutral-800: #1e293b;
    --neutral-900: #0f172a;

    /* Status Colors */
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --info-color: #3b82f6;

    /* Backgrounds */
    --bg-page: #f8fafc;
    --bg-card: #ffffff;
    --bg-hover: #f1f5f9;
    --bg-selected: #e0f2f1;

    /* Text */
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #94a3b8;
    --text-inverse: #ffffff;

    /* Borders */
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-dark: #94a3b8;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;

    /* Border Radius */
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 8px;
    --radius-xl: 12px;

    /* Typography */
    --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    --font-mono: 'Monaco', 'Courier New', monospace;
}

/* === RESET & BASE === */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family);
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--bg-page);
    overflow-x: hidden;
}

/* === LAYOUT === */
.app-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: var(--primary-color);
    color: var(--text-inverse);
    padding: 20px 30px;
    margin: -20px -20px 20px -20px;
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    box-shadow: var(--shadow-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.app-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0;
}

.app-subtitle {
    font-size: 13px;
    color: var(--secondary-light);
    margin: 0;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.save-indicator {
    font-size: 12px;
    color: var(--secondary-light);
    padding: 6px 12px;
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.1);
}

.save-indicator.saving {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

/* === GRID SYSTEM === */
.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
}

.grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

.grid-auto {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

/* === CARDS === */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-light);
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.card-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.card-body {
    color: var(--text-secondary);
}

.card-actions {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

/* Metric Cards */
.metric-card {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: var(--text-inverse);
    border: none;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
    margin: 10px 0;
}

.metric-label {
    font-size: 13px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-change {
    font-size: 12px;
    margin-top: 8px;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    display: inline-block;
}

/* === BUTTONS === */
.btn {
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    white-space: nowrap;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn:active {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.btn-primary {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.btn-primary:hover {
    background: var(--primary-light);
}

.btn-secondary {
    background: var(--secondary-color);
    color: var(--text-inverse);
}

.btn-secondary:hover {
    background: var(--secondary-dark);
}

.btn-success {
    background: var(--success-color);
    color: var(--text-inverse);
}

.btn-warning {
    background: var(--warning-color);
    color: var(--text-inverse);
}

.btn-error {
    background: var(--error-color);
    color: var(--text-inverse);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
}

.btn-ghost:hover {
    background: var(--bg-hover);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-lg {
    padding: 14px 28px;
    font-size: 16px;
}

.btn-icon {
    padding: 8px;
    aspect-ratio: 1;
}

/* === TAB NAVIGATION === */
.tab-navigation {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    background: var(--bg-card);
    padding: 10px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
}

.tab-button {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 500;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-button:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.tab-button.active {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.section-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    font-size: 12px;
    font-weight: 600;
}

.tab-button.active .section-number {
    background: rgba(255, 255, 255, 0.2);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* === TABLES === */
.table-container {
    overflow-x: auto;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
}

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-card);
}

thead {
    background: var(--neutral-50);
}

th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border-light);
}

th[onclick] {
    transition: background-color 0.2s ease, color 0.2s ease;
}

th[onclick]:hover {
    background: var(--neutral-100);
    color: var(--primary-600);
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-primary);
}

tr:last-child td {
    border-bottom: none;
}

tbody tr:hover {
    background: var(--bg-hover);
}

.table-actions {
    display: flex;
    gap: 8px;
}

/* === FORMS === */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 6px;
}

.form-label-required::after {
    content: ' *';
    color: var(--error-color);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    font-family: var(--font-family);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--bg-card);
    color: var(--text-primary);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(4, 77, 75, 0.1);
}

.form-input:disabled,
.form-select:disabled,
.form-textarea:disabled {
    background: var(--neutral-100);
    cursor: not-allowed;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.form-help {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.form-error {
    font-size: 12px;
    color: var(--error-color);
    margin-top: 4px;
}

.form-inline {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.form-inline .form-group {
    flex: 1;
    margin-bottom: 0;
}

/* Checkbox & Radio */
.form-checkbox,
.form-radio {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 0;
}

.form-checkbox input[type="checkbox"],
.form-radio input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* === MODALS === */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: fadeIn 0.2s;
}

.modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-large {
    max-width: 900px;
}

.modal-xlarge {
    max-width: 1200px;
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
}

.modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* === BADGES === */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 12px;
    white-space: nowrap;
}

.badge-primary {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.badge-secondary {
    background: var(--secondary-color);
    color: var(--text-inverse);
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-warning {
    background: #fef3c7;
    color: #92400e;
}

.badge-error {
    background: #fee2e2;
    color: #991b1b;
}

.badge-info {
    background: #dbeafe;
    color: #1e40af;
}

.badge-neutral {
    background: var(--neutral-200);
    color: var(--text-secondary);
}

/* === PROGRESS BARS === */
.progress-bar {
    height: 8px;
    background: var(--neutral-200);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s;
    border-radius: 4px;
}

.progress-bar-success .progress-fill {
    background: var(--success-color);
}

.progress-bar-warning .progress-fill {
    background: var(--warning-color);
}

.progress-bar-error .progress-fill {
    background: var(--error-color);
}

/* Progress with label */
.progress-labeled {
    display: flex;
    align-items: center;
    gap: 12px;
}

.progress-labeled .progress-bar {
    flex: 1;
}

.progress-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    min-width: 40px;
    text-align: right;
}

/* === ALERTS === */
.alert {
    padding: 16px;
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border-left: 4px solid var(--success-color);
}

.alert-warning {
    background: #fef3c7;
    color: #92400e;
    border-left: 4px solid var(--warning-color);
}

.alert-error {
    background: #fee2e2;
    color: #991b1b;
    border-left: 4px solid var(--error-color);
}

.alert-info {
    background: #dbeafe;
    color: #1e40af;
    border-left: 4px solid var(--info-color);
}

/* === WIZARD === */
.wizard-container {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 30px;
    box-shadow: var(--shadow-md);
}

.wizard-header {
    text-align: center;
    margin-bottom: 30px;
}

.wizard-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
}

.wizard-subtitle {
    font-size: 14px;
    color: var(--text-muted);
}

.wizard-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 30px 0;
    position: relative;
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
}

.wizard-step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--neutral-200);
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    position: relative;
    z-index: 2;
}

.wizard-step.active .wizard-step-circle {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.wizard-step.completed .wizard-step-circle {
    background: var(--success-color);
    color: var(--text-inverse);
}

.wizard-step-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    text-align: center;
}

.wizard-step.active .wizard-step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.wizard-step-line {
    position: absolute;
    top: 20px;
    left: 50%;
    right: -50%;
    height: 2px;
    background: var(--neutral-200);
    z-index: 1;
}

.wizard-step.completed .wizard-step-line {
    background: var(--success-color);
}

.wizard-step:last-child .wizard-step-line {
    display: none;
}

.wizard-content {
    min-height: 400px;
    margin: 30px 0;
}

.wizard-navigation {
    display: flex;
    justify-content: space-between;
    padding-top: 20px;
    border-top: 1px solid var(--border-light);
}

/* === LISTS === */
.list-group {
    list-style: none;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-light);
}

.list-item {
    padding: 16px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.list-item:last-child {
    border-bottom: none;
}

.list-item:hover {
    background: var(--bg-hover);
}

.list-item-title {
    font-weight: 500;
    color: var(--text-primary);
}

.list-item-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

/* === EMPTY STATES === */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.empty-state-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.empty-state-description {
    font-size: 14px;
    margin-bottom: 20px;
}

/* === UTILITIES === */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-warning { color: var(--warning-color); }
.text-error { color: var(--error-color); }

.font-bold { font-weight: 600; }
.font-normal { font-weight: 400; }

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: var(--spacing-sm); }
.mb-2 { margin-bottom: var(--spacing-md); }
.mb-3 { margin-bottom: var(--spacing-lg); }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: var(--spacing-sm); }
.mt-2 { margin-top: var(--spacing-md); }
.mt-3 { margin-top: var(--spacing-lg); }

.hidden { display: none; }
.block { display: block; }
.inline-block { display: inline-block; }
.flex { display: flex; }

.flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
}

.gap-sm { gap: var(--spacing-sm); }
.gap-md { gap: var(--spacing-md); }
.gap-lg { gap: var(--spacing-lg); }

/* === LOADING SPINNER === */
.spinner {
    border: 3px solid var(--neutral-200);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

.spinner-sm {
    width: 20px;
    height: 20px;
    border-width: 2px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    .grid-2,
    .grid-3,
    .grid-4 {
        grid-template-columns: 1fr;
    }

    .tab-navigation {
        overflow-x: scroll;
    }

    .wizard-progress {
        flex-wrap: wrap;
    }

    .form-inline {
        flex-direction: column;
    }

    .form-inline .form-group {
        width: 100%;
    }
}

/* === QUICK ACTIONS === */
.quick-actions {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
    flex-wrap: wrap;
}

/* === SEARCH & FILTER BAR === */
.search-filter-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-input {
    flex: 1;
    min-width: 250px;
}

/* === STATUS INDICATORS === */
.status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
}

.status-dot.success { background: var(--success-color); }
.status-dot.warning { background: var(--warning-color); }
.status-dot.error { background: var(--error-color); }
.status-dot.info { background: var(--info-color); }
.status-dot.neutral { background: var(--neutral-400); }

/* === LEVEL INDICATORS === */
.level-indicator {
    display: inline-flex;
    gap: 2px;
}

.level-box {
    width: 12px;
    height: 12px;
    background: var(--neutral-200);
    border-radius: 2px;
}

.level-box.filled {
    background: var(--primary-color);
}
</style>

<body>
    <!-- Application Container -->
    <div class="app-container">

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div>
                    <h1 class="app-title">Training Plan Manager</h1>
                    <p class="app-subtitle">AI-Assisted Training Planning for Engineering Teams</p>
                </div>
            </div>
            <div class="header-right">
                <span class="save-indicator" id="saveIndicator">Saved</span>
                <button class="btn btn-ghost" onclick="openSettings()" style="color: white;">‚öôÔ∏è Settings</button>
                <button class="btn btn-ghost" onclick="showHelp()" style="color: white;">‚ùì Help</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab(1)">
                <span class="section-number">1</span> Dashboard
            </button>
            <button class="tab-button" onclick="switchTab(2)">
                <span class="section-number">2</span> Resources
            </button>
            <button class="tab-button" onclick="switchTab(3)">
                <span class="section-number">3</span> Competencies
            </button>
            <button class="tab-button" onclick="switchTab(4)">
                <span class="section-number">4</span> Course Catalog
            </button>
            <button class="tab-button" onclick="switchTab(5)">
                <span class="section-number">5</span> Training Plans
            </button>
            <button class="tab-button" onclick="switchTab(6)">
                <span class="section-number">6</span> Calendars
            </button>
            <button class="tab-button" onclick="switchTab(7)">
                <span class="section-number">7</span> Reports
            </button>
        </div>

        <!-- Tab 1: Dashboard -->
        <div id="tab-1" class="tab-content active">
            <div id="dashboardContent"></div>
        </div>

        <!-- Tab 2: Resources -->
        <div id="tab-2" class="tab-content">
            <div id="resourcesContent"></div>
        </div>

        <!-- Tab 3: Competency Library -->
        <div id="tab-3" class="tab-content">
            <div id="competenciesContent"></div>
        </div>

        <!-- Tab 4: Course Catalog -->
        <div id="tab-4" class="tab-content">
            <div id="coursesContent"></div>
        </div>

        <!-- Tab 5: Training Plans -->
        <div id="tab-5" class="tab-content">
            <div id="trainingPlansContent"></div>
        </div>

        <!-- Tab 6: Calendar Management -->
        <div id="tab-6" class="tab-content">
            <div id="calendarsContent"></div>
        </div>

        <!-- Tab 7: Reports & Analytics -->
        <div id="tab-7" class="tab-content">
            <div id="reportsContent"></div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body" id="settingsContent"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- General Purpose Modal -->
    <div id="generalModal" class="modal-overlay">
        <div class="modal" id="generalModalInner">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- File input for imports (hidden) -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

<script>
// ============================================================================
// TRAINING PLAN MANAGER - JAVASCRIPT
// ============================================================================

// === GLOBAL STATE VARIABLES ===
let resources = [];
let competencyLibrary = [];
let courseCatalog = [];
let regionalCalendars = [];
let trainingPlans = [];
let settings = {
    aiProvider: 'anthropic',
    aiModel: 'claude-3-5-sonnet-20241022',
    apiKey: '',
    aiTemperature: 0.7,
    corsProxy: '', // Optional CORS proxy URL (e.g., 'https://cors-anywhere.herokuapp.com/')
    theme: 'light',
    dateFormat: 'MM/DD/YYYY',
    currency: 'USD',
    currencySymbol: '$',
    defaultWeeklyHours: 5,
    defaultBudget: 5000,
    defaultLearningPace: 'Moderate',
    defaultRegionalCalendar: '',
    autoSaveEnabled: true,
    autoSaveInterval: 2000,
    confirmBeforeDelete: true,
    showTooltips: true,
    lastBackup: null,
    autoBackupEnabled: false,
    backupFrequencyDays: 7
};

let nextResourceId = 1;
let nextCompetencyId = 1;
let nextCourseId = 1;
let nextCalendarId = 1;
let nextPlanId = 1;
let activeTab = 1;
let saveTimeout = null;

const STORAGE_KEY = 'trainingPlanManager_autoSave';
const ACTIVE_TAB_KEY = 'trainingPlanManager_activeTab';
const SECURITY_KEY = 'trainingPlanManager_security';

// Security state (in-memory only)
let decryptedApiKey = null;
let masterPasswordHash = null;
let isSecurityEnabled = false;

// Wizard state
let wizardState = {
    active: false,
    currentStep: 1,
    totalSteps: 6,
    data: {}
};

// Dashboard table sort state
let dashboardSortColumn = null;
let dashboardSortDirection = 'asc';

// Competencies table sort state
let competenciesSortColumn = null;
let competenciesSortDirection = 'asc';

// Courses table sort state
let coursesSortColumn = null;
let coursesSortDirection = 'asc';

// === SECURITY & ENCRYPTION ===
// Web Crypto API functions for secure API key storage

async function deriveKeyFromPassword(password, salt) {
    // Convert password to key material
    const encoder = new TextEncoder();
    const passwordBuffer = encoder.encode(password);

    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        passwordBuffer,
        'PBKDF2',
        false,
        ['deriveBits', 'deriveKey']
    );

    // Derive encryption key using PBKDF2
    return await crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: salt,
            iterations: 100000,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
    );
}

async function encryptApiKey(apiKey, password) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(apiKey);

        // Generate random salt and IV
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));

        // Derive encryption key from password
        const key = await deriveKeyFromPassword(password, salt);

        // Encrypt the API key
        const encrypted = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv: iv },
            key,
            data
        );

        // Convert to base64 for storage
        return {
            salt: arrayBufferToBase64(salt),
            iv: arrayBufferToBase64(iv),
            ciphertext: arrayBufferToBase64(encrypted)
        };
    } catch (error) {
        console.error('Encryption failed:', error);
        throw new Error('Failed to encrypt API key');
    }
}

async function decryptApiKey(encryptedData, password) {
    try {
        // Convert from base64
        const salt = base64ToArrayBuffer(encryptedData.salt);
        const iv = base64ToArrayBuffer(encryptedData.iv);
        const ciphertext = base64ToArrayBuffer(encryptedData.ciphertext);

        // Derive decryption key from password
        const key = await deriveKeyFromPassword(password, salt);

        // Decrypt the API key
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv },
            key,
            ciphertext
        );

        const decoder = new TextDecoder();
        return decoder.decode(decrypted);
    } catch (error) {
        console.error('Decryption failed:', error);
        throw new Error('Incorrect password or corrupted data');
    }
}

async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return arrayBufferToBase64(hashBuffer);
}

function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

function base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

async function setupMasterPassword(password, apiKey) {
    try {
        // Encrypt the API key
        const encrypted = await encryptApiKey(apiKey, password);

        // Hash password for verification (not for decryption)
        const passwordHash = await hashPassword(password);

        // Save encrypted data to localStorage
        const securityConfig = {
            enabled: true,
            version: 1,
            passwordHash: passwordHash,
            encryptedApiKey: encrypted
        };

        localStorage.setItem(SECURITY_KEY, JSON.stringify(securityConfig));

        // Store in memory
        decryptedApiKey = apiKey;
        masterPasswordHash = passwordHash;
        isSecurityEnabled = true;

        // Clear plain text API key from settings
        settings.apiKey = '';

        return true;
    } catch (error) {
        console.error('Failed to setup master password:', error);
        return false;
    }
}

async function verifyAndDecryptApiKey(password) {
    try {
        const securityData = localStorage.getItem(SECURITY_KEY);
        if (!securityData) {
            return { success: false, error: 'No security configuration found' };
        }

        const config = JSON.parse(securityData);

        // Verify password hash
        const providedHash = await hashPassword(password);
        if (providedHash !== config.passwordHash) {
            return { success: false, error: 'Incorrect password' };
        }

        // Decrypt API key
        const apiKey = await decryptApiKey(config.encryptedApiKey, password);

        // Store in memory
        decryptedApiKey = apiKey;
        masterPasswordHash = config.passwordHash;
        isSecurityEnabled = true;

        return { success: true, apiKey: apiKey };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

async function changeMasterPassword(oldPassword, newPassword, apiKey) {
    try {
        // Verify old password
        const verification = await verifyAndDecryptApiKey(oldPassword);
        if (!verification.success) {
            return { success: false, error: 'Current password is incorrect' };
        }

        // Re-encrypt with new password
        const encrypted = await encryptApiKey(apiKey, newPassword);
        const newPasswordHash = await hashPassword(newPassword);

        const securityConfig = {
            enabled: true,
            version: 1,
            passwordHash: newPasswordHash,
            encryptedApiKey: encrypted
        };

        localStorage.setItem(SECURITY_KEY, JSON.stringify(securityConfig));

        // Update in-memory state
        masterPasswordHash = newPasswordHash;

        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

function disableSecurity() {
    // Remove security configuration
    localStorage.removeItem(SECURITY_KEY);

    // Clear in-memory state
    decryptedApiKey = null;
    masterPasswordHash = null;
    isSecurityEnabled = false;

    // Clear API key from settings (user must re-enter)
    settings.apiKey = '';
}

function isSecurityConfigured() {
    const securityData = localStorage.getItem(SECURITY_KEY);
    return securityData !== null;
}

function getEffectiveApiKey() {
    // Return decrypted key if security is enabled, otherwise plain text key
    return isSecurityEnabled ? decryptedApiKey : settings.apiKey;
}

function hasApiKey() {
    // Check if API key is available (either decrypted or in settings)
    return (isSecurityEnabled && decryptedApiKey) || (!isSecurityEnabled && settings.apiKey);
}

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', function() {
    checkLibrariesAndInitialize();
});

function checkLibrariesAndInitialize() {
    // Check if libraries loaded
    if (typeof Chart === 'undefined' || typeof Sortable === 'undefined' || typeof XLSX === 'undefined') {
        alert('Required libraries failed to load. Please check your internet connection and refresh.');
        return;
    }

    // Check if security is configured
    if (isSecurityConfigured()) {
        // Prompt for master password
        promptForMasterPassword();
    } else {
        // Proceed with normal initialization
        initializeApplication();
    }
}

async function promptForMasterPassword() {
    const html = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
            <h3 style="margin: 0 0 8px 0; color: var(--primary-color);">Secure Access</h3>
            <p style="margin: 0 0 24px 0; color: var(--text-muted);">Enter your master password to unlock the application.</p>

            <div style="margin-bottom: 24px;">
                <input type="password" id="masterPasswordInput" class="form-input"
                    placeholder="Master Password" style="width: 100%; max-width: 400px; padding: 12px;"
                    autocomplete="current-password">
                <div id="passwordError" style="color: #ef4444; margin-top: 8px; font-size: 13px; display: none;"></div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-primary" onclick="unlockApplication()" style="min-width: 120px;">Unlock</button>
                <button class="btn btn-ghost" onclick="resetSecurity()">Reset Security</button>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: var(--neutral-100); border-radius: 8px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                <div style="font-size: 13px; color: var(--neutral-700);">
                    <strong style="color: var(--neutral-900);">Security Information:</strong><br>
                    ‚Ä¢ Your API key is encrypted with AES-256 encryption<br>
                    ‚Ä¢ Your master password is never stored<br>
                    ‚Ä¢ Without your password, the API key cannot be decrypted<br>
                    <br>
                    <strong style="color: #f59e0b;">Warning:</strong> If you forget your master password, you will need to reset security and re-enter your API key.
                </div>
            </div>
        </div>
    `;

    // Create a non-closeable modal for password prompt
    const modal = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const modalHeader = document.getElementById('modalHeader');
    const modalBody = document.getElementById('modalBody');
    const modalFooter = document.getElementById('modalFooter');

    modalHeader.innerHTML = '';
    modalBody.innerHTML = html;
    modalFooter.innerHTML = '';
    modal.classList.add('active');
    modalContent.className = 'modal-content modal-medium';

    // Focus password input
    setTimeout(() => {
        const input = document.getElementById('masterPasswordInput');
        if (input) {
            input.focus();
            // Allow Enter key to unlock
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    unlockApplication();
                }
            });
        }
    }, 100);
}

async function unlockApplication() {
    const input = document.getElementById('masterPasswordInput');
    const errorDiv = document.getElementById('passwordError');

    if (!input || !input.value) {
        if (errorDiv) {
            errorDiv.textContent = 'Please enter your master password';
            errorDiv.style.display = 'block';
        }
        return;
    }

    const password = input.value;

    // Show loading state
    const unlockBtn = document.querySelector('.btn-primary');
    if (unlockBtn) {
        unlockBtn.textContent = 'Unlocking...';
        unlockBtn.disabled = true;
    }

    // Attempt to decrypt
    const result = await verifyAndDecryptApiKey(password);

    if (result.success) {
        // Close modal
        closeModal();

        // Proceed with normal initialization
        initializeApplication();
    } else {
        // Show error
        if (errorDiv) {
            errorDiv.textContent = result.error || 'Incorrect password. Please try again.';
            errorDiv.style.display = 'block';
        }

        // Reset button
        if (unlockBtn) {
            unlockBtn.textContent = 'Unlock';
            unlockBtn.disabled = false;
        }

        // Clear and refocus input
        input.value = '';
        input.focus();
    }
}

function resetSecurity() {
    const confirmed = confirm(
        'WARNING: Resetting security will permanently delete your encrypted API key.\n\n' +
        'You will need to re-enter your API key in Settings after resetting.\n\n' +
        'This action cannot be undone. Continue?'
    );

    if (confirmed) {
        // Disable security
        disableSecurity();

        // Close modal
        closeModal();

        // Proceed with normal initialization
        initializeApplication();

        // Show notification
        setTimeout(() => {
            alert('Security has been reset. Please configure your API key in Settings.');
        }, 500);
    }
}

function initializeApplication() {
    // Try to load saved data
    const hasData = loadFromLocalStorage();

    if (!hasData) {
        // Load sample data for first-time users
        loadSampleData();
    }

    // Restore active tab
    const savedTab = localStorage.getItem(ACTIVE_TAB_KEY);
    if (savedTab) {
        activeTab = parseInt(savedTab);
        switchTab(activeTab);
    }

    // Render all views
    renderAllViews();

    // Setup auto-save
    if (settings.autoSaveEnabled) {
        setInterval(autoSave, settings.autoSaveInterval);
    }
}

// === TAB SWITCHING ===
function switchTab(tabNumber) {
    // Remove active class from all tabs
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));

    // Add active class to selected tab
    const activeButton = tabButtons[tabNumber - 1];
    const activeContent = document.getElementById(`tab-${tabNumber}`);

    if (activeButton) activeButton.classList.add('active');
    if (activeContent) activeContent.classList.add('active');

    activeTab = tabNumber;
    localStorage.setItem(ACTIVE_TAB_KEY, activeTab);

    // Render the active tab
    renderActiveTab();
}

function renderActiveTab() {
    switch(activeTab) {
        case 1: renderDashboard(); break;
        case 2: renderResources(); break;
        case 3: renderCompetencies(); break;
        case 4: renderCourses(); break;
        case 5: renderTrainingPlans(); break;
        case 6: renderCalendars(); break;
        case 7: renderReports(); break;
    }
}

function renderAllViews() {
    renderDashboard();
    renderResources();
    renderCompetencies();
    renderCourses();
    renderTrainingPlans();
    renderCalendars();
    renderReports();
}

// === SAVE/LOAD FUNCTIONS ===
function autoSave() {
    saveToLocalStorage();
}

function saveToLocalStorage() {
    const saveData = {
        version: '1.0.24',
        savedDate: new Date().toISOString(),
        resources: resources,
        competencyLibrary: competencyLibrary,
        courseCatalog: courseCatalog,
        regionalCalendars: regionalCalendars,
        trainingPlans: trainingPlans,
        settings: settings,
        nextResourceId: nextResourceId,
        nextCompetencyId: nextCompetencyId,
        nextCourseId: nextCourseId,
        nextCalendarId: nextCalendarId,
        nextPlanId: nextPlanId
    };

    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        showSaveIndicator('Saved');
    } catch (e) {
        console.error('Failed to save:', e);
        showSaveIndicator('Save failed', true);
    }
}

function loadFromLocalStorage() {
    try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) return false;

        const data = JSON.parse(savedData);

        resources = data.resources || [];
        competencyLibrary = data.competencyLibrary || [];
        courseCatalog = data.courseCatalog || [];
        regionalCalendars = data.regionalCalendars || [];
        trainingPlans = data.trainingPlans || [];
        settings = { ...settings, ...(data.settings || {}) };

        nextResourceId = data.nextResourceId || 1;
        nextCompetencyId = data.nextCompetencyId || 1;
        nextCourseId = data.nextCourseId || 1;
        nextCalendarId = data.nextCalendarId || 1;
        nextPlanId = data.nextPlanId || 1;

        // Migrate old single calendar ID to array format (v1.0.19+)
        resources.forEach(resource => {
            if (resource.regionalCalendarId !== undefined && !resource.regionalCalendarIds) {
                resource.regionalCalendarIds = resource.regionalCalendarId ? [resource.regionalCalendarId] : [];
                delete resource.regionalCalendarId;
            }
            // Ensure regionalCalendarIds exists as an array
            if (!resource.regionalCalendarIds) {
                resource.regionalCalendarIds = [];
            }
        });

        // Validate AI model for provider (ensures backward compatibility)
        validateAIModelForProvider();

        return true;
    } catch (e) {
        console.error('Failed to load:', e);
        return false;
    }
}

function showSaveIndicator(message, isError = false) {
    const indicator = document.getElementById('saveIndicator');
    if (!indicator) return;

    indicator.textContent = message;
    indicator.classList.toggle('saving', message === 'Saving...');

    if (isError) {
        indicator.style.background = 'rgba(239, 68, 68, 0.2)';
    } else {
        indicator.style.background = 'rgba(255, 255, 255, 0.1)';
    }
}

function triggerSave() {
    showSaveIndicator('Saving...');
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveToLocalStorage();
    }, 500);
}

// === UTILITY FUNCTIONS ===
function generateId() {
    return `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const year = date.getFullYear();

    if (settings.dateFormat === 'DD/MM/YYYY') {
        return `${day}/${month}/${year}`;
    }
    return `${month}/${day}/${year}`;
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return settings.currencySymbol + '0';
    return settings.currencySymbol + amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function getLevelName(level) {
    const names = {
        1: 'Awareness',
        2: 'Beginner',
        3: 'Intermediate',
        4: 'Advanced',
        5: 'Expert'
    };
    return names[level] || '';
}

function getLevelIndicator(level) {
    let html = '<div class="level-indicator">';
    for (let i = 1; i <= 5; i++) {
        html += `<div class="level-box ${i <= level ? 'filled' : ''}"></div>`;
    }
    html += '</div>';
    return html;
}

function getStatusBadge(status) {
    const statusMap = {
        'Planned': 'badge-neutral',
        'In Progress': 'badge-info',
        'Completed': 'badge-success',
        'Deferred': 'badge-warning',
        'Cancelled': 'badge-error',
        'On Track': 'badge-success',
        'At Risk': 'badge-warning',
        'Behind': 'badge-error'
    };

    const badgeClass = statusMap[status] || 'badge-neutral';
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

function getStatusDot(status) {
    const colorMap = {
        'Planned': 'neutral',
        'In Progress': 'info',
        'Completed': 'success',
        'Deferred': 'warning',
        'Cancelled': 'error',
        'On Track': 'success',
        'At Risk': 'warning',
        'Behind': 'error'
    };

    const color = colorMap[status] || 'neutral';
    return `<span class="status-dot ${color}"></span>`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// === MODAL FUNCTIONS ===
function openModal(title, bodyHtml, footerHtml = '', modalClass = '') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = bodyHtml;
    document.getElementById('modalFooter').innerHTML = footerHtml || '<button class="btn btn-ghost" onclick="closeModal()">Close</button>';

    const modalInner = document.getElementById('generalModalInner');
    // Remove any previous size classes
    modalInner.classList.remove('modal-large', 'modal-small');
    // Add the specified class if provided
    if (modalClass) {
        modalInner.classList.add(modalClass);
    }

    document.getElementById('generalModal').classList.add('active');
}

function closeModal() {
    document.getElementById('generalModal').classList.remove('active');
}

// === SETTINGS FUNCTIONS ===
// AI Model Information Database
// Last Updated: January 24, 2026
const aiModels = {
    anthropic: [
        {
            id: 'claude-opus-4-5-20251101',
            name: 'Claude Opus 4.5',
            recommended: true,
            description: 'Flagship model with highest intelligence. Best for complex training frameworks and detailed competency analysis.',
            strengths: ['Highest intelligence', 'Complex reasoning', 'Expert analysis', 'Comprehensive planning'],
            costPer1M: 'Input: $5/1M tokens | Output: $25/1M tokens',
            costLevel: 'high',
            useCase: 'Ideal for enterprise training programs requiring maximum accuracy and depth',
            exampleCost: 'Typical 3K token analysis: ~$0.09 total'
        },
        {
            id: 'claude-sonnet-4-5-20250929',
            name: 'Claude Sonnet 4.5',
            recommended: true,
            description: 'Latest balanced model. Excellent for comprehensive training plan analysis and competency assessment.',
            strengths: ['Advanced reasoning', 'Technical analysis', 'Detailed planning', 'Code understanding'],
            costPer1M: 'Input: $3/1M tokens | Output: $15/1M tokens',
            costLevel: 'medium',
            useCase: 'Best choice for most training plan creation with optimal quality-cost balance',
            exampleCost: 'Typical 3K token analysis: ~$0.054 total'
        },
        {
            id: 'claude-3-5-sonnet-20241022',
            name: 'Claude 3.5 Sonnet (Oct 2024)',
            recommended: false,
            description: 'Previous flagship. Still highly capable for training planning tasks.',
            strengths: ['Strong reasoning', 'Technical analysis', 'Good planning'],
            costPer1M: 'Input: $3/1M tokens | Output: $15/1M tokens',
            costLevel: 'medium',
            useCase: 'Reliable option for training plan creation',
            exampleCost: 'Typical 3K token analysis: ~$0.054 total'
        },
        {
            id: 'claude-3-5-sonnet-20240620',
            name: 'Claude 3.5 Sonnet (Jun 2024)',
            recommended: false,
            description: 'Earlier version. Good for most training planning tasks.',
            strengths: ['Complex reasoning', 'Technical analysis', 'Planning'],
            costPer1M: 'Input: $3/1M tokens | Output: $15/1M tokens',
            costLevel: 'medium',
            useCase: 'Good for training plan creation',
            exampleCost: 'Typical 3K token analysis: ~$0.054 total'
        },
        {
            id: 'claude-3-opus-20240229',
            name: 'Claude 3 Opus (Legacy)',
            recommended: false,
            description: 'Previous generation flagship. Very expensive, use newer Opus 4.5 instead.',
            strengths: ['High intelligence', 'Complex analysis', 'Expert reasoning'],
            costPer1M: 'Input: $15/1M tokens | Output: $75/1M tokens',
            costLevel: 'very-high',
            useCase: 'Legacy model - consider upgrading to Opus 4.5',
            exampleCost: 'Typical 3K token analysis: ~$0.27 total'
        },
        {
            id: 'claude-3-5-haiku-20241022',
            name: 'Claude 3.5 Haiku',
            recommended: false,
            description: 'Fast and cost-effective. Good for simple competency suggestions.',
            strengths: ['Very fast', 'Cost-effective', 'Quick responses', 'Efficient'],
            costPer1M: 'Input: $1/1M tokens | Output: $5/1M tokens',
            costLevel: 'low',
            useCase: 'Best for quick suggestions and simple queries',
            exampleCost: 'Typical 3K token analysis: ~$0.018 total'
        }
    ],
    openai: [
        {
            id: 'gpt-5.2-2026-01-15',
            name: 'GPT-5.2',
            recommended: true,
            description: 'Latest flagship model. Revolutionary reasoning and analytical capabilities for comprehensive training planning.',
            strengths: ['Superior reasoning', 'Advanced analysis', 'Strategic planning', 'Expert instruction following'],
            costPer1M: 'Input: $1.50/1M tokens | Output: $6/1M tokens',
            costLevel: 'medium',
            useCase: 'Ideal for sophisticated training programs requiring highest quality analysis',
            exampleCost: 'Typical 3K token analysis: ~$0.0225 total'
        },
        {
            id: 'gpt-5.2-mini-2026-01-15',
            name: 'GPT-5.2 Mini',
            recommended: true,
            description: 'Fast and highly capable. Excellent balance of performance and cost for training planning.',
            strengths: ['Fast', 'Strong reasoning', 'Cost-effective', 'Efficient'],
            costPer1M: 'Input: $0.30/1M tokens | Output: $1.20/1M tokens',
            costLevel: 'low',
            useCase: 'Best for high-quality training planning with excellent cost efficiency',
            exampleCost: 'Typical 3K token analysis: ~$0.0045 total'
        },
        {
            id: 'gpt-4.1-2025-04-14',
            name: 'GPT-4.1',
            recommended: false,
            description: 'Previous generation flagship. Still very capable for training planning.',
            strengths: ['Excellent reasoning', 'Instruction following', 'Tool calling', 'Broad knowledge'],
            costPer1M: 'Input: $2/1M tokens | Output: $8/1M tokens',
            costLevel: 'medium',
            useCase: 'Good for comprehensive training plans - consider upgrading to GPT-5.2',
            exampleCost: 'Typical 3K token analysis: ~$0.03 total'
        },
        {
            id: 'gpt-4.1-mini-2025-04-14',
            name: 'GPT-4.1 Mini',
            recommended: false,
            description: 'Fast and cost-effective. Good balance but GPT-5.2 Mini recommended.',
            strengths: ['Fast', 'Cost-effective', 'Good reasoning', 'Efficient'],
            costPer1M: 'Input: $0.40/1M tokens | Output: $1.60/1M tokens',
            costLevel: 'low',
            useCase: 'Consider upgrading to GPT-5.2 Mini for better performance at lower cost',
            exampleCost: 'Typical 3K token analysis: ~$0.006 total'
        },
        {
            id: 'gpt-4o',
            name: 'GPT-4o (Legacy)',
            recommended: false,
            description: 'Multimodal model. Consider upgrading to GPT-5.2 for better performance.',
            strengths: ['Multimodal', 'Strong reasoning', 'Wide knowledge', 'Detailed analysis'],
            costPer1M: 'Input: $2.50/1M tokens | Output: $10/1M tokens',
            costLevel: 'medium',
            useCase: 'Legacy model - GPT-5.2 recommended',
            exampleCost: 'Typical 3K token analysis: ~$0.0375 total'
        },
        {
            id: 'gpt-4o-mini',
            name: 'GPT-4o Mini (Legacy)',
            recommended: false,
            description: 'Fast multimodal model. GPT-5.2 Mini offers better capabilities.',
            strengths: ['Fast', 'Multimodal', 'Cost-effective', 'Quick responses'],
            costPer1M: 'Input: $0.15/1M tokens | Output: $0.60/1M tokens',
            costLevel: 'low',
            useCase: 'Legacy model - GPT-5.2 Mini recommended',
            exampleCost: 'Typical 3K token analysis: ~$0.0027 total'
        },
        {
            id: 'gpt-4-turbo-2024-04-09',
            name: 'GPT-4 Turbo (Legacy)',
            recommended: false,
            description: 'Old generation. Strongly consider upgrading to GPT-5.2.',
            strengths: ['Strong reasoning', 'Wide knowledge', 'Structured output'],
            costPer1M: 'Input: $10/1M tokens | Output: $30/1M tokens',
            costLevel: 'high',
            useCase: 'Legacy model - GPT-5.2 strongly recommended',
            exampleCost: 'Typical 3K token analysis: ~$0.12 total'
        },
        {
            id: 'gpt-3.5-turbo',
            name: 'GPT-3.5 Turbo (Legacy)',
            recommended: false,
            description: 'Older model. Limited capabilities for complex training planning.',
            strengths: ['Fast', 'Very cost-effective', 'Simple tasks'],
            costPer1M: 'Input: $0.50/1M tokens | Output: $1.50/1M tokens',
            costLevel: 'low',
            useCase: 'Only for very simple queries - consider GPT-5.2 Mini instead',
            exampleCost: 'Typical 3K token analysis: ~$0.006 total'
        }
    ],
    google: [
        {
            id: 'gemini-3-flash-preview',
            name: 'Gemini 3 Flash',
            recommended: true,
            description: 'Latest flagship. Frontier-class performance for training planning at excellent value.',
            strengths: ['Frontier intelligence', 'Very fast', 'Cost-effective', 'Strong reasoning'],
            costPer1M: 'Input: $0.50/1M tokens | Output: $3/1M tokens',
            costLevel: 'low',
            useCase: 'Ideal for high-quality training plans with excellent cost efficiency',
            exampleCost: 'Typical 3K token analysis: ~$0.011 total'
        },
        {
            id: 'gemini-2.5-flash',
            name: 'Gemini 2.5 Flash',
            recommended: true,
            description: 'Fast and capable. Excellent for real-time training plan analysis.',
            strengths: ['Fast', 'Cost-effective', 'Good reasoning', 'Efficient'],
            costPer1M: 'Input: $0.15/1M tokens | Output: $0.60/1M tokens',
            costLevel: 'low',
            useCase: 'Best for budget-conscious training planning with good quality',
            exampleCost: 'Typical 3K token analysis: ~$0.0027 total'
        },
        {
            id: 'gemini-2.5-flash-lite',
            name: 'Gemini 2.5 Flash-Lite',
            recommended: false,
            description: 'Ultra cost-effective. Good for simple competency suggestions.',
            strengths: ['Very fast', 'Ultra low cost', 'Efficient', 'Quick responses'],
            costPer1M: 'Input: $0.10/1M tokens | Output: $0.40/1M tokens',
            costLevel: 'low',
            useCase: 'Best for high-volume simple queries with minimal cost',
            exampleCost: 'Typical 3K token analysis: ~$0.0018 total'
        },
        {
            id: 'gemini-2.0-flash-lite',
            name: 'Gemini 2.0 Flash-Lite (Deprecated)',
            recommended: false,
            description: 'Will be retired March 31, 2026. Migrate to Gemini 2.5 Flash-Lite.',
            strengths: ['Low cost', 'Fast'],
            costPer1M: 'Input: $0.075/1M tokens | Output: $0.30/1M tokens',
            costLevel: 'low',
            useCase: 'DEPRECATED - Use Gemini 2.5 Flash-Lite instead',
            exampleCost: 'Typical 3K token analysis: ~$0.0014 total'
        },
        {
            id: 'gemini-1.5-pro-latest',
            name: 'Gemini 1.5 Pro (Legacy)',
            recommended: false,
            description: 'Previous generation. Large context window but consider newer models.',
            strengths: ['Huge context window', 'Multimodal', 'Good reasoning'],
            costPer1M: 'Input: $3.50/1M tokens | Output: $10.50/1M tokens',
            costLevel: 'medium',
            useCase: 'Legacy model - Gemini 3 Flash recommended for better value',
            exampleCost: 'Typical 3K token analysis: ~$0.042 total'
        },
        {
            id: 'gemini-1.5-flash-latest',
            name: 'Gemini 1.5 Flash (Legacy)',
            recommended: false,
            description: 'Previous generation. Consider upgrading to Gemini 2.5 or 3 Flash.',
            strengths: ['Fast', 'Good context window', 'Multimodal'],
            costPer1M: 'Input: $0.35/1M tokens | Output: $1.05/1M tokens',
            costLevel: 'low',
            useCase: 'Legacy model - Gemini 2.5 or 3 Flash recommended',
            exampleCost: 'Typical 3K token analysis: ~$0.0042 total'
        }
    ]
};

// Ensure AI model is valid for provider
function validateAIModelForProvider() {
    const provider = settings.aiProvider || 'anthropic';
    const models = aiModels[provider] || [];

    // Check if current model is valid for current provider
    const isValidModel = models.some(m => m.id === settings.aiModel);

    if (!isValidModel) {
        // Set to recommended model for this provider
        const recommendedModel = models.find(m => m.recommended) || models[0];
        if (recommendedModel) {
            settings.aiModel = recommendedModel.id;
        }
    }
}

function updateModelDropdown() {
    const provider = document.getElementById('settingAiProvider').value;
    const modelSelect = document.getElementById('settingAiModel');
    const modelInfo = document.getElementById('modelInfo');

    const models = aiModels[provider] || [];

    // If switching providers, set to recommended model for new provider
    const currentModelValid = models.some(m => m.id === settings.aiModel);
    if (!currentModelValid) {
        const recommendedModel = models.find(m => m.recommended) || models[0];
        settings.aiModel = recommendedModel ? recommendedModel.id : '';
    }

    // Build model dropdown
    let options = '';
    models.forEach(model => {
        const recommended = model.recommended ? ' ‚≠ê RECOMMENDED' : '';
        const selected = settings.aiModel === model.id ? 'selected' : '';
        options += `<option value="${model.id}" ${selected}>${model.name}${recommended}</option>`;
    });

    modelSelect.innerHTML = options;

    // Update model info display
    updateModelInfo();
}

function updateModelInfo() {
    const provider = document.getElementById('settingAiProvider').value;
    const modelId = document.getElementById('settingAiModel').value;
    const modelInfo = document.getElementById('modelInfo');

    const models = aiModels[provider] || [];
    const selectedModel = models.find(m => m.id === modelId);

    if (!selectedModel) {
        modelInfo.innerHTML = '';
        return;
    }

    const costColor = {
        'low': '#22c55e',
        'medium': '#f59e0b',
        'high': '#f97316',
        'very-high': '#ef4444'
    }[selectedModel.costLevel] || '#666';

    const recommendedBadge = selectedModel.recommended
        ? '<span class="badge badge-success" style="margin-left: 8px;">‚≠ê Recommended</span>'
        : '';

    modelInfo.innerHTML = `
        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 16px; margin-top: 12px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <strong style="font-size: 15px;">${selectedModel.name}</strong>
                ${recommendedBadge}
            </div>

            <p style="margin: 8px 0; color: #495057; font-size: 14px;">${selectedModel.description}</p>

            <div style="margin: 12px 0;">
                <div style="font-size: 13px; font-weight: 600; color: #495057; margin-bottom: 6px;">Key Strengths:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    ${selectedModel.strengths.map(s => `<span class="badge badge-info" style="font-size: 12px;">${s}</span>`).join('')}
                </div>
            </div>

            <div style="margin: 12px 0;">
                <div style="font-size: 13px; font-weight: 600; color: #495057; margin-bottom: 4px;">Best For:</div>
                <p style="margin: 0; font-size: 13px; color: #6c757d; font-style: italic;">${selectedModel.useCase}</p>
            </div>

            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">
                <div style="margin-bottom: 6px;">
                    <span style="font-size: 13px; color: #6c757d;">Pricing: </span>
                    <strong style="color: ${costColor}; font-size: 13px;">${selectedModel.costPer1M}</strong>
                </div>
                <div style="font-size: 12px; color: #6c757d; font-style: italic;">
                    ${selectedModel.exampleCost}
                </div>
            </div>
        </div>
    `;
}

function openSettings() {
    const currentProvider = settings.aiProvider || 'anthropic';
    const currentModel = settings.aiModel || aiModels[currentProvider][0].id;
    const hasEncryptedKey = isSecurityConfigured();
    const apiKeyValue = decryptedApiKey || settings.apiKey || '';

    const html = `
        <div style="padding: 8px 0;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px;">üîí Security</h3>

            ${hasEncryptedKey ? `
                <div class="alert alert-success" style="margin-bottom: 20px;">
                    <strong>‚úì Security Enabled</strong> - Your API key is encrypted with AES-256 encryption and protected by your master password.
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="showChangePasswordDialog()">Change Master Password</button>
                    <button class="btn btn-error" onclick="confirmDisableSecurity()">Disable Security</button>
                </div>
            ` : `
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Security Not Enabled</strong> - Your API key is stored in plain text. Enable security to encrypt it.
                </div>

                <div class="form-group">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn btn-primary" onclick="showEnableSecurityDialog()">Enable Security (Recommended)</button>
                        <span style="color: var(--text-muted); font-size: 13px;">Protect your API key with a master password</span>
                    </div>
                </div>
            `}
        </div>

        <div style="padding: 24px 0 8px 0;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px;">AI Configuration</h3>

            <div class="form-group">
                <label class="form-label">AI Provider</label>
                <select class="form-select" id="settingAiProvider" onchange="updateModelDropdown()">
                    <option value="anthropic" ${currentProvider === 'anthropic' ? 'selected' : ''}>Anthropic (Claude)</option>
                    <option value="openai" ${currentProvider === 'openai' ? 'selected' : ''}>OpenAI (GPT)</option>
                    <option value="google" ${currentProvider === 'google' ? 'selected' : ''}>Google (Gemini)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">AI Model</label>
                <select class="form-select" id="settingAiModel" onchange="updateModelInfo()">
                    <!-- Populated by updateModelDropdown() -->
                </select>
                <div id="modelInfo"></div>
            </div>

            <div class="form-group">
                <label class="form-label">API Key ${hasEncryptedKey ? '<span class="badge" style="background: #22c55e; color: white; font-size: 11px; margin-left: 8px;">Encrypted</span>' : ''}</label>
                <input type="password" class="form-input" id="settingApiKey" value="${apiKeyValue}" placeholder="Enter your API key">
                <div class="form-help">${hasEncryptedKey ? 'Your API key is encrypted. Changes will be automatically encrypted with your master password.' : 'Your API key is stored locally and never sent anywhere except to the AI provider. Enable security above to encrypt it.'}</div>
            </div>
        </div>

        <div style="padding: 24px 0 8px 0;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px;">‚öôÔ∏è Advanced</h3>

            <div class="form-group">
                <label class="form-label">CORS Proxy <span class="badge badge-info" style="font-size: 10px; margin-left: 8px;">Optional</span></label>
                <input type="text" class="form-input" id="settingCorsProxy" value="${escapeHtml(settings.corsProxy || '')}" placeholder="https://cors-anywhere.herokuapp.com/">
                <div class="form-help"><strong>Required for browser-based API calls.</strong> AI providers block direct browser requests due to CORS security. Enter a CORS proxy URL (e.g., https://cors-anywhere.herokuapp.com/) or leave blank if running via local server. See API Integration guide for setup instructions.</div>
            </div>
        </div>

        <div style="padding: 24px 0 8px 0;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px;">Application Settings</h3>

            <div class="form-group">
                <label class="form-label">Currency</label>
                <select class="form-select" id="settingCurrency">
                    <option value="USD" ${settings.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                    <option value="EUR" ${settings.currency === 'EUR' ? 'selected' : ''}>EUR (‚Ç¨)</option>
                    <option value="GBP" ${settings.currency === 'GBP' ? 'selected' : ''}>GBP (¬£)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Date Format</label>
                <select class="form-select" id="settingDateFormat">
                    <option value="MM/DD/YYYY" ${settings.dateFormat === 'MM/DD/YYYY' ? 'selected' : ''}>MM/DD/YYYY</option>
                    <option value="DD/MM/YYYY" ${settings.dateFormat === 'DD/MM/YYYY' ? 'selected' : ''}>DD/MM/YYYY</option>
                    <option value="YYYY-MM-DD" ${settings.dateFormat === 'YYYY-MM-DD' ? 'selected' : ''}>YYYY-MM-DD</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Default Weekly Training Hours</label>
                <input type="number" class="form-input" id="settingDefaultWeeklyHours" value="${settings.defaultWeeklyHours}" min="1" max="40">
            </div>

            <div class="form-group">
                <label class="form-label">Default Annual Budget</label>
                <input type="number" class="form-input" id="settingDefaultBudget" value="${settings.defaultBudget}" min="0">
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="settingAutoSave" ${settings.autoSaveEnabled ? 'checked' : ''}>
                    <span>Enable auto-save</span>
                </label>
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="settingConfirmDelete" ${settings.confirmBeforeDelete ? 'checked' : ''}>
                    <span>Confirm before deleting items</span>
                </label>
            </div>
        </div>
    `;

    document.getElementById('settingsContent').innerHTML = html;
    document.getElementById('settingsModal').classList.add('active');

    // Initialize model dropdown
    updateModelDropdown();
}

function closeSettings() {
    document.getElementById('settingsModal').classList.remove('active');
}

async function saveSettings() {
    settings.aiProvider = document.getElementById('settingAiProvider').value;
    settings.aiModel = document.getElementById('settingAiModel').value;
    const newApiKey = document.getElementById('settingApiKey').value;
    settings.corsProxy = document.getElementById('settingCorsProxy').value.trim();
    settings.currency = document.getElementById('settingCurrency').value;
    settings.dateFormat = document.getElementById('settingDateFormat').value;
    settings.defaultWeeklyHours = parseInt(document.getElementById('settingDefaultWeeklyHours').value);
    settings.defaultBudget = parseFloat(document.getElementById('settingDefaultBudget').value);
    settings.autoSaveEnabled = document.getElementById('settingAutoSave').checked;
    settings.confirmBeforeDelete = document.getElementById('settingConfirmDelete').checked;

    // Update currency symbol
    const currencySymbols = { 'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£' };
    settings.currencySymbol = currencySymbols[settings.currency] || '$';

    // Handle API key based on security status
    if (isSecurityConfigured()) {
        // Security is enabled - check if API key changed
        if (newApiKey && newApiKey !== decryptedApiKey) {
            // API key changed - re-encrypt with current master password
            try {
                // Get current security config to get salt/password hash
                const securityData = localStorage.getItem(SECURITY_KEY);
                const config = JSON.parse(securityData);

                // We need the password to re-encrypt
                // For now, prompt for password to confirm change
                const password = prompt('Enter your master password to update the API key:');
                if (!password) {
                    alert('API key not updated - master password required');
                    closeSettings();
                    return;
                }

                // Verify password and re-encrypt
                const result = await changeMasterPassword(password, password, newApiKey);
                if (result.success) {
                    decryptedApiKey = newApiKey;
                    settings.apiKey = ''; // Clear from settings
                } else {
                    alert('Failed to update API key: ' + result.error);
                    closeSettings();
                    return;
                }
            } catch (error) {
                console.error('Error updating encrypted API key:', error);
                alert('Failed to encrypt API key');
                closeSettings();
                return;
            }
        } else {
            // API key unchanged or empty
            settings.apiKey = ''; // Ensure it's not stored in plain text
        }
    } else {
        // Security not enabled - store in plain text (for now)
        settings.apiKey = newApiKey;
    }

    closeSettings();
    triggerSave();
    renderAllViews();
}

function showEnableSecurityDialog() {
    const apiKeyInput = document.getElementById('settingApiKey');
    const apiKey = apiKeyInput ? apiKeyInput.value : '';

    if (!apiKey) {
        alert('Please enter your API key first before enabling security.');
        return;
    }

    const html = `
        <div style="padding: 20px;">
            <h3 style="margin: 0 0 16px 0; color: var(--primary-color);">Enable API Key Encryption</h3>
            <p style="margin: 0 0 20px 0;">Create a master password to encrypt your API key. You will need this password each time you open the application.</p>

            <div class="form-group">
                <label class="form-label">Master Password</label>
                <input type="password" class="form-input" id="newMasterPassword" placeholder="Enter master password" autocomplete="new-password">
            </div>

            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="confirmMasterPassword" placeholder="Confirm master password" autocomplete="new-password">
            </div>

            <div class="alert alert-warning" style="margin-top: 20px;">
                <strong>Important:</strong> Remember your master password! If you forget it, you will need to reset security and re-enter your API key.
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal(); openSettings();">Cancel</button>
        <button class="btn btn-primary" onclick="enableSecurity('${escapeHtml(apiKey)}')">Enable Security</button>
    `;

    openModal('Enable Security', html, footer);

    // Focus first input
    setTimeout(() => {
        const input = document.getElementById('newMasterPassword');
        if (input) input.focus();
    }, 100);
}

async function enableSecurity(apiKey) {
    const password = document.getElementById('newMasterPassword').value;
    const confirm = document.getElementById('confirmMasterPassword').value;

    if (!password) {
        alert('Please enter a master password');
        return;
    }

    if (password.length < 8) {
        alert('Master password must be at least 8 characters');
        return;
    }

    if (password !== confirm) {
        alert('Passwords do not match');
        return;
    }

    // Setup master password and encrypt API key
    const success = await setupMasterPassword(password, apiKey);

    if (success) {
        // Save to trigger storage update
        triggerSave();

        closeModal();
        alert('Security enabled successfully! Your API key is now encrypted.');

        // Reopen settings to show new security status
        openSettings();
    } else {
        alert('Failed to enable security. Please try again.');
    }
}

function showChangePasswordDialog() {
    const html = `
        <div style="padding: 20px;">
            <h3 style="margin: 0 0 16px 0; color: var(--primary-color);">Change Master Password</h3>
            <p style="margin: 0 0 20px 0;">Enter your current password and choose a new password.</p>

            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password" autocomplete="current-password">
            </div>

            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-input" id="newPasswordChange" placeholder="Enter new password" autocomplete="new-password">
            </div>

            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-input" id="confirmPasswordChange" placeholder="Confirm new password" autocomplete="new-password">
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal(); openSettings();">Cancel</button>
        <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
    `;

    openModal('Change Master Password', html, footer);

    // Focus first input
    setTimeout(() => {
        const input = document.getElementById('currentPassword');
        if (input) input.focus();
    }, 100);
}

async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPasswordChange').value;
    const confirmPassword = document.getElementById('confirmPasswordChange').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill in all fields');
        return;
    }

    if (newPassword.length < 8) {
        alert('New password must be at least 8 characters');
        return;
    }

    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }

    // Change the master password
    const result = await changeMasterPassword(currentPassword, newPassword, decryptedApiKey);

    if (result.success) {
        closeModal();
        alert('Master password changed successfully!');
        openSettings();
    } else {
        alert('Failed to change password: ' + result.error);
    }
}

function confirmDisableSecurity() {
    const confirmed = confirm(
        'WARNING: Disabling security will decrypt your API key and store it in plain text.\n\n' +
        'Your API key will no longer be protected by encryption.\n\n' +
        'Continue?'
    );

    if (confirmed) {
        disableSecurityWithKey();
    }
}

function disableSecurityWithKey() {
    // Move decrypted key to settings
    if (decryptedApiKey) {
        settings.apiKey = decryptedApiKey;
    }

    // Disable security
    disableSecurity();

    // Save and update UI
    triggerSave();
    alert('Security disabled. Your API key is now stored in plain text.');
    openSettings();
}

function showHelp() {
    const html = `
        <h3>Welcome to Training Plan Manager</h3>
        <p>This application helps engineering managers create AI-assisted training plans for their technical team members.</p>

        <h4 style="margin-top: 20px;">Getting Started:</h4>
        <ol>
            <li><strong>Configure AI:</strong> Click Settings (‚öôÔ∏è) and enter your API key</li>
            <li><strong>Enable Security:</strong> Protect your API key with encryption (recommended)</li>
            <li><strong>Add Resources:</strong> Go to the Resources tab and add team members</li>
            <li><strong>Build Library:</strong> Add competencies and courses to your library</li>
            <li><strong>Create Plans:</strong> Use the Training Plans wizard to create AI-assisted training plans</li>
        </ol>

        <h4 style="margin-top: 20px;">Features:</h4>
        <ul>
            <li><strong>Dashboard:</strong> At-a-glance overview of your training program</li>
            <li><strong>Resources:</strong> Manage team members and track their competencies</li>
            <li><strong>Competencies:</strong> Build a reusable library of skills and competencies</li>
            <li><strong>Course Catalog:</strong> Track available training courses</li>
            <li><strong>Training Plans:</strong> Create comprehensive training plans with AI assistance</li>
            <li><strong>Calendars:</strong> Manage regional holidays and availability</li>
            <li><strong>Reports:</strong> Analyze budget, progress, and effectiveness</li>
        </ul>

        <h4 style="margin-top: 20px;">Security:</h4>
        <p>Your API key can be encrypted with a master password using AES-256 encryption:</p>
        <ul>
            <li>Enable security in Settings to protect your API key</li>
            <li>You'll be prompted for your master password each session</li>
            <li>Without the password, the API key cannot be decrypted</li>
        </ul>

        <h4 style="margin-top: 20px;">Data Management:</h4>
        <p>All data is stored locally in your browser. You can:</p>
        <ul>
            <li>Export to JSON for backup</li>
            <li>Import from JSON to restore data</li>
            <li>Load sample data to see examples</li>
        </ul>

        <div class="alert alert-info" style="margin-top: 20px;">
            <strong>Privacy Note:</strong> Your data never leaves your computer except when making AI API calls. With security enabled, your API key is encrypted using industry-standard AES-256 encryption.
        </div>
    `;

    openModal('Help & Documentation', html);
}

// === DASHBOARD (TAB 1) ===
function renderDashboard() {
    const content = document.getElementById('dashboardContent');

    const metrics = calculateDashboardMetrics();

    const html = `
        <!-- Metrics Cards -->
        <div class="grid-3 mb-2">
            <div class="card metric-card">
                <div class="metric-label">Total Resources</div>
                <div class="metric-value">${metrics.totalResources}</div>
                <div class="metric-change">${metrics.locations} locations</div>
            </div>

            <div class="card metric-card">
                <div class="metric-label">Training Budget</div>
                <div class="metric-value" style="color: ${metrics.trainingBudgetUtilization >= 100 ? '#ef4444' : metrics.trainingBudgetUtilization >= 80 ? '#f59e0b' : '#22c55e'};">${formatCurrency(metrics.totalTrainingBudgetUsed)} / ${formatCurrency(metrics.totalTrainingBudget)}</div>
                <div class="metric-change">${metrics.trainingBudgetUtilization}% utilized (${formatCurrency(metrics.totalTrainingBudgetSpent)} spent + ${formatCurrency(metrics.totalTrainingBudgetCommitted)} committed)</div>
            </div>

            <div class="card metric-card">
                <div class="metric-label">Travel & Expense Budget</div>
                <div class="metric-value" style="color: ${metrics.travelBudgetUtilization >= 100 ? '#ef4444' : metrics.travelBudgetUtilization >= 80 ? '#f59e0b' : '#22c55e'};">${formatCurrency(metrics.totalTravelBudgetUsed)} / ${formatCurrency(metrics.totalTravelBudget)}</div>
                <div class="metric-change">${metrics.travelBudgetUtilization}% utilized (${formatCurrency(metrics.totalTravelBudgetSpent)} spent + ${formatCurrency(metrics.totalTravelBudgetCommitted)} committed)</div>
            </div>

            <div class="card metric-card">
                <div class="metric-label">Training Plans</div>
                <div class="metric-value">${metrics.activePlans}</div>
                <div class="metric-change">${metrics.completionRate}% completion rate</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="btn btn-primary" onclick="switchTab(2); showAddResourceForm()">+ Add Resource</button>
            <button class="btn btn-primary" onclick="switchTab(5); startNewPlan()">+ Create Training Plan</button>
            <button class="btn btn-secondary" onclick="switchTab(3)">Manage Competencies</button>
            <button class="btn btn-secondary" onclick="switchTab(4)">Browse Courses</button>
        </div>

        <!-- Resources Overview -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Resources at a Glance</h3>
                <button class="btn btn-sm btn-ghost" onclick="switchTab(2)">View All ‚Üí</button>
            </div>
            <div class="card-body">
                ${renderResourcesTable()}
            </div>
        </div>

        <!-- Bottom Row: Deadlines & Activity -->
        <div class="grid-2 mt-2">
            <div class="card">
                <h3 class="card-title">Upcoming Deadlines</h3>
                <div class="card-body">
                    ${renderUpcomingDeadlines()}
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Recent Activity</h3>
                <div class="card-body">
                    ${renderRecentActivity()}
                </div>
            </div>
        </div>
    `;

    content.innerHTML = html;
}

function calculateDashboardMetrics() {
    const totalResources = resources.length;
    const locations = new Set(resources.map(r => r.location)).size;

    // Training budget metrics
    const totalTrainingBudget = resources.reduce((sum, r) => sum + (r.annualTrainingBudget || 0), 0);
    const totalTrainingBudgetSpent = resources.reduce((sum, r) => sum + (r.budgetSpent || 0), 0);
    const totalTrainingBudgetCommitted = trainingPlans.reduce((sum, p) => sum + (p.totalCost || 0), 0);
    const totalTrainingBudgetUsed = totalTrainingBudgetSpent + totalTrainingBudgetCommitted;
    const trainingBudgetUtilization = totalTrainingBudget > 0 ? Math.round((totalTrainingBudgetUsed / totalTrainingBudget) * 100) : 0;

    // Travel & Expense budget metrics
    const totalTravelBudget = resources.reduce((sum, r) => sum + (r.annualTravelBudget || 0), 0);
    const totalTravelBudgetSpent = resources.reduce((sum, r) => sum + (r.travelBudgetSpent || 0), 0);
    const totalTravelBudgetCommitted = trainingPlans.reduce((sum, p) => sum + (p.totalTravelCost || 0), 0);
    const totalTravelBudgetUsed = totalTravelBudgetSpent + totalTravelBudgetCommitted;
    const travelBudgetUtilization = totalTravelBudget > 0 ? Math.round((totalTravelBudgetUsed / totalTravelBudget) * 100) : 0;

    const activePlans = trainingPlans.filter(p => p.status === 'Active').length;

    let completedCourses = 0;
    let totalCourses = 0;
    resources.forEach(r => {
        if (r.assignedCourses) {
            totalCourses += r.assignedCourses.length;
            completedCourses += r.assignedCourses.filter(c => c.status === 'Completed').length;
        }
    });
    const completionRate = totalCourses > 0 ? Math.round((completedCourses / totalCourses) * 100) : 0;

    return {
        totalResources,
        locations,
        totalTrainingBudget,
        totalTrainingBudgetSpent,
        totalTrainingBudgetCommitted,
        totalTrainingBudgetUsed,
        trainingBudgetUtilization,
        totalTravelBudget,
        totalTravelBudgetSpent,
        totalTravelBudgetCommitted,
        totalTravelBudgetUsed,
        travelBudgetUtilization,
        activePlans,
        completionRate
    };
}

function renderResourcesTable() {
    if (resources.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-title">No Resources Yet</div>
            <div class="empty-state-description">Add your first team member to get started.</div>
            <button class="btn btn-primary" onclick="switchTab(2); showAddResourceForm()">+ Add Resource</button>
        </div>`;
    }

    // Helper function to get sort indicator
    const getSortIndicator = (column) => {
        if (dashboardSortColumn === column) {
            return dashboardSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
        return '';
    };

    // Prepare resource data with computed values for sorting
    const resourceData = resources.map(resource => {
        const trainingBudgetSpent = resource.budgetSpent || 0;
        const trainingBudgetTotal = resource.annualTrainingBudget || 0;
        const resourcePlans = trainingPlans.filter(p => p.resourceId === resource.id);
        const committedBudget = resourcePlans.reduce((sum, plan) => sum + (plan.totalCost || 0), 0);
        const totalUsed = trainingBudgetSpent + committedBudget;
        const budgetPercent = trainingBudgetTotal > 0 ? Math.round((totalUsed / trainingBudgetTotal) * 100) : 0;

        const assignedCourses = resource.assignedCourses || [];
        const completedCourses = assignedCourses.filter(c => c.status === 'Completed').length;

        let status = 'On Track';
        if (budgetPercent >= 100) status = 'Over Budget';
        else if (budgetPercent > 90) status = 'At Risk';
        else if (completedCourses < assignedCourses.length * 0.5 && assignedCourses.length > 0) status = 'Behind';

        return {
            resource,
            trainingBudgetSpent,
            trainingBudgetTotal,
            committedBudget,
            totalUsed,
            budgetPercent,
            assignedCourses,
            completedCourses,
            status
        };
    });

    // Sort resources based on current sort state
    if (dashboardSortColumn) {
        resourceData.sort((a, b) => {
            let aVal, bVal;

            switch (dashboardSortColumn) {
                case 'name':
                    aVal = a.resource.name.toLowerCase();
                    bVal = b.resource.name.toLowerCase();
                    break;
                case 'title':
                    aVal = (a.resource.jobTitle || '').toLowerCase();
                    bVal = (b.resource.jobTitle || '').toLowerCase();
                    break;
                case 'location':
                    aVal = (a.resource.location || '').toLowerCase();
                    bVal = (b.resource.location || '').toLowerCase();
                    break;
                case 'budget':
                    aVal = a.budgetPercent;
                    bVal = b.budgetPercent;
                    break;
                case 'courses':
                    aVal = a.assignedCourses.length;
                    bVal = b.assignedCourses.length;
                    break;
                case 'status':
                    // Sort by status priority: Over Budget, At Risk, Behind, On Track
                    const statusOrder = { 'Over Budget': 0, 'At Risk': 1, 'Behind': 2, 'On Track': 3 };
                    aVal = statusOrder[a.status];
                    bVal = statusOrder[b.status];
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return dashboardSortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return dashboardSortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    let html = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortDashboardTable('name')" style="cursor: pointer; user-select: none;">Name${getSortIndicator('name')}</th>
                        <th onclick="sortDashboardTable('title')" style="cursor: pointer; user-select: none;">Title${getSortIndicator('title')}</th>
                        <th onclick="sortDashboardTable('location')" style="cursor: pointer; user-select: none;">Location${getSortIndicator('location')}</th>
                        <th onclick="sortDashboardTable('budget')" style="cursor: pointer; user-select: none;">Budget${getSortIndicator('budget')}</th>
                        <th onclick="sortDashboardTable('courses')" style="cursor: pointer; user-select: none;">Courses${getSortIndicator('courses')}</th>
                        <th onclick="sortDashboardTable('status')" style="cursor: pointer; user-select: none;">Status${getSortIndicator('status')}</th>
                    </tr>
                </thead>
                <tbody>
    `;

    resourceData.slice(0, 10).forEach(({ resource, trainingBudgetSpent, trainingBudgetTotal, committedBudget, totalUsed, budgetPercent, assignedCourses, completedCourses, status }) => {
        let budgetStatusBadge = '';
        let budgetColor = '#22c55e';
        if (budgetPercent >= 100) {
            budgetStatusBadge = '<span class="badge" style="background: #ef4444; color: white; font-size: 10px; margin-left: 4px;">Over</span>';
            budgetColor = '#ef4444';
        } else if (budgetPercent >= 80) {
            budgetStatusBadge = '<span class="badge" style="background: #f59e0b; color: white; font-size: 10px; margin-left: 4px;">Near Limit</span>';
            budgetColor = '#f59e0b';
        }

        const courseStatus = `${completedCourses} / ${assignedCourses.length}`;

        html += `
            <tr onclick="viewResourceDetail(${resource.id})" style="cursor: pointer;">
                <td><strong>${escapeHtml(resource.name)}</strong></td>
                <td>${escapeHtml(resource.jobTitle || '')}</td>
                <td>${escapeHtml(resource.location || '')}</td>
                <td>
                    <span style="color: ${budgetColor};">${formatCurrency(totalUsed)} / ${formatCurrency(trainingBudgetTotal)}</span>
                    ${budgetStatusBadge}
                    ${committedBudget > 0 ? `<div style="font-size: 11px; color: var(--neutral-600); margin-top: 2px;">Spent: ${formatCurrency(trainingBudgetSpent)} | Committed: ${formatCurrency(committedBudget)}</div>` : ''}
                </td>
                <td>${courseStatus}</td>
                <td>${getStatusDot(status)} ${status}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';

    if (resources.length > 10) {
        html += `<div style="text-align: center; margin-top: 12px; color: var(--text-muted);">
            Showing 10 of ${resources.length} resources. <a href="#" onclick="switchTab(2); return false;">View all ‚Üí</a>
        </div>`;
    }

    return html;
}

function sortDashboardTable(column) {
    // If clicking the same column, toggle direction; otherwise, set to ascending
    if (dashboardSortColumn === column) {
        dashboardSortDirection = dashboardSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        dashboardSortColumn = column;
        dashboardSortDirection = 'asc';
    }

    // Re-render the dashboard to reflect the new sort
    renderDashboard();
}

function renderUpcomingDeadlines() {
    const deadlines = [];

    resources.forEach(resource => {
        if (resource.assignedCourses) {
            resource.assignedCourses.forEach(course => {
                if (course.scheduledEndDate && course.status !== 'Completed') {
                    deadlines.push({
                        resourceName: resource.name,
                        date: course.scheduledEndDate,
                        description: `${resource.name}: Complete course`
                    });
                }
            });
        }

        if (resource.desiredCompetencies) {
            resource.desiredCompetencies.forEach(comp => {
                if (comp.targetDate) {
                    deadlines.push({
                        resourceName: resource.name,
                        date: comp.targetDate,
                        description: `${resource.name}: Achieve competency target`
                    });
                }
            });
        }
    });

    deadlines.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (deadlines.length === 0) {
        return '<div class="text-muted">No upcoming deadlines</div>';
    }

    let html = '<ul class="list-group" style="border: none;">';
    deadlines.slice(0, 5).forEach(deadline => {
        html += `<li class="list-item">
            <div>
                <div class="list-item-title">${deadline.description}</div>
                <div class="list-item-subtitle">${formatDate(deadline.date)}</div>
            </div>
        </li>`;
    });
    html += '</ul>';

    return html;
}

function renderRecentActivity() {
    return `<ul class="list-group" style="border: none;">
        <li class="list-item">
            <div class="list-item-title">Sample data loaded</div>
            <div class="list-item-subtitle">Just now</div>
        </li>
        <li class="list-item">
            <div class="list-item-title">Application initialized</div>
            <div class="list-item-subtitle">Just now</div>
        </li>
    </ul>`;
}

// === RESOURCES (TAB 2) ===
function renderResources() {
    const content = document.getElementById('resourcesContent');

    const html = `
        <div class="card-header mb-2">
            <h2 class="card-title">Team Resources</h2>
            <button class="btn btn-primary" onclick="showAddResourceForm()">+ Add Resource</button>
        </div>

        <div class="search-filter-bar">
            <input type="text" class="form-input search-input" placeholder="Search resources..." id="resourceSearch" oninput="filterResources()">
            <select class="form-select" id="resourceFilterLocation" onchange="filterResources()">
                <option value="">All Locations</option>
                ${[...new Set(resources.map(r => r.location))].map(loc => `<option value="${loc}">${loc}</option>`).join('')}
            </select>
        </div>

        <div id="resourcesList">
            ${renderResourcesList()}
        </div>
    `;

    content.innerHTML = html;
}

function renderResourcesList(filteredResources = null) {
    const resourcesToRender = filteredResources || resources;

    if (resourcesToRender.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <div class="empty-state-title">No ${filteredResources ? 'Matching ' : ''}Resources${filteredResources ? ' Found' : ' Yet'}</div>
            <div class="empty-state-description">${filteredResources ? 'Try adjusting your search or filter criteria.' : 'Add your first team member to start creating training plans.'}</div>
            ${!filteredResources ? '<button class="btn btn-primary" onclick="showAddResourceForm()">+ Add Resource</button>' : ''}
        </div>`;
    }

    // Sort resources alphabetically by name
    const sortedResources = [...resourcesToRender].sort((a, b) =>
        a.name.localeCompare(b.name, undefined, { sensitivity: 'base' })
    );

    let html = '<div class="table-container"><table><thead><tr>';
    html += '<th>Name</th>';
    html += '<th>Job Title</th>';
    html += '<th>Location</th>';
    html += '<th>Department</th>';
    html += '<th>Training Budget</th>';
    html += '<th>Travel Budget</th>';
    html += '<th>Competencies</th>';
    html += '<th>Courses</th>';
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';

    sortedResources.forEach(resource => {
        // Training budget calculation
        const trainingBudgetSpent = resource.budgetSpent || 0;
        const trainingBudgetTotal = resource.annualTrainingBudget || 0;
        const resourcePlans = trainingPlans.filter(p => p.resourceId === resource.id);
        const committedTrainingBudget = resourcePlans.reduce((sum, plan) => sum + (plan.totalCost || 0), 0);
        const totalTrainingUsed = trainingBudgetSpent + committedTrainingBudget;
        const trainingBudgetPercent = trainingBudgetTotal > 0 ? Math.round((totalTrainingUsed / trainingBudgetTotal) * 100) : 0;

        // Travel budget calculation
        const travelBudgetSpent = resource.travelBudgetSpent || 0;
        const travelBudgetTotal = resource.annualTravelBudget || 0;
        const committedTravelBudget = resourcePlans.reduce((sum, plan) => sum + (plan.totalTravelCost || 0), 0);
        const totalTravelUsed = travelBudgetSpent + committedTravelBudget;
        const travelBudgetPercent = travelBudgetTotal > 0 ? Math.round((totalTravelUsed / travelBudgetTotal) * 100) : 0;

        // Budget status colors
        let trainingBudgetColor = '#22c55e';
        if (trainingBudgetPercent >= 100) trainingBudgetColor = '#ef4444';
        else if (trainingBudgetPercent >= 80) trainingBudgetColor = '#f59e0b';

        let travelBudgetColor = '#22c55e';
        if (travelBudgetPercent >= 100) travelBudgetColor = '#ef4444';
        else if (travelBudgetPercent >= 80) travelBudgetColor = '#f59e0b';

        const currentCompetencies = resource.currentCompetencies || [];
        const assignedCourses = resource.assignedCourses || [];

        // In-person capability indicator
        const inPersonBadge = resource.canAttendInPerson !== false
            ? '<span class="badge badge-success" style="font-size: 10px;">‚úì In-Person</span>'
            : '<span class="badge badge-secondary" style="font-size: 10px;">Remote Only</span>';

        html += `
            <tr onclick="viewResourceDetail(${resource.id})" style="cursor: pointer;">
                <td>
                    <div><strong>${escapeHtml(resource.name)}</strong></div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${escapeHtml(resource.email || '')}</div>
                </td>
                <td>${escapeHtml(resource.jobTitle || '‚Äî')}</td>
                <td>
                    <div>${escapeHtml(resource.location || '‚Äî')}</div>
                    <div style="margin-top: 4px;">${inPersonBadge}</div>
                </td>
                <td>${escapeHtml(resource.department || '‚Äî')}</td>
                <td>
                    <div style="color: ${trainingBudgetColor};">
                        <strong>${formatCurrency(totalTrainingUsed)}</strong> / ${formatCurrency(trainingBudgetTotal)}
                    </div>
                    <div class="progress-bar" style="margin-top: 4px; height: 6px;">
                        <div class="progress-fill" style="width: ${Math.min(trainingBudgetPercent, 100)}%; background-color: ${trainingBudgetColor};"></div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">${trainingBudgetPercent}% utilized</div>
                </td>
                <td>
                    <div style="color: ${travelBudgetColor};">
                        <strong>${formatCurrency(totalTravelUsed)}</strong> / ${formatCurrency(travelBudgetTotal)}
                    </div>
                    <div class="progress-bar" style="margin-top: 4px; height: 6px;">
                        <div class="progress-fill" style="width: ${Math.min(travelBudgetPercent, 100)}%; background-color: ${travelBudgetColor};"></div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">${travelBudgetPercent}% utilized</div>
                </td>
                <td style="text-align: center;">
                    <strong>${currentCompetencies.length}</strong>
                </td>
                <td style="text-align: center;">
                    <strong>${assignedCourses.length}</strong>
                </td>
                <td>
                    <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); editResource(${resource.id})" style="padding: 4px 8px; font-size: 12px;">Edit</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function filterResources() {
    const search = document.getElementById('resourceSearch').value.toLowerCase();
    const location = document.getElementById('resourceFilterLocation').value;

    let filtered = resources;

    if (search) {
        filtered = filtered.filter(r =>
            r.name.toLowerCase().includes(search) ||
            (r.jobTitle && r.jobTitle.toLowerCase().includes(search)) ||
            (r.email && r.email.toLowerCase().includes(search)) ||
            (r.department && r.department.toLowerCase().includes(search)) ||
            (r.location && r.location.toLowerCase().includes(search))
        );
    }

    if (location) {
        filtered = filtered.filter(r => r.location === location);
    }

    // Update just the list portion without re-rendering the entire tab
    const listContainer = document.getElementById('resourcesList');
    if (listContainer) {
        listContainer.innerHTML = renderResourcesList(filtered);
    }
}

function showAddResourceForm() {
    // Build calendar checkbox options
    let calendarOptions = '';
    if (regionalCalendars.length === 0) {
        calendarOptions = '<div style="color: var(--text-muted); font-style: italic;">No calendars available. Create calendars in the Calendars tab.</div>';
    } else {
        regionalCalendars.forEach(cal => {
            const isDefault = settings.defaultRegionalCalendar === cal.id;
            calendarOptions += `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="newResourceCalendar_${cal.id}" value="${cal.id}" ${isDefault ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="newResourceCalendar_${cal.id}" style="cursor: pointer; margin: 0; flex: 1;">${escapeHtml(cal.name)} (${escapeHtml(cal.region)} ${cal.year})</label>
                </div>
            `;
        });
    }

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Name</label>
            <input type="text" class="form-input" id="newResourceName" placeholder="John Smith">
        </div>

        <div class="form-group">
            <label class="form-label">Job Title</label>
            <input type="text" class="form-input" id="newResourceTitle" placeholder="Senior Developer">
        </div>

        <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" class="form-input" id="newResourceDepartment" placeholder="Engineering">
        </div>

        <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-input" id="newResourceLocation" placeholder="New York, USA">
        </div>

        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="newResourceEmail" placeholder="john@company.com">
        </div>

        <div class="form-group">
            <label class="form-label">Calendars (Regional & Corporate)</label>
            <div style="border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 12px; max-height: 200px; overflow-y: auto; background: var(--bg-card);">
                ${calendarOptions}
            </div>
            <div class="form-help">Select all calendars that apply (regional holidays, corporate events, etc.). Holidays will aggregate to reduce available training days.</div>
        </div>

        <div class="form-group">
            <label class="form-label">Can Attend In-Person Classes</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <input type="checkbox" id="newResourceCanAttendInPerson" checked style="width: 20px; height: 20px; cursor: pointer;">
                <label for="newResourceCanAttendInPerson" style="cursor: pointer; margin: 0;">This resource can attend in-person training events</label>
            </div>
            <div class="form-help">Uncheck if this resource is remote-only or unable to travel for training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Annual Training Budget</label>
            <input type="number" class="form-input" id="newResourceBudget" value="${settings.defaultBudget}" min="0">
            <div class="form-help">Budget for online courses, certifications, and self-paced training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Annual Travel & Expense Budget</label>
            <input type="number" class="form-input" id="newResourceTravelBudget" value="0" min="0">
            <div class="form-help">Separate budget for travel, accommodation, and meals for in-person training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Weekly Training Hours</label>
            <input type="number" class="form-input" id="newResourceHours" value="${settings.defaultWeeklyHours}" min="1" max="40">
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewResource()">Add Resource</button>
    `;

    openModal('Add New Resource', html, footer);
}

function saveNewResource() {
    const name = document.getElementById('newResourceName').value.trim();
    if (!name) {
        alert('Please enter a name');
        return;
    }

    // Collect all selected calendars
    const selectedCalendarIds = [];
    regionalCalendars.forEach(cal => {
        const checkbox = document.getElementById(`newResourceCalendar_${cal.id}`);
        if (checkbox && checkbox.checked) {
            selectedCalendarIds.push(cal.id);
        }
    });

    const newResource = {
        id: nextResourceId++,
        name: name,
        email: document.getElementById('newResourceEmail').value.trim(),
        jobTitle: document.getElementById('newResourceTitle').value.trim(),
        department: document.getElementById('newResourceDepartment').value.trim(),
        location: document.getElementById('newResourceLocation').value.trim(),
        hireDate: new Date().toISOString().split('T')[0],
        canAttendInPerson: document.getElementById('newResourceCanAttendInPerson').checked,
        annualTrainingBudget: parseFloat(document.getElementById('newResourceBudget').value) || 0,
        budgetSpent: 0,
        annualTravelBudget: parseFloat(document.getElementById('newResourceTravelBudget').value) || 0,
        travelBudgetSpent: 0,
        budgetYear: new Date().getFullYear(),
        currentCompetencies: [],
        desiredCompetencies: [],
        weeklyTrainingHours: parseInt(document.getElementById('newResourceHours').value) || 5,
        preferredTrainingDays: [],
        learningPace: settings.defaultLearningPace,
        formatPreference: 'Online',
        regionalCalendarIds: selectedCalendarIds,
        personalTimeOff: [],
        blackoutPeriods: [],
        assignedCourses: [],
        notes: '',
        tags: [],
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        createdBy: 'Manager'
    };

    resources.push(newResource);
    closeModal();
    triggerSave();
    renderResources();
    renderDashboard();
}

function viewResourceDetail(resourceId) {
    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    // Migrate old single calendar ID to array format if needed
    if (resource.regionalCalendarId !== undefined && !resource.regionalCalendarIds) {
        resource.regionalCalendarIds = resource.regionalCalendarId ? [resource.regionalCalendarId] : [];
        delete resource.regionalCalendarId;
        triggerSave();
    }

    // Ensure regionalCalendarIds exists as an array
    if (!resource.regionalCalendarIds) {
        resource.regionalCalendarIds = [];
    }

    // Get calendar names
    let calendarInfo = '<span style="color: #999;">No Calendars Assigned</span>';
    if (resource.regionalCalendarIds && resource.regionalCalendarIds.length > 0) {
        const calendarLinks = resource.regionalCalendarIds.map(calId => {
            const calendar = regionalCalendars.find(c => c.id === calId);
            if (calendar) {
                return `<a href="#" onclick="event.preventDefault(); closeModal(); switchTab(6); setTimeout(() => viewCalendarDetail(${calendar.id}), 100);" style="color: #044d4b; text-decoration: underline;">${escapeHtml(calendar.name)} (${escapeHtml(calendar.region)} ${calendar.year})</a>`;
            }
            return null;
        }).filter(link => link !== null);

        if (calendarLinks.length > 0) {
            calendarInfo = calendarLinks.join('<br>');
        } else {
            calendarInfo = '<span style="color: #999;">Calendars Not Found</span>';
        }
    }

    // Get resource's training plans
    const resourcePlans = trainingPlans.filter(p => p.resourceId === resourceId);

    // Calculate training budget status
    const totalTrainingBudget = resource.annualTrainingBudget || 0;
    const spentTrainingBudget = resource.budgetSpent || 0;
    const committedTrainingBudget = resourcePlans.reduce((sum, plan) => sum + (plan.totalCost || 0), 0);
    const totalTrainingUsed = spentTrainingBudget + committedTrainingBudget;
    const remainingTrainingBudget = totalTrainingBudget - totalTrainingUsed;
    const trainingBudgetUtilization = totalTrainingBudget > 0 ? (totalTrainingUsed / totalTrainingBudget) * 100 : 0;

    let trainingBudgetStatusColor = '#22c55e'; // Green
    let trainingBudgetStatusText = 'Within Budget';
    let trainingBudgetStatusIcon = '‚úì';

    if (trainingBudgetUtilization >= 100) {
        trainingBudgetStatusColor = '#ef4444'; // Red
        trainingBudgetStatusText = 'Over Budget';
        trainingBudgetStatusIcon = '‚ö†Ô∏è';
    } else if (trainingBudgetUtilization >= 80) {
        trainingBudgetStatusColor = '#f59e0b'; // Orange
        trainingBudgetStatusText = 'Near Limit';
        trainingBudgetStatusIcon = '‚ö†Ô∏è';
    }

    // Calculate travel budget status
    const totalTravelBudget = resource.annualTravelBudget || 0;
    const spentTravelBudget = resource.travelBudgetSpent || 0;
    const committedTravelBudget = resourcePlans.reduce((sum, plan) => sum + (plan.totalTravelCost || 0), 0);
    const totalTravelUsed = spentTravelBudget + committedTravelBudget;
    const remainingTravelBudget = totalTravelBudget - totalTravelUsed;
    const travelBudgetUtilization = totalTravelBudget > 0 ? (totalTravelUsed / totalTravelBudget) * 100 : 0;

    let travelBudgetStatusColor = '#22c55e'; // Green
    let travelBudgetStatusText = 'Within Budget';
    let travelBudgetStatusIcon = '‚úì';

    if (travelBudgetUtilization >= 100) {
        travelBudgetStatusColor = '#ef4444'; // Red
        travelBudgetStatusText = 'Over Budget';
        travelBudgetStatusIcon = '‚ö†Ô∏è';
    } else if (travelBudgetUtilization >= 80) {
        travelBudgetStatusColor = '#f59e0b'; // Orange
        travelBudgetStatusText = 'Near Limit';
        travelBudgetStatusIcon = '‚ö†Ô∏è';
    }

    // Build current competencies display
    let currentCompetenciesHtml = '';
    if (resource.currentCompetencies && resource.currentCompetencies.length > 0) {
        currentCompetenciesHtml = '<div class="table-container" style="margin-top: 12px;"><table><thead><tr><th>Competency</th><th>Category</th><th>Current Level</th><th style="width: 60px;">Actions</th></tr></thead><tbody>';
        resource.currentCompetencies.forEach(comp => {
            const competency = competencyLibrary.find(c => c.id === comp.competencyId);
            if (competency) {
                const levelName = getLevelName(comp.level);
                let levelIndicator = '<div class="level-indicator">';
                for (let i = 1; i <= 5; i++) {
                    levelIndicator += `<div class="level-box ${i <= comp.level ? 'filled' : ''}"></div>`;
                }
                levelIndicator += '</div>';

                currentCompetenciesHtml += `
                    <tr>
                        <td><strong>${escapeHtml(competency.name)}</strong></td>
                        <td>${escapeHtml(competency.category)}</td>
                        <td>${levelIndicator} <span style="font-size: 12px; color: var(--text-muted);">${levelName}</span></td>
                        <td><button class="btn btn-sm btn-ghost" onclick="removeResourceCompetency(${resourceId}, ${comp.competencyId}, 'current')" title="Remove">‚úï</button></td>
                    </tr>
                `;
            }
        });
        currentCompetenciesHtml += '</tbody></table></div>';
    } else {
        currentCompetenciesHtml = '<p style="color: var(--text-muted); font-style: italic; margin-top: 12px;">No current competencies assigned</p>';
    }

    // Build desired competencies display
    let desiredCompetenciesHtml = '';
    if (resource.desiredCompetencies && resource.desiredCompetencies.length > 0) {
        desiredCompetenciesHtml = '<div class="table-container" style="margin-top: 12px;"><table><thead><tr><th>Competency</th><th>Category</th><th>Current</th><th>Target Level</th><th style="width: 60px;">Actions</th></tr></thead><tbody>';
        resource.desiredCompetencies.forEach(comp => {
            const competency = competencyLibrary.find(c => c.id === comp.competencyId);
            if (competency) {
                const currentComp = resource.currentCompetencies.find(cc => cc.competencyId === comp.competencyId);
                const currentLevel = currentComp ? currentComp.level : 0;
                const targetLevelName = getLevelName(comp.targetLevel);
                const currentLevelName = currentLevel > 0 ? getLevelName(currentLevel) : 'None';

                let targetLevelIndicator = '<div class="level-indicator">';
                for (let i = 1; i <= 5; i++) {
                    targetLevelIndicator += `<div class="level-box ${i <= comp.targetLevel ? 'filled' : ''}"></div>`;
                }
                targetLevelIndicator += '</div>';

                desiredCompetenciesHtml += `
                    <tr>
                        <td><strong>${escapeHtml(competency.name)}</strong></td>
                        <td>${escapeHtml(competency.category)}</td>
                        <td style="font-size: 12px; color: var(--text-muted);">${currentLevelName}</td>
                        <td>${targetLevelIndicator} <span style="font-size: 12px; color: var(--text-muted);">${targetLevelName}</span></td>
                        <td><button class="btn btn-sm btn-ghost" onclick="removeResourceCompetency(${resourceId}, ${comp.competencyId}, 'desired')" title="Remove">‚úï</button></td>
                    </tr>
                `;
            }
        });
        desiredCompetenciesHtml += '</tbody></table></div>';
    } else {
        desiredCompetenciesHtml = '<p style="color: var(--text-muted); font-style: italic; margin-top: 12px;">No desired competencies set</p>';
    }

    // Build training plans display
    let trainingPlansHtml = '';
    if (resourcePlans.length > 0) {
        trainingPlansHtml = '<div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">';
        resourcePlans.forEach(plan => {
            const statusColor = plan.status === 'Approved' ? '#10b981' : plan.status === 'Draft' ? '#f59e0b' : '#6b7280';
            const aiAssisted = plan.aiRecommendations && Object.keys(plan.aiRecommendations).length > 0;

            // Determine if this plan fits within remaining budgets
            const planCost = plan.totalCost || 0;
            const planTravelCost = plan.totalTravelCost || 0;
            const trainingBudgetStatus = planCost > remainingTrainingBudget ? 'over' : 'ok';
            const travelBudgetStatus = planTravelCost > remainingTravelBudget ? 'over' : 'ok';

            let planBudgetBadge = '';
            if (trainingBudgetStatus === 'over' || travelBudgetStatus === 'over') {
                if (trainingBudgetStatus === 'over' && travelBudgetStatus === 'over') {
                    planBudgetBadge = '<span class="badge" style="background: #ef4444; color: white; font-size: 11px;">‚ö†Ô∏è Over Training & Travel Budget</span>';
                } else if (trainingBudgetStatus === 'over') {
                    planBudgetBadge = '<span class="badge" style="background: #ef4444; color: white; font-size: 11px;">‚ö†Ô∏è Over Training Budget</span>';
                } else {
                    planBudgetBadge = '<span class="badge" style="background: #ef4444; color: white; font-size: 11px;">‚ö†Ô∏è Over Travel Budget</span>';
                }
            }

            trainingPlansHtml += `
                <div class="card" style="cursor: pointer; margin: 0;" onclick="closeModal(); switchTab(5); setTimeout(() => viewPlanDetails(${plan.id}), 100);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">${escapeHtml(plan.title)}</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted);">
                                <span>Created: ${formatDate(plan.createdDate)}</span>
                                <span>‚Ä¢</span>
                                <span>${plan.scheduledCourses ? plan.scheduledCourses.length : 0} courses</span>
                                <span>‚Ä¢</span>
                                <span>Budget: ${formatCurrency(plan.totalCost || 0)}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            ${aiAssisted ? '<span class="badge badge-info" style="font-size: 11px;">AI-Assisted</span>' : ''}
                            ${planBudgetBadge}
                            <span class="badge" style="background: ${statusColor}; color: white; font-size: 11px;">${plan.status}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        trainingPlansHtml += '</div>';
    } else {
        trainingPlansHtml = '<p style="color: var(--text-muted); font-style: italic; margin-top: 12px;">No training plans created yet</p>';
    }

    const html = `
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <!-- Profile Section -->
            <div class="card" style="background: var(--neutral-50);">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-color);">Profile</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                    <div><strong>Title:</strong> ${resource.jobTitle || 'N/A'}</div>
                    <div><strong>Department:</strong> ${resource.department || 'N/A'}</div>
                    <div><strong>Location:</strong> ${resource.location || 'N/A'}</div>
                    <div><strong>Email:</strong> ${resource.email || 'N/A'}</div>
                    <div style="grid-column: 1 / -1;"><strong>Regional Calendar:</strong> ${calendarInfo}</div>
                    <div style="grid-column: 1 / -1;"><strong>Can Attend In-Person Classes:</strong> ${resource.canAttendInPerson !== false ? '<span style="color: #22c55e;">‚úì Yes</span>' : '<span style="color: #94a3b8;">‚úó No (Remote Only)</span>'}</div>

                    <!-- Training Budget -->
                    <div style="grid-column: 1 / -1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <strong>Training Budget Status:</strong>
                            <span class="badge" style="background: ${trainingBudgetStatusColor}; color: white; font-size: 12px; padding: 4px 10px;">
                                ${trainingBudgetStatusIcon} ${trainingBudgetStatusText}
                            </span>
                        </div>
                        <div style="font-size: 13px; color: var(--neutral-700);">
                            <div style="margin-bottom: 4px;">Spent: ${formatCurrency(spentTrainingBudget)} | Committed: ${formatCurrency(committedTrainingBudget)} | Remaining: <span style="color: ${remainingTrainingBudget < 0 ? '#ef4444' : '#22c55e'}; font-weight: 600;">${formatCurrency(remainingTrainingBudget)}</span></div>
                            <div style="background: var(--neutral-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${trainingBudgetStatusColor}; height: 100%; width: ${Math.min(trainingBudgetUtilization, 100)}%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="margin-top: 4px; font-size: 12px; color: var(--neutral-600);">
                                Total Training Budget: ${formatCurrency(totalTrainingBudget)} (${trainingBudgetUtilization.toFixed(1)}% utilized)
                            </div>
                        </div>
                    </div>

                    <!-- Travel & Expense Budget -->
                    <div style="grid-column: 1 / -1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <strong>Travel & Expense Budget Status:</strong>
                            <span class="badge" style="background: ${travelBudgetStatusColor}; color: white; font-size: 12px; padding: 4px 10px;">
                                ${travelBudgetStatusIcon} ${travelBudgetStatusText}
                            </span>
                        </div>
                        <div style="font-size: 13px; color: var(--neutral-700);">
                            <div style="margin-bottom: 4px;">Spent: ${formatCurrency(spentTravelBudget)} | Committed: ${formatCurrency(committedTravelBudget)} | Remaining: <span style="color: ${remainingTravelBudget < 0 ? '#ef4444' : '#22c55e'}; font-weight: 600;">${formatCurrency(remainingTravelBudget)}</span></div>
                            <div style="background: var(--neutral-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${travelBudgetStatusColor}; height: 100%; width: ${Math.min(travelBudgetUtilization, 100)}%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="margin-top: 4px; font-size: 12px; color: var(--neutral-600);">
                                Total Travel & Expense Budget: ${formatCurrency(totalTravelBudget)} (${travelBudgetUtilization.toFixed(1)}% utilized)
                            </div>
                        </div>
                    </div>

                    <div><strong>Weekly Training Hours:</strong> ${resource.weeklyTrainingHours || 0}</div>
                </div>
            </div>

            <!-- Current Competencies Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--primary-color);">Current Competencies (${resource.currentCompetencies.length})</h3>
                    <button class="btn btn-sm btn-primary" onclick="manageResourceCompetencies(${resourceId}, 'current')">+ Add Competency</button>
                </div>
                ${currentCompetenciesHtml}
            </div>

            <!-- Desired Competencies Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--primary-color);">Desired Competencies / Goals (${resource.desiredCompetencies.length})</h3>
                    <button class="btn btn-sm btn-primary" onclick="manageResourceCompetencies(${resourceId}, 'desired')">+ Add Goal</button>
                </div>
                ${desiredCompetenciesHtml}
            </div>

            <!-- Training Plans Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--primary-color);">Training Plans (${resourcePlans.length})</h3>
                    <button class="btn btn-sm btn-primary" onclick="closeModal(); switchTab(5); setTimeout(() => startWizard(${resourceId}), 100);">+ Create Plan</button>
                </div>
                ${trainingPlansHtml}
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-secondary" onclick="editResource(${resourceId})">Edit Profile</button>
        <button class="btn btn-error" onclick="deleteResource(${resourceId})">Delete</button>
    `;

    openModal(`Resource: ${resource.name}`, html, footer, 'modal-xlarge');
}

function manageResourceCompetencies(resourceId, type) {
    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    const isCurrentType = type === 'current';
    const title = isCurrentType ? 'Add Current Competency' : 'Add Desired Competency / Goal';
    const description = isCurrentType
        ? 'Select a competency and set the current proficiency level for this resource.'
        : 'Select a competency and set the target proficiency level this resource should achieve.';

    // Get competencies not already added
    const existingIds = isCurrentType
        ? (resource.currentCompetencies || []).map(c => c.competencyId)
        : (resource.desiredCompetencies || []).map(c => c.competencyId);

    const availableCompetencies = competencyLibrary.filter(c => !existingIds.includes(c.id));

    if (availableCompetencies.length === 0) {
        alert('All available competencies have been assigned to this resource.');
        return;
    }

    // Build competency options grouped by category
    const categories = {};
    availableCompetencies.forEach(comp => {
        if (!categories[comp.category]) {
            categories[comp.category] = [];
        }
        categories[comp.category].push(comp);
    });

    let competencyOptions = '<option value="">-- Select Competency --</option>';
    Object.keys(categories).sort().forEach(category => {
        competencyOptions += `<optgroup label="${escapeHtml(category)}">`;
        categories[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(comp => {
            competencyOptions += `<option value="${comp.id}">${escapeHtml(comp.name)}${comp.subcategory ? ' (' + escapeHtml(comp.subcategory) + ')' : ''}</option>`;
        });
        competencyOptions += '</optgroup>';
    });

    const html = `
        <div>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">${description}</p>

            <div class="form-group">
                <label class="form-label form-label-required">Competency</label>
                <select class="form-input" id="selectedCompetency" onchange="updateCompetencyLevelHelp()">
                    ${competencyOptions}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label form-label-required">${isCurrentType ? 'Current' : 'Target'} Proficiency Level</label>
                <select class="form-input" id="selectedLevel">
                    <option value="">-- Select Level --</option>
                    <option value="1">1 - Awareness</option>
                    <option value="2">2 - Beginner</option>
                    <option value="3">3 - Intermediate</option>
                    <option value="4">4 - Advanced</option>
                    <option value="5">5 - Expert</option>
                </select>
            </div>

            <div id="levelHelp" style="background: var(--neutral-50); padding: 12px; border-radius: var(--radius-md); margin-top: 12px; display: none;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600;">Level Definitions</h4>
                <div id="levelDefinitions" style="font-size: 12px; color: var(--text-secondary);"></div>
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveResourceCompetency(${resourceId}, '${type}')">Add Competency</button>
    `;

    openModal(title, html, footer);

    // Add script to show level definitions when competency is selected
    window.updateCompetencyLevelHelp = function() {
        const selectedId = parseInt(document.getElementById('selectedCompetency').value);
        const helpDiv = document.getElementById('levelHelp');
        const defsDiv = document.getElementById('levelDefinitions');

        if (selectedId) {
            const competency = competencyLibrary.find(c => c.id === selectedId);
            if (competency && competency.levelDefinitions) {
                let html = '';
                for (let level = 1; level <= 5; level++) {
                    const def = competency.levelDefinitions[level];
                    if (def) {
                        html += `<div style="margin-bottom: 6px;"><strong>Level ${level} (${def.name}):</strong> ${def.description}</div>`;
                    }
                }
                defsDiv.innerHTML = html;
                helpDiv.style.display = 'block';
            }
        } else {
            helpDiv.style.display = 'none';
        }
    };
}

function saveResourceCompetency(resourceId, type) {
    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    const competencyId = parseInt(document.getElementById('selectedCompetency').value);
    const level = parseInt(document.getElementById('selectedLevel').value);

    if (!competencyId) {
        alert('Please select a competency');
        return;
    }

    if (!level || level < 1 || level > 5) {
        alert('Please select a proficiency level');
        return;
    }

    const isCurrentType = type === 'current';
    const targetArray = isCurrentType ? 'currentCompetencies' : 'desiredCompetencies';

    // Initialize array if it doesn't exist
    if (!resource[targetArray]) {
        resource[targetArray] = [];
    }

    // Check if already exists
    const existing = resource[targetArray].find(c => c.competencyId === competencyId);
    if (existing) {
        alert('This competency is already assigned to this resource');
        return;
    }

    // Add the competency
    if (isCurrentType) {
        resource.currentCompetencies.push({
            competencyId: competencyId,
            level: level,
            assessedDate: new Date().toISOString(),
            assessedBy: 'Manager'
        });
    } else {
        resource.desiredCompetencies.push({
            competencyId: competencyId,
            targetLevel: level,
            priority: 'Medium',
            deadline: null,
            setDate: new Date().toISOString()
        });
    }

    resource.lastModified = new Date().toISOString();

    closeModal();
    triggerSave();

    // Reopen the resource detail view
    setTimeout(() => viewResourceDetail(resourceId), 100);
}

function removeResourceCompetency(resourceId, competencyId, type) {
    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    const competency = competencyLibrary.find(c => c.id === competencyId);
    if (!competency) return;

    if (settings.confirmBeforeDelete) {
        if (!confirm(`Remove "${competency.name}" from ${type === 'current' ? 'current competencies' : 'desired competencies'}?`)) {
            return;
        }
    }

    const targetArray = type === 'current' ? 'currentCompetencies' : 'desiredCompetencies';

    if (!resource[targetArray]) {
        resource[targetArray] = [];
    }

    const index = resource[targetArray].findIndex(c => c.competencyId === competencyId);
    if (index > -1) {
        resource[targetArray].splice(index, 1);
        resource.lastModified = new Date().toISOString();

        triggerSave();

        // Reopen the resource detail view
        viewResourceDetail(resourceId);
    }
}

function deleteResource(resourceId) {
    if (settings.confirmBeforeDelete) {
        if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
            return;
        }
    }

    const index = resources.findIndex(r => r.id === resourceId);
    if (index > -1) {
        resources.splice(index, 1);
        closeModal();
        triggerSave();
        renderResources();
        renderDashboard();
    }
}

function editResource(resourceId) {
    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    // Migrate old single calendar ID to array format if needed
    if (resource.regionalCalendarId !== undefined && !resource.regionalCalendarIds) {
        resource.regionalCalendarIds = resource.regionalCalendarId ? [resource.regionalCalendarId] : [];
        delete resource.regionalCalendarId;
    }

    // Ensure regionalCalendarIds exists as an array
    if (!resource.regionalCalendarIds) {
        resource.regionalCalendarIds = [];
    }

    // Build calendar checkbox options
    let calendarOptions = '';
    if (regionalCalendars.length === 0) {
        calendarOptions = '<div style="color: var(--text-muted); font-style: italic;">No calendars available. Create calendars in the Calendars tab.</div>';
    } else {
        regionalCalendars.forEach(cal => {
            const isSelected = resource.regionalCalendarIds.includes(cal.id);
            calendarOptions += `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="editResourceCalendar_${cal.id}" value="${cal.id}" ${isSelected ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="editResourceCalendar_${cal.id}" style="cursor: pointer; margin: 0; flex: 1;">${escapeHtml(cal.name)} (${escapeHtml(cal.region)} ${cal.year})</label>
                </div>
            `;
        });
    }

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Name</label>
            <input type="text" class="form-input" id="editResourceName" value="${escapeHtml(resource.name)}" placeholder="John Smith">
        </div>

        <div class="form-group">
            <label class="form-label">Job Title</label>
            <input type="text" class="form-input" id="editResourceTitle" value="${escapeHtml(resource.jobTitle || '')}" placeholder="Senior Developer">
        </div>

        <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" class="form-input" id="editResourceDepartment" value="${escapeHtml(resource.department || '')}" placeholder="Engineering">
        </div>

        <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-input" id="editResourceLocation" value="${escapeHtml(resource.location || '')}" placeholder="New York, USA">
        </div>

        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="editResourceEmail" value="${escapeHtml(resource.email || '')}" placeholder="john@company.com">
        </div>

        <div class="form-group">
            <label class="form-label">Calendars (Regional & Corporate)</label>
            <div style="border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 12px; max-height: 200px; overflow-y: auto; background: var(--bg-card);">
                ${calendarOptions}
            </div>
            <div class="form-help">Select all calendars that apply (regional holidays, corporate events, etc.). Holidays will aggregate to reduce available training days.</div>
        </div>

        <div class="form-group">
            <label class="form-label">Can Attend In-Person Classes</label>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <input type="checkbox" id="editResourceCanAttendInPerson" ${resource.canAttendInPerson !== false ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                <label for="editResourceCanAttendInPerson" style="cursor: pointer; margin: 0;">This resource can attend in-person training events</label>
            </div>
            <div class="form-help">Uncheck if this resource is remote-only or unable to travel for training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Annual Training Budget</label>
            <input type="number" class="form-input" id="editResourceBudget" value="${resource.annualTrainingBudget || 0}" min="0">
            <div class="form-help">Budget for online courses, certifications, and self-paced training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Training Budget Spent</label>
            <input type="number" class="form-input" id="editResourceBudgetSpent" value="${resource.budgetSpent || 0}" min="0">
            <div class="form-help">Track actual spending on training for this resource</div>
        </div>

        <div class="form-group">
            <label class="form-label">Annual Travel & Expense Budget</label>
            <input type="number" class="form-input" id="editResourceTravelBudget" value="${resource.annualTravelBudget || 0}" min="0">
            <div class="form-help">Separate budget for travel, accommodation, and meals for in-person training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Travel & Expense Budget Spent</label>
            <input type="number" class="form-input" id="editResourceTravelBudgetSpent" value="${resource.travelBudgetSpent || 0}" min="0">
            <div class="form-help">Track actual spending on travel and expenses for in-person training</div>
        </div>

        <div class="form-group">
            <label class="form-label">Weekly Training Hours</label>
            <input type="number" class="form-input" id="editResourceHours" value="${resource.weeklyTrainingHours || 5}" min="1" max="40">
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveResourceEdits(${resourceId})">Save Changes</button>
    `;

    openModal('Edit Resource: ' + resource.name, html, footer);
}

function saveResourceEdits(resourceId) {
    const name = document.getElementById('editResourceName').value.trim();
    if (!name) {
        alert('Please enter a name');
        return;
    }

    const resource = resources.find(r => r.id === resourceId);
    if (!resource) return;

    // Collect all selected calendars
    const selectedCalendarIds = [];
    regionalCalendars.forEach(cal => {
        const checkbox = document.getElementById(`editResourceCalendar_${cal.id}`);
        if (checkbox && checkbox.checked) {
            selectedCalendarIds.push(cal.id);
        }
    });

    // Update resource fields
    resource.name = name;
    resource.email = document.getElementById('editResourceEmail').value.trim();
    resource.jobTitle = document.getElementById('editResourceTitle').value.trim();
    resource.department = document.getElementById('editResourceDepartment').value.trim();
    resource.location = document.getElementById('editResourceLocation').value.trim();
    resource.regionalCalendarIds = selectedCalendarIds;
    // Remove old single calendar ID if it exists
    delete resource.regionalCalendarId;
    resource.canAttendInPerson = document.getElementById('editResourceCanAttendInPerson').checked;
    resource.annualTrainingBudget = parseFloat(document.getElementById('editResourceBudget').value) || 0;
    resource.budgetSpent = parseFloat(document.getElementById('editResourceBudgetSpent').value) || 0;
    resource.annualTravelBudget = parseFloat(document.getElementById('editResourceTravelBudget').value) || 0;
    resource.travelBudgetSpent = parseFloat(document.getElementById('editResourceTravelBudgetSpent').value) || 0;
    resource.weeklyTrainingHours = parseInt(document.getElementById('editResourceHours').value) || 5;
    resource.lastModified = new Date().toISOString();

    closeModal();
    triggerSave();
    renderResources();
    renderDashboard();
}

// === COMPETENCY LIBRARY (TAB 3) ===
function renderCompetencies() {
    const content = document.getElementById('competenciesContent');

    const html = `
        <div class="card-header mb-2">
            <h2 class="card-title">Competency Library</h2>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost" onclick="showManageCategories()">Manage Categories</button>
                <button class="btn btn-primary" onclick="showAddCompetencyForm()">+ Add Competency</button>
            </div>
        </div>

        <div class="search-filter-bar">
            <input type="text" class="form-input search-input" placeholder="Search competencies..." id="compSearch" oninput="filterCompetencies()">
            <select class="form-select" id="compFilterCategory" onchange="filterCompetencies()">
                <option value="">All Categories</option>
                ${[...new Set(competencyLibrary.map(c => c.category))].map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
        </div>

        <div id="competenciesList">
            ${renderCompetenciesList()}
        </div>
    `;

    content.innerHTML = html;
}

function filterCompetencies() {
    const search = document.getElementById('compSearch')?.value.toLowerCase() || '';
    const category = document.getElementById('compFilterCategory')?.value || '';

    let filtered = competencyLibrary;

    if (search) {
        filtered = filtered.filter(comp =>
            comp.name.toLowerCase().includes(search) ||
            (comp.category && comp.category.toLowerCase().includes(search)) ||
            (comp.subcategory && comp.subcategory.toLowerCase().includes(search)) ||
            (comp.description && comp.description.toLowerCase().includes(search))
        );
    }

    if (category) {
        filtered = filtered.filter(comp => comp.category === category);
    }

    // Update just the list portion
    const listContainer = document.getElementById('competenciesList');
    if (listContainer) {
        listContainer.innerHTML = renderCompetenciesList(filtered);
    }
}

function renderCompetenciesList(filteredCompetencies = null) {
    const competenciesToRender = filteredCompetencies || competencyLibrary;

    if (competenciesToRender.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <div class="empty-state-title">No ${filteredCompetencies ? 'Matching ' : ''}Competencies${filteredCompetencies ? ' Found' : ' Yet'}</div>
            <div class="empty-state-description">${filteredCompetencies ? 'Try adjusting your search or filter criteria.' : 'Build your competency library to track skills and expertise.'}</div>
            ${!filteredCompetencies ? '<button class="btn btn-primary" onclick="showAddCompetencyForm()">+ Add Competency</button>' : ''}
        </div>`;
    }

    // Helper function to get sort indicator
    const getSortIndicator = (column) => {
        if (competenciesSortColumn === column) {
            return competenciesSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
        return '';
    };

    // Prepare competency data with computed values for sorting
    const competencyData = competenciesToRender.map(comp => ({
        comp,
        useCount: getCompetencyUsage(comp.id)
    }));

    // Sort competencies based on current sort state
    if (competenciesSortColumn) {
        competencyData.sort((a, b) => {
            let aVal, bVal;

            switch (competenciesSortColumn) {
                case 'name':
                    aVal = a.comp.name.toLowerCase();
                    bVal = b.comp.name.toLowerCase();
                    break;
                case 'category':
                    aVal = (a.comp.category || 'Uncategorized').toLowerCase();
                    bVal = (b.comp.category || 'Uncategorized').toLowerCase();
                    break;
                case 'subcategory':
                    aVal = (a.comp.subcategory || '').toLowerCase();
                    bVal = (b.comp.subcategory || '').toLowerCase();
                    break;
                case 'usage':
                    aVal = a.useCount;
                    bVal = b.useCount;
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return competenciesSortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return competenciesSortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    let html = '<div class="table-container"><table><thead><tr>';
    html += `<th onclick="sortCompetenciesTable('name')" style="cursor: pointer; user-select: none;">Competency${getSortIndicator('name')}</th>`;
    html += `<th onclick="sortCompetenciesTable('category')" style="cursor: pointer; user-select: none;">Category${getSortIndicator('category')}</th>`;
    html += `<th onclick="sortCompetenciesTable('subcategory')" style="cursor: pointer; user-select: none;">Subcategory${getSortIndicator('subcategory')}</th>`;
    html += `<th onclick="sortCompetenciesTable('usage')" style="cursor: pointer; user-select: none;">Used By${getSortIndicator('usage')}</th>`;
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';

    competencyData.forEach(({ comp, useCount }) => {
        html += `
            <tr>
                <td><strong>${escapeHtml(comp.name)}</strong></td>
                <td>${escapeHtml(comp.category || 'Uncategorized')}</td>
                <td>${escapeHtml(comp.subcategory || '-')}</td>
                <td>${useCount} resources</td>
                <td class="table-actions">
                    <button class="btn btn-sm btn-ghost" onclick="viewCompetencyDetail(${comp.id})">View</button>
                    <button class="btn btn-sm btn-ghost" onclick="deleteCompetency(${comp.id})">Delete</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function sortCompetenciesTable(column) {
    // If clicking the same column, toggle direction; otherwise, set to ascending
    if (competenciesSortColumn === column) {
        competenciesSortDirection = competenciesSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        competenciesSortColumn = column;
        competenciesSortDirection = 'asc';
    }

    // Re-render the competencies to reflect the new sort
    renderCompetencies();
}

function getCompetencyUsage(competencyId) {
    let count = 0;
    resources.forEach(r => {
        if (r.currentCompetencies && r.currentCompetencies.some(c => c.competencyId === competencyId)) {
            count++;
        }
        if (r.desiredCompetencies && r.desiredCompetencies.some(c => c.competencyId === competencyId)) {
            count++;
        }
    });
    return count;
}

// Helper function to extract unique categories from competencyLibrary
function getUniqueCategories() {
    const categories = new Set();
    competencyLibrary.forEach(comp => {
        if (comp.category && comp.category.trim() !== '') {
            categories.add(comp.category.trim());
        }
    });
    return Array.from(categories).sort();
}

// Helper function to extract subcategories for a given category
function getSubcategoriesForCategory(category) {
    const subcategories = new Set();
    competencyLibrary.forEach(comp => {
        if (comp.category === category && comp.subcategory && comp.subcategory.trim() !== '') {
            subcategories.add(comp.subcategory.trim());
        }
    });
    return Array.from(subcategories).sort();
}

// Handle category change to update subcategory dropdown
function handleCategoryChange() {
    const categorySelect = document.getElementById('newCompCategory');
    const subcategorySelect = document.getElementById('newCompSubcategory');
    const customCategoryInput = document.getElementById('customCategoryInput');
    const customSubcategoryInput = document.getElementById('customSubcategoryInput');

    const selectedCategory = categorySelect.value;

    // Show/hide custom category input
    if (selectedCategory === '__custom__') {
        customCategoryInput.style.display = 'block';
        subcategorySelect.innerHTML = '<option value="">Select subcategory...</option><option value="__custom__">+ Add New Subcategory</option>';
        subcategorySelect.disabled = false;
    } else {
        customCategoryInput.style.display = 'none';

        // Populate subcategories for selected category
        const subcategories = getSubcategoriesForCategory(selectedCategory);
        subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
        subcategories.forEach(subcat => {
            subcategorySelect.innerHTML += `<option value="${escapeHtml(subcat)}">${escapeHtml(subcat)}</option>`;
        });
        subcategorySelect.innerHTML += '<option value="__custom__">+ Add New Subcategory</option>';
        subcategorySelect.disabled = false;
    }

    // Reset custom subcategory input
    customSubcategoryInput.style.display = 'none';
}

// Handle subcategory change to show/hide custom input
function handleSubcategoryChange() {
    const subcategorySelect = document.getElementById('newCompSubcategory');
    const customSubcategoryInput = document.getElementById('customSubcategoryInput');

    if (subcategorySelect.value === '__custom__') {
        customSubcategoryInput.style.display = 'block';
    } else {
        customSubcategoryInput.style.display = 'none';
    }
}

function showAddCompetencyForm() {
    const categories = getUniqueCategories();

    let categoryOptions = '<option value="">Select category...</option>';
    categories.forEach(cat => {
        categoryOptions += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
    });
    categoryOptions += '<option value="__custom__">+ Add New Category</option>';

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Name</label>
            <input type="text" class="form-input" id="newCompName" placeholder="Python Programming">
        </div>

        <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-input" id="newCompCategory" onchange="handleCategoryChange()">
                ${categoryOptions}
            </select>
            <input type="text" class="form-input" id="customCategoryInput" placeholder="Enter new category..." style="display: none; margin-top: 8px;">
        </div>

        <div class="form-group">
            <label class="form-label">Subcategory</label>
            <select class="form-input" id="newCompSubcategory" onchange="handleSubcategoryChange()" disabled>
                <option value="">Select category first...</option>
            </select>
            <input type="text" class="form-input" id="customSubcategoryInput" placeholder="Enter new subcategory..." style="display: none; margin-top: 8px;">
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="newCompDescription" placeholder="What this competency encompasses..."></textarea>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewCompetency()">Add Competency</button>
    `;

    openModal('Add New Competency', html, footer);
}

function saveNewCompetency() {
    const name = document.getElementById('newCompName').value.trim();
    if (!name) {
        alert('Please enter a name');
        return;
    }

    // Determine category value (dropdown or custom input)
    let category = document.getElementById('newCompCategory').value.trim();
    if (category === '__custom__') {
        category = document.getElementById('customCategoryInput').value.trim();
        if (!category) {
            alert('Please enter a category name or select an existing one');
            return;
        }
    } else if (!category) {
        category = 'Uncategorized';
    }

    // Determine subcategory value (dropdown or custom input)
    let subcategory = document.getElementById('newCompSubcategory').value.trim();
    if (subcategory === '__custom__') {
        subcategory = document.getElementById('customSubcategoryInput').value.trim();
        if (!subcategory) {
            alert('Please enter a subcategory name');
            return;
        }
    }
    // Subcategory is optional, so empty string is acceptable

    const newComp = {
        id: nextCompetencyId++,
        name: name,
        category: category,
        subcategory: subcategory,
        description: document.getElementById('newCompDescription').value.trim(),
        levelDefinitions: {
            1: { name: 'Awareness', description: 'Basic understanding. Can follow documentation with guidance.' },
            2: { name: 'Beginner', description: 'Can perform basic tasks independently. Needs help with complex scenarios.' },
            3: { name: 'Intermediate', description: 'Handles most tasks independently. Good working knowledge.' },
            4: { name: 'Advanced', description: 'Expert-level skills. Handles complex scenarios confidently.' },
            5: { name: 'Expert', description: 'Industry-recognized expertise. Thought leader. Drives innovation.' }
        },
        frameworkMappings: {},
        relatedCompetencies: [],
        prerequisites: [],
        useCount: 0,
        lastUsed: new Date().toISOString(),
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        createdBy: 'Manager',
        isActive: true
    };

    competencyLibrary.push(newComp);
    closeModal();
    triggerSave();
    renderCompetencies();
}

function viewCompetencyDetail(competencyId) {
    const comp = competencyLibrary.find(c => c.id === competencyId);
    if (!comp) return;

    const usage = getCompetencyUsage(comp.id);

    const html = `
        <div>
            <h3>${comp.name}</h3>
            <p><strong>Category:</strong> ${comp.category}</p>
            <p><strong>Subcategory:</strong> ${comp.subcategory || 'N/A'}</p>
            <p><strong>Description:</strong> ${comp.description || 'No description'}</p>
            <p><strong>Used by:</strong> ${usage} resources</p>

            <h4 style="margin-top: 20px;">Proficiency Levels</h4>
            <div style="margin-left: 20px;">
                ${Object.keys(comp.levelDefinitions).map(level => `
                    <div style="margin: 10px 0;">
                        <strong>${level}. ${comp.levelDefinitions[level].name}:</strong>
                        ${comp.levelDefinitions[level].description}
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-error" onclick="deleteCompetency(${competencyId})">Delete</button>
    `;

    openModal(`Competency: ${comp.name}`, html, footer);
}

function deleteCompetency(competencyId) {
    const usage = getCompetencyUsage(competencyId);
    if (usage > 0 && settings.confirmBeforeDelete) {
        if (!confirm(`This competency is used by ${usage} resources. Deleting it will remove it from all resources. Continue?`)) {
            return;
        }
    }

    // Remove from all resources
    resources.forEach(r => {
        if (r.currentCompetencies) {
            r.currentCompetencies = r.currentCompetencies.filter(c => c.competencyId !== competencyId);
        }
        if (r.desiredCompetencies) {
            r.desiredCompetencies = r.desiredCompetencies.filter(c => c.competencyId !== competencyId);
        }
    });

    // Remove from library
    const index = competencyLibrary.findIndex(c => c.id === competencyId);
    if (index > -1) {
        competencyLibrary.splice(index, 1);
    }

    closeModal();
    triggerSave();
    renderCompetencies();
}

// === CATEGORY MANAGEMENT ===
function showManageCategories() {
    const categories = getUniqueCategories();
    const categoriesWithSubcats = {};

    // Build category hierarchy
    categories.forEach(cat => {
        categoriesWithSubcats[cat] = {
            subcategories: getSubcategoriesForCategory(cat),
            competencyCount: competencyLibrary.filter(c => c.category === cat).length
        };
    });

    let html = `
        <div style="margin-bottom: 20px;">
            <h3>Category Management</h3>
            <p style="color: #666; margin-bottom: 20px;">Manage categories and subcategories for your competency library. Categories help organize competencies, and subcategories provide additional classification.</p>

            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button class="btn btn-primary" onclick="showAddCategoryForm()">+ Add Category</button>
                <button class="btn btn-primary" onclick="showAddSubcategoryForm()">+ Add Subcategory</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Subcategories</th>
                        <th>Competencies</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

    if (categories.length === 0) {
        html += `
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                    <div>No categories yet. Categories are automatically created when you add competencies,</div>
                    <div>or you can create them manually using the buttons above.</div>
                </td>
            </tr>`;
    } else {
        categories.forEach(cat => {
            const data = categoriesWithSubcats[cat];
            const subcatsList = data.subcategories.length > 0
                ? data.subcategories.map(s => `<span class="badge badge-secondary">${escapeHtml(s)}</span>`).join(' ')
                : '<span style="color: #999;">None</span>';

            html += `
                <tr>
                    <td><strong>${escapeHtml(cat)}</strong></td>
                    <td>${subcatsList}</td>
                    <td>${data.competencyCount} competenc${data.competencyCount === 1 ? 'y' : 'ies'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-ghost" onclick="viewCategoryDetails('${escapeHtml(cat).replace(/'/g, "\\'")}')">View Details</button>
                        <button class="btn btn-sm btn-ghost" onclick="editCategory('${escapeHtml(cat).replace(/'/g, "\\'")}')">Edit</button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteCategory('${escapeHtml(cat).replace(/'/g, "\\'")}')">Delete</button>
                    </td>
                </tr>`;
        });
    }

    html += `
                </tbody>
            </table>
        </div>

        <div style="margin-top: 24px; padding: 16px; background: #f5f5f5; border-radius: 6px;">
            <h4 style="margin-top: 0;">Category Relationships</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: #666;">
                <li>Each competency must belong to one category</li>
                <li>Subcategories are optional and provide additional classification within a category</li>
                <li>One subcategory can only belong to one category</li>
                <li>Deleting a category will remove it from all associated competencies</li>
                <li>Deleting a subcategory will remove it from all associated competencies</li>
            </ul>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
    `;

    openModal('Manage Categories & Subcategories', html, footer, 'modal-large');
}

function showAddCategoryForm() {
    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Category Name</label>
            <input type="text" class="form-input" id="newCategoryName" placeholder="e.g., Programming Languages, Cloud Platforms, Security">
            <div class="form-help">Choose a clear, descriptive name for this category</div>
        </div>

        <div class="form-group">
            <label class="form-label">Description (Optional)</label>
            <textarea class="form-textarea" id="newCategoryDescription" placeholder="What types of competencies belong in this category?"></textarea>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewCategory()">Add Category</button>
    `;

    openModal('Add New Category', html, footer);
}

function saveNewCategory() {
    const name = document.getElementById('newCategoryName').value.trim();

    if (!name) {
        alert('Please enter a category name');
        return;
    }

    // Check if category already exists
    const existingCategories = getUniqueCategories();
    if (existingCategories.includes(name)) {
        alert('This category already exists');
        return;
    }

    // Category will be available immediately for use
    // It doesn't need to be stored separately - it exists through competencies
    // But we can show a success message
    closeModal();
    alert(`Category "${name}" created. It's now available when adding competencies.`);
    showManageCategories();
}

function showAddSubcategoryForm() {
    const categories = getUniqueCategories();

    if (categories.length === 0) {
        alert('Please create at least one category first');
        return;
    }

    let categoryOptions = '<option value="">Select parent category...</option>';
    categories.forEach(cat => {
        categoryOptions += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
    });

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Parent Category</label>
            <select class="form-input" id="newSubcategoryParent">
                ${categoryOptions}
            </select>
            <div class="form-help">Select the category this subcategory belongs to</div>
        </div>

        <div class="form-group">
            <label class="form-label form-label-required">Subcategory Name</label>
            <input type="text" class="form-input" id="newSubcategoryName" placeholder="e.g., Backend Development, Container Orchestration">
            <div class="form-help">Choose a clear, descriptive name for this subcategory</div>
        </div>

        <div class="form-group">
            <label class="form-label">Description (Optional)</label>
            <textarea class="form-textarea" id="newSubcategoryDescription" placeholder="What types of competencies belong in this subcategory?"></textarea>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewSubcategory()">Add Subcategory</button>
    `;

    openModal('Add New Subcategory', html, footer);
}

function saveNewSubcategory() {
    const parentCategory = document.getElementById('newSubcategoryParent').value.trim();
    const name = document.getElementById('newSubcategoryName').value.trim();

    if (!parentCategory) {
        alert('Please select a parent category');
        return;
    }

    if (!name) {
        alert('Please enter a subcategory name');
        return;
    }

    // Check if subcategory already exists in this category
    const existingSubcats = getSubcategoriesForCategory(parentCategory);
    if (existingSubcats.includes(name)) {
        alert(`Subcategory "${name}" already exists in category "${parentCategory}"`);
        return;
    }

    closeModal();
    alert(`Subcategory "${name}" created under "${parentCategory}". It's now available when adding competencies.`);
    showManageCategories();
}

function editCategory(oldCategoryName) {
    const competenciesInCategory = competencyLibrary.filter(c => c.category === oldCategoryName);

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Category Name</label>
            <input type="text" class="form-input" id="editCategoryName" value="${escapeHtml(oldCategoryName)}">
        </div>

        <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-top: 16px;">
            <strong>Note:</strong> Renaming this category will update ${competenciesInCategory.length} competenc${competenciesInCategory.length === 1 ? 'y' : 'ies'}.
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCategoryEdit('${escapeHtml(oldCategoryName).replace(/'/g, "\\'")}')">Save Changes</button>
    `;

    openModal('Edit Category', html, footer);
}

function saveCategoryEdit(oldCategoryName) {
    const newCategoryName = document.getElementById('editCategoryName').value.trim();

    if (!newCategoryName) {
        alert('Please enter a category name');
        return;
    }

    if (newCategoryName === oldCategoryName) {
        closeModal();
        return;
    }

    // Check if new name already exists
    const existingCategories = getUniqueCategories();
    if (existingCategories.includes(newCategoryName)) {
        alert('A category with this name already exists');
        return;
    }

    // Update all competencies with this category
    competencyLibrary.forEach(comp => {
        if (comp.category === oldCategoryName) {
            comp.category = newCategoryName;
            comp.lastModified = new Date().toISOString();
        }
    });

    closeModal();
    triggerSave();
    renderCompetencies();
    showManageCategories();
}

function deleteCategory(categoryName) {
    const competenciesInCategory = competencyLibrary.filter(c => c.category === categoryName);

    if (competenciesInCategory.length > 0 && settings.confirmBeforeDelete) {
        if (!confirm(`This category is used by ${competenciesInCategory.length} competenc${competenciesInCategory.length === 1 ? 'y' : 'ies'}. Deleting it will set those competencies to "Uncategorized". Continue?`)) {
            return;
        }
    }

    // Set all competencies in this category to "Uncategorized"
    competencyLibrary.forEach(comp => {
        if (comp.category === categoryName) {
            comp.category = 'Uncategorized';
            comp.lastModified = new Date().toISOString();
        }
    });

    closeModal();
    triggerSave();
    renderCompetencies();
    showManageCategories();
}

function editSubcategory(categoryName, oldSubcategoryName) {
    const competenciesWithSubcat = competencyLibrary.filter(c => c.category === categoryName && c.subcategory === oldSubcategoryName);

    const html = `
        <div class="form-group">
            <label class="form-label">Parent Category</label>
            <input type="text" class="form-input" value="${escapeHtml(categoryName)}" disabled>
            <div class="form-help">The parent category cannot be changed. To move subcategories, delete and recreate.</div>
        </div>

        <div class="form-group">
            <label class="form-label form-label-required">Subcategory Name</label>
            <input type="text" class="form-input" id="editSubcategoryName" value="${escapeHtml(oldSubcategoryName)}">
        </div>

        <div style="padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-top: 16px;">
            <strong>Note:</strong> Renaming this subcategory will update ${competenciesWithSubcat.length} competenc${competenciesWithSubcat.length === 1 ? 'y' : 'ies'}.
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSubcategoryEdit('${escapeHtml(categoryName).replace(/'/g, "\\'")}', '${escapeHtml(oldSubcategoryName).replace(/'/g, "\\'")}')">Save Changes</button>
    `;

    openModal('Edit Subcategory', html, footer);
}

function saveSubcategoryEdit(categoryName, oldSubcategoryName) {
    const newSubcategoryName = document.getElementById('editSubcategoryName').value.trim();

    if (!newSubcategoryName) {
        alert('Please enter a subcategory name');
        return;
    }

    if (newSubcategoryName === oldSubcategoryName) {
        closeModal();
        return;
    }

    // Check if new name already exists in this category
    const existingSubcats = getSubcategoriesForCategory(categoryName);
    if (existingSubcats.includes(newSubcategoryName)) {
        alert('A subcategory with this name already exists in this category');
        return;
    }

    // Update all competencies with this subcategory
    competencyLibrary.forEach(comp => {
        if (comp.category === categoryName && comp.subcategory === oldSubcategoryName) {
            comp.subcategory = newSubcategoryName;
            comp.lastModified = new Date().toISOString();
        }
    });

    closeModal();
    triggerSave();
    renderCompetencies();
    showManageCategories();
}

function deleteSubcategory(categoryName, subcategoryName) {
    const competenciesWithSubcat = competencyLibrary.filter(c => c.category === categoryName && c.subcategory === subcategoryName);

    if (competenciesWithSubcat.length > 0 && settings.confirmBeforeDelete) {
        if (!confirm(`This subcategory is used by ${competenciesWithSubcat.length} competenc${competenciesWithSubcat.length === 1 ? 'y' : 'ies'}. Deleting it will remove the subcategory from those competencies. Continue?`)) {
            return;
        }
    }

    // Remove subcategory from all competencies
    competencyLibrary.forEach(comp => {
        if (comp.category === categoryName && comp.subcategory === subcategoryName) {
            comp.subcategory = '';
            comp.lastModified = new Date().toISOString();
        }
    });

    closeModal();
    triggerSave();
    renderCompetencies();
    showManageCategories();
}

function viewCategoryDetails(categoryName) {
    const subcategories = getSubcategoriesForCategory(categoryName);
    const competenciesInCategory = competencyLibrary.filter(c => c.category === categoryName);

    let html = `
        <div style="margin-bottom: 24px;">
            <h3>${escapeHtml(categoryName)}</h3>
            <p style="color: #666;">${competenciesInCategory.length} competenc${competenciesInCategory.length === 1 ? 'y' : 'ies'} in this category</p>
        </div>

        <h4 style="margin-top: 24px; margin-bottom: 12px;">Subcategories (${subcategories.length})</h4>`;

    if (subcategories.length === 0) {
        html += `<p style="color: #999; padding: 20px; text-align: center; background: #f5f5f5; border-radius: 4px;">No subcategories yet</p>`;
    } else {
        html += '<div class="table-container"><table><thead><tr><th>Subcategory</th><th>Competencies</th><th>Actions</th></tr></thead><tbody>';

        subcategories.forEach(subcat => {
            const count = competencyLibrary.filter(c => c.category === categoryName && c.subcategory === subcat).length;
            html += `
                <tr>
                    <td><strong>${escapeHtml(subcat)}</strong></td>
                    <td>${count} competenc${count === 1 ? 'y' : 'ies'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-ghost" onclick="editSubcategory('${escapeHtml(categoryName).replace(/'/g, "\\'")}', '${escapeHtml(subcat).replace(/'/g, "\\'")}')">Edit</button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteSubcategory('${escapeHtml(categoryName).replace(/'/g, "\\'")}', '${escapeHtml(subcat).replace(/'/g, "\\'")}')">Delete</button>
                    </td>
                </tr>`;
        });

        html += '</tbody></table></div>';
    }

    html += `
        <h4 style="margin-top: 24px; margin-bottom: 12px;">Competencies in "${escapeHtml(categoryName)}"</h4>
        <div class="table-container"><table><thead><tr><th>Competency</th><th>Subcategory</th><th>Used By</th></tr></thead><tbody>`;

    if (competenciesInCategory.length === 0) {
        html += '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">No competencies in this category yet</td></tr>';
    } else {
        competenciesInCategory.forEach(comp => {
            const useCount = getCompetencyUsage(comp.id);
            html += `
                <tr>
                    <td><strong>${escapeHtml(comp.name)}</strong></td>
                    <td>${escapeHtml(comp.subcategory || '-')}</td>
                    <td>${useCount} resources</td>
                </tr>`;
        });
    }

    html += '</tbody></table></div>';

    const footer = `
        <button class="btn btn-ghost" onclick="showManageCategories()">Back to Categories</button>
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
    `;

    openModal(`Category: ${categoryName}`, html, footer, 'modal-large');
}

// === COURSE CATALOG (TAB 4) ===
function renderCourses() {
    const content = document.getElementById('coursesContent');

    const html = `
        <div class="card-header mb-2">
            <h2 class="card-title">Course Catalog</h2>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost" onclick="searchCoursesOnline()">üîç Search Online</button>
                <button class="btn btn-primary" onclick="showAddCourseForm()">+ Add Course</button>
            </div>
        </div>

        <div class="search-filter-bar">
            <input type="text" class="form-input search-input" placeholder="Search courses..." id="courseSearch" oninput="filterCourses()">
            <select class="form-select" id="courseFilterProvider" onchange="filterCourses()">
                <option value="">All Providers</option>
                ${[...new Set(courseCatalog.map(c => c.provider))].map(prov => `<option value="${prov}">${prov}</option>`).join('')}
            </select>
            <select class="form-select" id="courseFilterFormat" onchange="filterCourses()">
                <option value="">All Formats</option>
                <option value="Online Self-Paced">Online Self-Paced</option>
                <option value="Online Live">Online Live</option>
                <option value="In-Person">In-Person</option>
                <option value="Hybrid">Hybrid</option>
            </select>
        </div>

        <div id="coursesList">
            ${renderCoursesList()}
        </div>
    `;

    content.innerHTML = html;
}

function filterCourses() {
    const search = document.getElementById('courseSearch')?.value.toLowerCase() || '';
    const provider = document.getElementById('courseFilterProvider')?.value || '';
    const format = document.getElementById('courseFilterFormat')?.value || '';

    let filtered = courseCatalog;

    if (search) {
        filtered = filtered.filter(course =>
            course.title.toLowerCase().includes(search) ||
            (course.provider && course.provider.toLowerCase().includes(search)) ||
            (course.description && course.description.toLowerCase().includes(search)) ||
            (course.skillLevel && course.skillLevel.toLowerCase().includes(search))
        );
    }

    if (provider) {
        filtered = filtered.filter(course => course.provider === provider);
    }

    if (format) {
        filtered = filtered.filter(course => course.format === format);
    }

    // Update just the list portion
    const listContainer = document.getElementById('coursesList');
    if (listContainer) {
        listContainer.innerHTML = renderCoursesList(filtered);
    }
}

function renderCoursesList(filteredCourses = null) {
    const coursesToRender = filteredCourses || courseCatalog;

    if (coursesToRender.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üìö</div>
            <div class="empty-state-title">No ${filteredCourses ? 'Matching ' : ''}Courses${filteredCourses ? ' Found' : ' Yet'}</div>
            <div class="empty-state-description">${filteredCourses ? 'Try adjusting your search or filter criteria, or use "Search Online" to find courses from training providers.' : 'Add courses to your catalog to build training plans.'}</div>
            ${!filteredCourses ? '<button class="btn btn-primary" onclick="showAddCourseForm()">+ Add Course</button>' : ''}
        </div>`;
    }

    // Helper function to get sort indicator
    const getSortIndicator = (column) => {
        if (coursesSortColumn === column) {
            return coursesSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
        return '';
    };

    // Prepare course data with computed values for sorting
    const courseData = coursesToRender.map(course => ({
        course,
        totalCost: (course.cost || 0) + (course.requiresTravel ? (course.estimatedTravelCost || 0) : 0)
    }));

    // Sort courses based on current sort state
    if (coursesSortColumn) {
        courseData.sort((a, b) => {
            let aVal, bVal;

            switch (coursesSortColumn) {
                case 'title':
                    aVal = a.course.title.toLowerCase();
                    bVal = b.course.title.toLowerCase();
                    break;
                case 'provider':
                    aVal = a.course.provider.toLowerCase();
                    bVal = b.course.provider.toLowerCase();
                    break;
                case 'cost':
                    aVal = a.totalCost;
                    bVal = b.totalCost;
                    break;
                case 'duration':
                    aVal = a.course.duration?.totalHours || 0;
                    bVal = b.course.duration?.totalHours || 0;
                    break;
                case 'format':
                    aVal = a.course.format.toLowerCase();
                    bVal = b.course.format.toLowerCase();
                    break;
                case 'level':
                    // Sort by skill level hierarchy: Beginner < Intermediate < Advanced < Expert
                    const levelOrder = { 'Beginner': 1, 'Intermediate': 2, 'Advanced': 3, 'Expert': 4, 'All': 0 };
                    aVal = levelOrder[a.course.skillLevel] || 0;
                    bVal = levelOrder[b.course.skillLevel] || 0;
                    break;
                case 'rating':
                    aVal = a.course.rating || 0;
                    bVal = b.course.rating || 0;
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return coursesSortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return coursesSortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }

    let html = '<div class="table-container"><table><thead><tr>';
    html += `<th onclick="sortCoursesTable('title')" style="cursor: pointer; user-select: none;">Course Title${getSortIndicator('title')}</th>`;
    html += `<th onclick="sortCoursesTable('provider')" style="cursor: pointer; user-select: none;">Provider${getSortIndicator('provider')}</th>`;
    html += `<th onclick="sortCoursesTable('format')" style="cursor: pointer; user-select: none;">Format${getSortIndicator('format')}</th>`;
    html += `<th onclick="sortCoursesTable('level')" style="cursor: pointer; user-select: none;">Level${getSortIndicator('level')}</th>`;
    html += `<th onclick="sortCoursesTable('duration')" style="cursor: pointer; user-select: none;">Duration${getSortIndicator('duration')}</th>`;
    html += `<th onclick="sortCoursesTable('cost')" style="cursor: pointer; user-select: none;">Total Cost${getSortIndicator('cost')}</th>`;
    html += `<th onclick="sortCoursesTable('rating')" style="cursor: pointer; user-select: none;">Rating${getSortIndicator('rating')}</th>`;
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';

    courseData.forEach(({ course, totalCost }) => {
        const ratingDisplay = course.rating
            ? `‚≠ê ${course.rating.toFixed(1)}${course.ratingCount ? ` (${course.ratingCount})` : ''}`
            : '‚Äî';

        const certBadge = course.hasCertification
            ? '<span class="badge badge-success" style="font-size: 10px; margin-left: 4px;">Cert</span>'
            : '';

        const travelIndicator = course.requiresTravel
            ? '<span class="badge badge-warning" style="font-size: 10px; margin-left: 4px;">Travel</span>'
            : '';

        html += `
            <tr onclick="viewCourseDetail(${course.id})" style="cursor: pointer;">
                <td>
                    <div><strong>${escapeHtml(course.title)}</strong>${certBadge}${travelIndicator}</div>
                </td>
                <td>${escapeHtml(course.provider)}</td>
                <td>${escapeHtml(course.format)}</td>
                <td>${escapeHtml(course.skillLevel || 'All')}</td>
                <td>${course.duration?.totalHours || 0}h</td>
                <td>
                    <div>${formatCurrency(course.cost || 0)}</div>
                    ${course.requiresTravel && course.estimatedTravelCost ? `<div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">+${formatCurrency(course.estimatedTravelCost)} travel</div>` : ''}
                </td>
                <td>${ratingDisplay}</td>
                <td class="table-actions">
                    <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); viewCourseDetail(${course.id})">View</button>
                    <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); deleteCourse(${course.id})">Delete</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function sortCoursesTable(column) {
    // If clicking the same column, toggle direction; otherwise, set to ascending
    if (coursesSortColumn === column) {
        coursesSortDirection = coursesSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        coursesSortColumn = column;
        coursesSortDirection = 'asc';
    }

    // Re-render the courses to reflect the new sort
    renderCourses();
}

function showAddCourseForm() {
    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Title</label>
            <input type="text" class="form-input" id="newCourseTitle" placeholder="AWS Certified Solutions Architect">
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Provider</label>
                <input type="text" class="form-input" id="newCourseProvider" placeholder="AWS Training">
            </div>

            <div class="form-group">
                <label class="form-label">Cost</label>
                <input type="number" class="form-input" id="newCourseCost" placeholder="300" min="0">
            </div>
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Format</label>
                <select class="form-select" id="newCourseFormat">
                    <option value="Online Self-Paced">Online Self-Paced</option>
                    <option value="Online Live">Online Live</option>
                    <option value="In-Person">In-Person</option>
                    <option value="Hybrid">Hybrid</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Duration (hours)</label>
                <input type="number" class="form-input" id="newCourseDuration" placeholder="40" min="1">
            </div>
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Skill Level</label>
                <select class="form-select" id="newCourseLevel">
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                    <option value="Expert">Expert</option>
                    <option value="All Levels">All Levels</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Rating (1-5)</label>
                <input type="number" class="form-input" id="newCourseRating" placeholder="4.5" min="1" max="5" step="0.1">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">URL</label>
            <input type="url" class="form-input" id="newCourseUrl" placeholder="https://...">
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="newCourseDescription" placeholder="Course overview..."></textarea>
        </div>

        <div class="form-group">
            <label class="form-checkbox">
                <input type="checkbox" id="newCourseCert">
                <span>Includes Certification</span>
            </label>
        </div>

        <div class="form-group">
            <label class="form-checkbox">
                <input type="checkbox" id="newCourseTravelRequired" onchange="document.getElementById('newCourseTravelCostGroup').style.display = this.checked ? 'block' : 'none'">
                <span>Requires Travel (for In-Person or Hybrid courses)</span>
            </label>
            <div class="form-help">Check if attending this course requires travel expenses (flights, hotels, meals)</div>
        </div>

        <div class="form-group" id="newCourseTravelCostGroup" style="display: none;">
            <label class="form-label">Estimated Travel Cost</label>
            <input type="number" class="form-input" id="newCourseTravelCost" placeholder="2000" min="0">
            <div class="form-help">Estimated cost for travel, accommodation, and meals per attendee</div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewCourse()">Add Course</button>
    `;

    openModal('Add New Course', html, footer);
}

function saveNewCourse() {
    const title = document.getElementById('newCourseTitle').value.trim();
    if (!title) {
        alert('Please enter a course title');
        return;
    }

    const newCourse = {
        id: nextCourseId++,
        title: title,
        provider: document.getElementById('newCourseProvider').value.trim() || 'Unknown Provider',
        providerType: 'MOOC',
        url: document.getElementById('newCourseUrl').value.trim(),
        description: document.getElementById('newCourseDescription').value.trim(),
        format: document.getElementById('newCourseFormat').value,
        duration: {
            totalHours: parseFloat(document.getElementById('newCourseDuration').value) || 0,
            weeksToComplete: 0,
            hoursPerWeek: 0
        },
        location: '',
        language: 'English',
        cost: parseFloat(document.getElementById('newCourseCost').value) || 0,
        costCurrency: settings.currency,
        costNotes: '',
        rating: parseFloat(document.getElementById('newCourseRating').value) || 0,
        ratingCount: 0,
        sentiment: 'Good',
        sentimentSummary: '',
        skillLevel: document.getElementById('newCourseLevel').value,
        keyTopics: [],
        learningObjectives: [],
        prerequisites: [],
        hasCertification: document.getElementById('newCourseCert').checked,
        certificationName: '',
        certificationBody: '',
        certificationValidityYears: 0,
        requiresTravel: document.getElementById('newCourseTravelRequired').checked,
        estimatedTravelCost: parseFloat(document.getElementById('newCourseTravelCost').value) || 0,
        relevantCompetencies: [],
        discoveredBy: 'Manual Entry',
        discoveryDate: new Date().toISOString(),
        discoveryContext: '',
        timesAssigned: 0,
        completionRate: 0,
        averageRating: 0,
        isActive: true,
        isRecommended: false,
        isDeprecated: false,
        deprecationNote: '',
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        lastVerified: new Date().toISOString()
    };

    courseCatalog.push(newCourse);
    closeModal();
    triggerSave();
    renderCourses();
}

function viewCourseDetail(courseId) {
    const course = courseCatalog.find(c => c.id === courseId);
    if (!course) return;

    const html = `
        <div>
            <h3>${course.title}</h3>
            <p><strong>Provider:</strong> ${course.provider}</p>
            <p><strong>Cost:</strong> ${formatCurrency(course.cost)}</p>
            <p><strong>Duration:</strong> ${course.duration.totalHours} hours</p>
            <p><strong>Format:</strong> ${course.format}</p>
            <p><strong>Level:</strong> ${course.skillLevel}</p>
            <p><strong>Rating:</strong> ${'‚≠ê'.repeat(Math.round(course.rating || 0))} ${course.rating ? course.rating.toFixed(1) : 'No rating'}</p>
            ${course.hasCertification ? '<p><strong>Certification:</strong> ‚úì Includes certification</p>' : ''}
            ${course.url ? `<p><strong>URL:</strong> <a href="${course.url}" target="_blank">View Course</a></p>` : ''}
            ${course.description ? `<p><strong>Description:</strong> ${course.description}</p>` : ''}
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-error" onclick="deleteCourse(${courseId})">Delete</button>
    `;

    openModal(`Course: ${course.title}`, html, footer);
}

function deleteCourse(courseId) {
    if (settings.confirmBeforeDelete) {
        if (!confirm('Are you sure you want to delete this course?')) {
            return;
        }
    }

    const index = courseCatalog.findIndex(c => c.id === courseId);
    if (index > -1) {
        courseCatalog.splice(index, 1);
        closeModal();
        triggerSave();
        renderCourses();
    }
}

// AI-Powered Online Course Search
function searchCoursesOnline() {
    if (!hasApiKey()) {
        openModal('API Key Required', `
            <div class="alert alert-warning">
                <strong>AI Integration Not Configured</strong>
                <p>To search online course repositories, you need to configure an AI provider in Settings.</p>
            </div>
        `, `
            <button class="btn btn-primary" onclick="closeModal(); openSettings()">Open Settings</button>
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        `);
        return;
    }

    const bodyHtml = `
        <p>Search across all accessible online training repositories from major providers (Udemy, Coursera, LinkedIn Learning, Pluralsight, O'Reilly, SANS, AWS Training, etc.) for relevant courses.</p>

        <div class="form-group">
            <label class="form-label form-label-required">Search Query</label>
            <input type="text" class="form-input" id="onlineSearchQuery" placeholder="e.g., Python for Data Science, AWS Solutions Architect, Kubernetes Administration">
            <div class="form-help">Describe the skills or topics you're looking for</div>
        </div>

        <div class="form-group">
            <label class="form-label">Preferred Format</label>
            <select class="form-select" id="onlineSearchFormat">
                <option value="">Any Format</option>
                <option value="Online Self-Paced">Online Self-Paced</option>
                <option value="Online Live">Online Live</option>
                <option value="In-Person">In-Person</option>
                <option value="Hybrid">Hybrid</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Skill Level</label>
            <select class="form-select" id="onlineSearchLevel">
                <option value="">Any Level</option>
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
                <option value="Expert">Expert</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Maximum Cost</label>
            <input type="number" class="form-input" id="onlineSearchMaxCost" placeholder="e.g., 500" min="0">
            <div class="form-help">Leave blank for no budget limit</div>
        </div>

        <div id="searchResults" style="margin-top: 24px;"></div>
    `;

    const footerHtml = `
        <button class="btn btn-primary" onclick="executeOnlineCourseSearch()">üîç Search</button>
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    `;

    openModal('Search Online Course Repositories', bodyHtml, footerHtml, 'modal-large');
}

async function executeOnlineCourseSearch() {
    const query = document.getElementById('onlineSearchQuery').value.trim();
    if (!query) {
        alert('Please enter a search query');
        return;
    }

    const format = document.getElementById('onlineSearchFormat').value;
    const level = document.getElementById('onlineSearchLevel').value;
    const maxCost = document.getElementById('onlineSearchMaxCost').value;

    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '<div class="alert alert-info">‚è≥ Searching online course repositories... This may take 10-15 seconds.</div>';

    // Update footer to disable search button
    const footerHtml = `
        <button class="btn btn-primary" disabled>‚è≥ Searching...</button>
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    `;
    document.getElementById('modalFooter').innerHTML = footerHtml;

    try {
        const systemPrompt = `You are a training course search engine with access to all major online learning platforms including:
- Udemy, Coursera, LinkedIn Learning, Pluralsight, O'Reilly Learning
- Cloud providers: AWS Training, Microsoft Learn, Google Cloud Skills Boost
- Security training: SANS Institute, Cybrary, INE
- Development platforms: Frontend Masters, Egghead.io, Codecademy
- Professional certifications: CompTIA, PMI, ISACA
- Universities and specialized platforms

Search across these platforms and return 6-10 high-quality courses that match the criteria.
Return ONLY a JSON array with no additional text. Each course object must have:
- title: Full course name
- provider: Platform name (e.g., "Udemy", "Coursera")
- cost: Estimated cost in USD (number, use 0 for free courses)
- duration: Object with totalHours (number)
- url: Direct link to the course (use realistic URLs for actual courses)
- format: "Online Self-Paced", "Online Live", "In-Person", or "Hybrid"
- skillLevel: "Beginner", "Intermediate", "Advanced", or "Expert"
- rating: Rating out of 5 (number)
- ratingCount: Number of reviews (number)
- hasCertification: boolean (true if includes certificate)
- description: 1-2 sentence course description
- requiresTravel: boolean (true only for in-person courses)
- estimatedTravelCost: number (0 unless in-person)

IMPORTANT: Return ONLY valid JSON array, no markdown, no explanations. Prioritize real, currently available courses.`;

        const userPrompt = `Search for: "${query}"
${format ? `Preferred format: ${format}` : 'Any format'}
${level ? `Skill level: ${level}` : 'Any skill level'}
${maxCost ? `Maximum cost: $${maxCost}` : 'No budget limit'}

Find real, currently available courses from major training providers. Ensure variety across different platforms.`;

        const response = await callClaudeAPI(systemPrompt, userPrompt);

        // Parse JSON response
        let courses;
        try {
            // Try to parse directly
            courses = JSON.parse(response);
        } catch (e) {
            // Try to extract JSON from markdown code blocks
            const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/) || response.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                courses = JSON.parse(jsonMatch[1] || jsonMatch[0]);
            } else {
                throw new Error('AI returned invalid JSON format');
            }
        }

        if (!Array.isArray(courses) || courses.length === 0) {
            resultsContainer.innerHTML = '<div class="alert alert-warning">No courses found matching your criteria. Try broadening your search.</div>';
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="executeOnlineCourseSearch()">üîç Search Again</button>
                <button class="btn btn-ghost" onclick="closeModal()">Close</button>
            `;
            return;
        }

        // Display results
        let html = `<div class="alert alert-success">‚úì Found ${courses.length} courses from online repositories</div>`;
        html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 16px;">';
        html += '<div class="grid-auto">';

        courses.forEach((course, index) => {
            const ratingStars = '‚≠ê'.repeat(Math.round(course.rating || 0));
            const courseId = `searchResult_${index}`;

            html += `
                <div class="card">
                    <div class="card-header">
                        <div style="flex: 1;">
                            <h4 class="card-title" style="font-size: 14px; margin-bottom: 4px;">${escapeHtml(course.title)}</h4>
                            <div class="card-subtitle">${escapeHtml(course.provider)}</div>
                        </div>
                        ${course.hasCertification ? '<span class="badge badge-success">Cert</span>' : ''}
                    </div>
                    <div class="card-body">
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            ${ratingStars} ${course.rating ? course.rating.toFixed(1) : 'N/A'}
                            ${course.ratingCount ? `(${course.ratingCount.toLocaleString()} reviews)` : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 8px;">
                            <div><strong>Cost:</strong> ${formatCurrency(course.cost || 0)}</div>
                            <div><strong>Duration:</strong> ${course.duration?.totalHours || 0}h</div>
                            <div><strong>Level:</strong> ${course.skillLevel || 'All'}</div>
                            <div><strong>Format:</strong> ${course.format || 'Online'}</div>
                        </div>
                        ${course.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">${escapeHtml(course.description)}</div>` : ''}
                        ${course.url ? `<div style="margin-bottom: 12px;"><a href="${escapeHtml(course.url)}" target="_blank" class="btn btn-sm btn-ghost">View Course ‚Üí</a></div>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="addSearchResultToCatalog(${index})" id="${courseId}Btn">+ Add to Catalog</button>
                    </div>
                </div>
            `;
        });

        html += '</div></div>';
        resultsContainer.innerHTML = html;

        // Store courses in a global variable for adding to catalog
        window.searchResultCourses = courses;

        // Update footer
        document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        `;

    } catch (error) {
        console.error('Online course search failed:', error);
        resultsContainer.innerHTML = `<div class="alert alert-danger">
            <strong>Search Failed</strong>
            <p>${escapeHtml(error.message)}</p>
            <p style="font-size: 12px; margin-top: 8px;">Please check your API configuration and try again.</p>
        </div>`;

        document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-primary" onclick="executeOnlineCourseSearch()">üîç Try Again</button>
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        `;
    }
}

function addSearchResultToCatalog(index) {
    if (!window.searchResultCourses || !window.searchResultCourses[index]) {
        alert('Course not found');
        return;
    }

    const course = window.searchResultCourses[index];

    // Check if course already exists (by title and provider)
    const existingCourse = courseCatalog.find(c =>
        c.title.toLowerCase() === course.title.toLowerCase() &&
        c.provider.toLowerCase() === course.provider.toLowerCase()
    );

    if (existingCourse) {
        alert('This course is already in your catalog.');
        return;
    }

    // Add to catalog
    const newCourse = {
        id: nextCourseId++,
        title: course.title,
        provider: course.provider,
        cost: course.cost || 0,
        duration: course.duration || { totalHours: 0 },
        url: course.url || '',
        format: course.format || 'Online Self-Paced',
        skillLevel: course.skillLevel || 'All Levels',
        rating: course.rating || 0,
        ratingCount: course.ratingCount || 0,
        hasCertification: course.hasCertification || false,
        description: course.description || '',
        requiresTravel: course.requiresTravel || false,
        estimatedTravelCost: course.estimatedTravelCost || 0,
        addedDate: new Date().toISOString().split('T')[0],
        timesAssigned: 0,
        completionRate: 0
    };

    courseCatalog.push(newCourse);
    triggerSave();

    // Update button to show it was added
    const btn = document.getElementById(`searchResult_${index}Btn`);
    if (btn) {
        btn.textContent = '‚úì Added';
        btn.disabled = true;
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
    }

    // Show success message
    const resultsContainer = document.getElementById('searchResults');
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success';
    successMsg.style.marginTop = '12px';
    successMsg.textContent = `‚úì "${course.title}" has been added to your course catalog`;
    resultsContainer.insertBefore(successMsg, resultsContainer.firstChild);

    // Auto-remove success message after 3 seconds
    setTimeout(() => {
        successMsg.remove();
    }, 3000);
}

// === TRAINING PLANS (TAB 5) ===
function renderTrainingPlans() {
    const content = document.getElementById('trainingPlansContent');

    if (wizardState.active) {
        content.innerHTML = renderWizard();
        return;
    }

    const html = `
        <div class="card-header mb-2">
            <h2 class="card-title">Training Plans</h2>
            <button class="btn btn-primary" onclick="startNewPlan()">+ Create Training Plan</button>
        </div>

        <div id="plansList">
            ${renderPlansList()}
        </div>
    `;

    content.innerHTML = html;
}

function renderPlansList() {
    if (trainingPlans.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-title">No Training Plans Yet</div>
            <div class="empty-state-description">Create your first AI-assisted training plan.</div>
            <button class="btn btn-primary" onclick="startNewPlan()">+ Create Training Plan</button>
        </div>`;
    }

    let html = '<div class="grid-auto">';

    trainingPlans.forEach(plan => {
        const resource = resources.find(r => r.id === plan.resourceId);
        const resourceName = resource ? resource.name : 'Unknown';

        html += `
            <div class="card" onclick="viewPlanDetails(${plan.id})" style="cursor: pointer;">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">${escapeHtml(plan.planName)}</h3>
                        <div class="card-subtitle">${resourceName}</div>
                    </div>
                    ${getStatusBadge(plan.status)}
                </div>
                <div class="card-body">
                    <p>${escapeHtml(plan.planDescription || 'No description')}</p>
                    <div style="margin-top: 12px;">
                        <strong>Period:</strong> ${formatDate(plan.planPeriod?.startDate)} - ${formatDate(plan.planPeriod?.endDate)}
                    </div>
                    <div><strong>Budget:</strong> ${formatCurrency(plan.allocatedBudget || 0)}</div>
                    <div><strong>Courses:</strong> ${plan.scheduledCourses?.length || 0}</div>
                    ${plan.aiRecommendations && Object.keys(plan.aiRecommendations).length > 0 ? '<div style="margin-top: 8px;"><span class="badge badge-info">AI-Assisted</span></div>' : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

function viewPlanDetails(planId) {
    const plan = trainingPlans.find(p => p.id === planId);
    if (!plan) return;

    const resource = resources.find(r => r.id === plan.resourceId);
    if (!resource) return;

    let html = `
        <div style="max-width: 900px;">
            <div style="margin-bottom: 24px;">
                <h2 style="margin: 0 0 8px 0;">${escapeHtml(plan.planName)}</h2>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <span class="card-subtitle">${resource.name} ‚Ä¢ ${resource.jobTitle || 'No title'}</span>
                    ${getStatusBadge(plan.status)}
                    ${plan.aiRecommendations && Object.keys(plan.aiRecommendations).length > 0 ? '<span class="badge badge-info">AI-Assisted</span>' : ''}
                </div>
            </div>

            <div style="background: var(--neutral-50); padding: 20px; border-radius: var(--radius-lg); margin-bottom: 24px;">
                <h3 style="margin: 0 0 16px 0; font-size: 16px;">Plan Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Period</div>
                        <div style="font-weight: 500;">${formatDate(plan.planPeriod?.startDate)} - ${formatDate(plan.planPeriod?.endDate)}</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Budget</div>
                        <div style="font-weight: 500;">${formatCurrency(plan.allocatedBudget || 0)}</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Courses</div>
                        <div style="font-weight: 500;">${plan.scheduledCourses?.length || 0} scheduled</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Created</div>
                        <div style="font-weight: 500;">${formatDate(plan.createdDate)}</div>
                    </div>
                </div>
            </div>
    `;

    // AI Recommendations Section
    if (plan.aiRecommendations && Object.keys(plan.aiRecommendations).length > 0) {
        html += '<div style="margin-bottom: 24px;">';
        html += '<h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;"><span>ü§ñ</span> AI Recommendations & Insights</h3>';

        // Competency Assessment
        if (plan.aiRecommendations.competencyAssessment) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); padding: 20px; border-radius: var(--radius-md); margin-bottom: 16px;">';
            html += '<h4 style="margin: 0 0 12px 0; font-size: 15px; color: var(--primary-color);">Competency Assessment</h4>';
            if (Array.isArray(plan.aiRecommendations.competencyAssessment)) {
                html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
                plan.aiRecommendations.competencyAssessment.forEach(comp => {
                    html += `
                        <div style="border-left: 3px solid var(--secondary-color); padding-left: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(comp.name || 'Unknown Competency')}</div>
                            <div style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                                <strong>Current Level:</strong> ${comp.currentLevel || 'N/A'}/5 |
                                <strong>Category:</strong> ${escapeHtml(comp.category || 'Uncategorized')}
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); font-style: italic;">
                                ${escapeHtml(comp.rationale || 'No rationale provided')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += `<p style="margin: 0; font-size: 14px; color: var(--neutral-600);">${escapeHtml(String(plan.aiRecommendations.competencyAssessment))}</p>`;
            }
            html += '</div>';
        }

        // Training Goals
        if (plan.aiRecommendations.trainingGoals) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); padding: 20px; border-radius: var(--radius-md); margin-bottom: 16px;">';
            html += '<h4 style="margin: 0 0 12px 0; font-size: 15px; color: var(--primary-color);">Recommended Training Goals</h4>';
            if (Array.isArray(plan.aiRecommendations.trainingGoals)) {
                html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
                plan.aiRecommendations.trainingGoals.forEach(goal => {
                    const priorityColor = {
                        'Critical': '#ef4444',
                        'High': '#f97316',
                        'Medium': '#f59e0b',
                        'Low': '#22c55e'
                    }[goal.priority] || '#6b7280';
                    html += `
                        <div style="border-left: 3px solid ${priorityColor}; padding-left: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                ${escapeHtml(goal.competencyName || 'Unknown Goal')}
                                <span style="font-size: 11px; padding: 2px 8px; background: ${priorityColor}; color: white; border-radius: 12px;">${goal.priority || 'Unknown'}</span>
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                                <strong>Target Level:</strong> ${goal.targetLevel || 'N/A'}/5
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); font-style: italic;">
                                <strong>Why:</strong> ${escapeHtml(goal.rationale || 'No rationale provided')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += `<p style="margin: 0; font-size: 14px; color: var(--neutral-600);">${escapeHtml(String(plan.aiRecommendations.trainingGoals))}</p>`;
            }
            html += '</div>';
        }

        // Course Recommendations
        if (plan.aiRecommendations.courseRecommendations) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); padding: 20px; border-radius: var(--radius-md);">';
            html += '<h4 style="margin: 0 0 12px 0; font-size: 15px; color: var(--primary-color);">AI-Recommended Courses</h4>';
            if (Array.isArray(plan.aiRecommendations.courseRecommendations)) {
                html += '<div style="display: flex; flex-direction: column; gap: 16px;">';
                plan.aiRecommendations.courseRecommendations.forEach((course, idx) => {
                    const relevancePercent = (course.relevanceScore || 0) * 10;
                    const relevanceColor = relevancePercent >= 80 ? '#22c55e' : relevancePercent >= 60 ? '#f59e0b' : '#ef4444';
                    html += `
                        <div style="border: 1px solid var(--neutral-200); padding: 16px; border-radius: var(--radius-md); background: var(--neutral-50);">
                            <div style="display: flex; justify-content: between; align-items: start; gap: 12px; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${idx + 1}. ${escapeHtml(course.title || 'Unknown Course')}</div>
                                    <div style="font-size: 13px; color: var(--neutral-700);">
                                        ${escapeHtml(course.provider || 'Unknown Provider')} ‚Ä¢
                                        ${formatCurrency(course.cost || 0)} ‚Ä¢
                                        ${course.duration || 'Unknown duration'} ‚Ä¢
                                        ${escapeHtml(course.format || 'Unknown format')}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 2px;">Relevance</div>
                                    <div style="font-weight: 700; font-size: 18px; color: ${relevanceColor};">${relevancePercent}%</div>
                                </div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 4px; margin-top: 8px;">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-color); margin-bottom: 4px;">WHY THIS COURSE:</div>
                                <div style="font-size: 13px; color: var(--neutral-700); line-height: 1.5;">
                                    ${escapeHtml(course.rationale || 'This course aligns with the training goals and helps develop required competencies.')}
                                </div>
                            </div>
                            ${course.url ? `<div style="margin-top: 8px;"><a href="${escapeHtml(course.url)}" target="_blank" style="font-size: 13px; color: var(--primary-color);">View Course ‚Üí</a></div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += `<p style="margin: 0; font-size: 14px; color: var(--neutral-600);">${escapeHtml(String(plan.aiRecommendations.courseRecommendations))}</p>`;
            }
            html += '</div>';
        }

        html += '</div>';
    } else {
        html += '<div class="alert alert-info" style="margin-bottom: 24px;">This plan was created without AI assistance. No AI recommendations available.</div>';
    }

    // Scheduled Courses Section
    if (plan.scheduledCourses && plan.scheduledCourses.length > 0) {
        html += '<div style="margin-bottom: 24px;">';
        html += '<h3 style="margin: 0 0 16px 0; font-size: 18px;">Scheduled Courses</h3>';
        html += '<div style="background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-md); overflow: hidden;">';
        html += '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead style="background: var(--neutral-100);"><tr>';
        html += '<th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid var(--neutral-200);">Course</th>';
        html += '<th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid var(--neutral-200);">Start Date</th>';
        html += '<th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid var(--neutral-200);">Duration</th>';
        html += '<th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid var(--neutral-200);">Status</th>';
        html += '</tr></thead><tbody>';
        plan.scheduledCourses.forEach((course, idx) => {
            html += `<tr style="${idx % 2 === 0 ? 'background: var(--neutral-50);' : ''}">`;
            html += `<td style="padding: 12px; font-size: 14px;">${escapeHtml(course.title || 'Unknown Course')}</td>`;
            html += `<td style="padding: 12px; font-size: 14px;">${formatDate(course.startDate)}</td>`;
            html += `<td style="padding: 12px; font-size: 14px;">${course.duration || 'N/A'}</td>`;
            html += `<td style="padding: 12px; font-size: 14px;">${getStatusBadge(course.status || 'Planned')}</td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
        html += '</div>';
    }

    // Actions
    html += '<div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--neutral-200); display: flex; gap: 12px; justify-content: flex-end;">';
    html += `<button class="btn btn-ghost" onclick="closeModal()">Close</button>`;
    html += `<button class="btn btn-danger" onclick="deletePlan(${plan.id})">Delete Plan</button>`;
    html += '</div>';

    html += '</div>';

    openModal('Training Plan Details', html, 'modal-xlarge');
}

function deletePlan(planId) {
    if (!confirm('Are you sure you want to delete this training plan? This cannot be undone.')) {
        return;
    }

    const index = trainingPlans.findIndex(p => p.id === planId);
    if (index > -1) {
        trainingPlans.splice(index, 1);
        closeModal();
        triggerSave();
        renderTrainingPlans();
    }
}

function startNewPlan(preselectedResourceId = null) {
    wizardState = {
        active: true,
        currentStep: 1,
        totalSteps: 6,
        data: {
            resourceId: preselectedResourceId,
            competencies: [],
            goals: [],
            selectedCourses: [],
            schedule: [],
            planDetails: {},
            aiOutputs: {
                competencyAssessment: null,
                trainingGoals: null,
                courseRecommendations: null
            }
        },
        prompts: {
            competencyAssessment: `You are an expert HR consultant specializing in technical competency assessment.
Analyze the provided job role and suggest relevant technical competencies with proficiency levels.
Return your response as a JSON array of objects with: name, category, currentLevel (1-5), rationale.
Be specific about why each competency is important for this role and how it contributes to their effectiveness.`,
            goalRecommendation: `You are a career development advisor. Based on the resource's current competencies and role,
suggest training goals that will help them advance in their career. Return JSON array with: competencyName,
targetLevel (1-5), priority (Critical/High/Medium/Low), rationale.
For each goal, explain WHY this particular competency is critical for their growth and how it will benefit their career trajectory.`,
            courseDiscovery: `You are a training course advisor. Search for and recommend training courses
that match the specified goals and constraints. Return JSON array with: title, provider, cost, duration,
url, format, skillLevel, relevanceScore (1-10), rationale.
For EACH course, provide a detailed rationale explaining:
1. How this specific course addresses the training goals
2. Why this course is superior to alternatives
3. What specific skills/knowledge the learner will gain
4. How it fits into their overall development journey
Be very specific and insightful in your recommendations.`
        }
    };
    renderTrainingPlans();
}

function renderWizard() {
    const steps = ['Select Resource', 'Assess', 'Goals', 'Discover', 'Schedule', 'Review'];

    let html = `
        <div class="wizard-container">
            <div class="wizard-header">
                <h2 class="wizard-title">Create Training Plan</h2>
                <p class="wizard-subtitle">Step ${wizardState.currentStep} of ${wizardState.totalSteps}</p>
            </div>

            <div class="wizard-progress">
    `;

    for (let i = 1; i <= wizardState.totalSteps; i++) {
        const isActive = i === wizardState.currentStep;
        const isCompleted = i < wizardState.currentStep;
        const stepClass = isActive ? 'active' : isCompleted ? 'completed' : '';

        html += `
            <div class="wizard-step ${stepClass}">
                <div class="wizard-step-circle">${isCompleted ? '‚úì' : i}</div>
                <div class="wizard-step-label">${steps[i-1]}</div>
                ${i < wizardState.totalSteps ? '<div class="wizard-step-line"></div>' : ''}
            </div>
        `;
    }

    html += `
            </div>

            <div class="wizard-content">
                ${renderWizardStep(wizardState.currentStep)}
            </div>

            <div class="wizard-navigation">
                <div>
                    ${wizardState.currentStep > 1 ? '<button class="btn btn-ghost" onclick="wizardPreviousStep()">‚Üê Back</button>' : '<button class="btn btn-ghost" onclick="wizardCancel()">Cancel</button>'}
                </div>
                <div>
                    ${wizardState.currentStep < wizardState.totalSteps ? '<button class="btn btn-primary" onclick="wizardNextStep()">Next ‚Üí</button>' : '<button class="btn btn-success" onclick="wizardFinish()">Finish</button>'}
                </div>
            </div>
        </div>
    `;

    return html;
}

function renderWizardStep(step) {
    switch(step) {
        case 1: return renderWizardStep1();
        case 2: return renderWizardStep2();
        case 3: return renderWizardStep3();
        case 4: return renderWizardStep4();
        case 5: return renderWizardStep5();
        case 6: return renderWizardStep6();
        default: return '<p>Invalid step</p>';
    }
}

function renderWizardStep1() {
    let html = `
        <h3>Select Team Member</h3>
        <p style="margin-bottom: 20px;">Choose the resource for this training plan.</p>
    `;

    if (resources.length === 0) {
        return html + '<div class="alert alert-warning">No resources available. Please add a resource first.</div>';
    }

    html += '<div style="max-height: 400px; overflow-y: auto;">';

    resources.forEach(resource => {
        const isSelected = wizardState.data.resourceId === resource.id;
        html += `
            <div class="list-item" onclick="selectWizardResource(${resource.id})" style="cursor: pointer; ${isSelected ? 'background: var(--bg-selected);' : ''}">
                <div>
                    <div class="list-item-title">${escapeHtml(resource.name)}</div>
                    <div class="list-item-subtitle">${escapeHtml(resource.jobTitle || '')} ‚Ä¢ ${escapeHtml(resource.location || '')}</div>
                </div>
                ${isSelected ? '<span class="badge badge-success">Selected</span>' : ''}
            </div>
        `;
    });

    html += '</div>';
    return html;
}

function selectWizardResource(resourceId) {
    wizardState.data.resourceId = resourceId;
    renderTrainingPlans();
}

function renderWizardStep2() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return '<p>Resource not found</p>';

    const hasAssessment = wizardState.data.aiOutputs.competencyAssessment;

    let html = `
        <h3>Step 2: AI Competency Assessment</h3>
        <p style="margin-bottom: 20px;">Use AI to analyze ${resource.name}'s role and assess current competencies.</p>

        ${!hasApiKey() ? '<div class="alert alert-warning" style="margin-bottom: 20px;"><strong>‚ö†Ô∏è API Key Required:</strong> Configure your AI API key in Settings to use AI features.</div>' : ''}

        <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">AI Prompt (Customizable)</h4>
                <button class="btn btn-ghost btn-sm" onclick="togglePromptEdit('competencyAssessment')" id="togglePromptBtn_competencyAssessment">
                    ${wizardState.showPromptEdit?.competencyAssessment ? 'Hide' : 'Edit Prompt'}
                </button>
            </div>
            <div id="promptView_competencyAssessment" style="${wizardState.showPromptEdit?.competencyAssessment ? 'display: none;' : ''}">
                <div style="font-size: 13px; color: var(--neutral-700); line-height: 1.6; white-space: pre-wrap; font-family: monospace; background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--neutral-200);">
                    ${escapeHtml(wizardState.prompts.competencyAssessment)}
                </div>
            </div>
            <div id="promptEdit_competencyAssessment" style="${wizardState.showPromptEdit?.competencyAssessment ? '' : 'display: none;'}">
                <textarea id="promptText_competencyAssessment" style="width: 100%; min-height: 150px; font-family: monospace; font-size: 13px; padding: 12px; border: 1px solid var(--neutral-300); border-radius: 4px; resize: vertical;">${escapeHtml(wizardState.prompts.competencyAssessment)}</textarea>
                <div style="margin-top: 8px; display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="savePromptEdit('competencyAssessment')">Save Prompt</button>
                    <button class="btn btn-ghost btn-sm" onclick="resetPrompt('competencyAssessment')">Reset to Default</button>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="runCompetencyAssessment()" ${!hasApiKey() ? 'disabled' : ''} id="runAssessmentBtn">
                <span id="assessmentBtnText">ü§ñ Run AI Competency Assessment</span>
            </button>
        </div>

        <div id="assessmentResults" style="margin-top: 20px;">
    `;

    if (hasAssessment) {
        html += '<div class="alert alert-success" style="margin-bottom: 16px;">‚úì AI Assessment Complete</div>';

        if (Array.isArray(hasAssessment)) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-md); padding: 20px;">';
            html += '<h4 style="margin: 0 0 16px 0; font-size: 15px;">Identified Competencies</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            hasAssessment.forEach(comp => {
                html += `
                    <div style="border-left: 3px solid var(--secondary-color); padding-left: 12px; background: var(--neutral-50); padding: 12px; border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(comp.name)}</div>
                        <div style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                            <strong>Level:</strong> ${comp.currentLevel}/5 |
                            <strong>Category:</strong> ${escapeHtml(comp.category)}
                        </div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-style: italic;">
                            <strong>Why:</strong> ${escapeHtml(comp.rationale)}
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
        } else {
            html += `<div class="alert alert-info">${escapeHtml(String(hasAssessment))}</div>`;
        }
    } else {
        html += '<div class="alert alert-info">Click "Run AI Competency Assessment" to analyze this resource\'s competencies.</div>';
    }

    html += '</div>';

    return html;
}

function togglePromptEdit(promptType) {
    if (!wizardState.showPromptEdit) wizardState.showPromptEdit = {};
    wizardState.showPromptEdit[promptType] = !wizardState.showPromptEdit[promptType];
    renderTrainingPlans();
}

function savePromptEdit(promptType) {
    const textarea = document.getElementById(`promptText_${promptType}`);
    if (textarea) {
        wizardState.prompts[promptType] = textarea.value;
        wizardState.showPromptEdit[promptType] = false;
        renderTrainingPlans();
    }
}

function resetPrompt(promptType) {
    const defaults = {
        competencyAssessment: `You are an expert HR consultant specializing in technical competency assessment.
Analyze the provided job role and suggest relevant technical competencies with proficiency levels.
Return your response as a JSON array of objects with: name, category, currentLevel (1-5), rationale.
Be specific about why each competency is important for this role and how it contributes to their effectiveness.`,
        goalRecommendation: `You are a career development advisor. Based on the resource's current competencies and role,
suggest training goals that will help them advance in their career. Return JSON array with: competencyName,
targetLevel (1-5), priority (Critical/High/Medium/Low), rationale.
For each goal, explain WHY this particular competency is critical for their growth and how it will benefit their career trajectory.`,
        courseDiscovery: `You are a training course advisor. Search for and recommend training courses
that match the specified goals and constraints. Return JSON array with: title, provider, cost, duration,
url, format, skillLevel, relevanceScore (1-10), rationale.
For EACH course, provide a detailed rationale explaining:
1. How this specific course addresses the training goals
2. Why this course is superior to alternatives
3. What specific skills/knowledge the learner will gain
4. How it fits into their overall development journey
Be very specific and insightful in your recommendations.`
    };

    wizardState.prompts[promptType] = defaults[promptType];
    renderTrainingPlans();
}

async function runCompetencyAssessment() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return;

    const btn = document.getElementById('runAssessmentBtn');
    const btnText = document.getElementById('assessmentBtnText');

    btn.disabled = true;
    btnText.textContent = '‚è≥ Analyzing...';

    try {
        // Build current competencies context
        let currentCompetenciesContext = '';
        if (resource.currentCompetencies && resource.currentCompetencies.length > 0) {
            currentCompetenciesContext = '\n\nCurrent Competencies (already assessed):';
            resource.currentCompetencies.forEach(comp => {
                const competency = competencyLibrary.find(c => c.id === comp.competencyId);
                if (competency) {
                    const levelName = getLevelName(comp.level);
                    currentCompetenciesContext += `\n- ${competency.name} (${competency.category}): ${levelName} (Level ${comp.level}/5)`;
                }
            });
            currentCompetenciesContext += '\n\nPlease INCLUDE these existing competencies in your analysis and suggest additional relevant competencies not already listed.';
        }

        const userPrompt = `Analyze this role and suggest 5-8 key competencies:
Job Title: ${resource.jobTitle || 'Not specified'}
Department: ${resource.department || 'Not specified'}
Current Role: ${resource.name}
Location: ${resource.location || 'Not specified'}${currentCompetenciesContext}

Additional context: This is a technical role requiring assessment of relevant skills and competencies. Build upon their existing competencies where applicable.`;

        const response = await callClaudeAPI(wizardState.prompts.competencyAssessment, userPrompt);

        // Try to parse JSON response
        let parsedResponse;
        try {
            parsedResponse = JSON.parse(response);
        } catch (e) {
            // If not JSON, try to extract JSON from response
            const jsonMatch = response.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                parsedResponse = JSON.parse(jsonMatch[0]);
            } else {
                parsedResponse = response; // Store raw response
            }
        }

        wizardState.data.aiOutputs.competencyAssessment = parsedResponse;
        renderTrainingPlans();

    } catch (error) {
        alert(`AI Assessment Failed: ${error.message}`);
    } finally {
        btn.disabled = false;
        btnText.textContent = 'ü§ñ Run AI Competency Assessment';
    }
}

function renderWizardStep3() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return '<p>Resource not found</p>';

    const hasGoals = wizardState.data.aiOutputs.trainingGoals;
    const hasAssessment = wizardState.data.aiOutputs.competencyAssessment;

    let html = `
        <h3>Step 3: AI Training Goal Recommendations</h3>
        <p style="margin-bottom: 20px;">Get AI-powered recommendations for training goals that will advance ${resource.name}'s career.</p>

        ${!hasAssessment ? '<div class="alert alert-warning" style="margin-bottom: 20px;"><strong>Tip:</strong> Run the competency assessment in Step 2 first for better goal recommendations.</div>' : ''}
        ${!hasApiKey() ? '<div class="alert alert-warning" style="margin-bottom: 20px;"><strong>‚ö†Ô∏è API Key Required:</strong> Configure your AI API key in Settings to use AI features.</div>' : ''}

        <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">AI Prompt (Customizable)</h4>
                <button class="btn btn-ghost btn-sm" onclick="togglePromptEdit('goalRecommendation')" id="togglePromptBtn_goalRecommendation">
                    ${wizardState.showPromptEdit?.goalRecommendation ? 'Hide' : 'Edit Prompt'}
                </button>
            </div>
            <div id="promptView_goalRecommendation" style="${wizardState.showPromptEdit?.goalRecommendation ? 'display: none;' : ''}">
                <div style="font-size: 13px; color: var(--neutral-700); line-height: 1.6; white-space: pre-wrap; font-family: monospace; background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--neutral-200);">
                    ${escapeHtml(wizardState.prompts.goalRecommendation)}
                </div>
            </div>
            <div id="promptEdit_goalRecommendation" style="${wizardState.showPromptEdit?.goalRecommendation ? '' : 'display: none;'}">
                <textarea id="promptText_goalRecommendation" style="width: 100%; min-height: 150px; font-family: monospace; font-size: 13px; padding: 12px; border: 1px solid var(--neutral-300); border-radius: 4px; resize: vertical;">${escapeHtml(wizardState.prompts.goalRecommendation)}</textarea>
                <div style="margin-top: 8px; display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="savePromptEdit('goalRecommendation')">Save Prompt</button>
                    <button class="btn btn-ghost btn-sm" onclick="resetPrompt('goalRecommendation')">Reset to Default</button>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="runGoalRecommendations()" ${!hasApiKey() ? 'disabled' : ''} id="runGoalsBtn">
                <span id="goalsBtnText">ü§ñ Get AI Goal Recommendations</span>
            </button>
        </div>

        <div id="goalsResults" style="margin-top: 20px;">
    `;

    if (hasGoals) {
        html += '<div class="alert alert-success" style="margin-bottom: 16px;">‚úì AI Goal Recommendations Complete</div>';

        if (Array.isArray(hasGoals)) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-md); padding: 20px;">';
            html += '<h4 style="margin: 0 0 16px 0; font-size: 15px;">Recommended Training Goals</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            hasGoals.forEach(goal => {
                const priorityColor = {
                    'Critical': '#ef4444',
                    'High': '#f97316',
                    'Medium': '#f59e0b',
                    'Low': '#22c55e'
                }[goal.priority] || '#6b7280';
                html += `
                    <div style="border-left: 3px solid ${priorityColor}; padding-left: 12px; background: var(--neutral-50); padding: 12px; border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                            ${escapeHtml(goal.competencyName)}
                            <span style="font-size: 11px; padding: 2px 8px; background: ${priorityColor}; color: white; border-radius: 12px;">${goal.priority}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--neutral-700); margin-bottom: 4px;">
                            <strong>Target Level:</strong> ${goal.targetLevel}/5
                        </div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-style: italic;">
                            <strong>Why:</strong> ${escapeHtml(goal.rationale)}
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
        } else {
            html += `<div class="alert alert-info">${escapeHtml(String(hasGoals))}</div>`;
        }
    } else {
        html += '<div class="alert alert-info">Click "Get AI Goal Recommendations" to get personalized training goals.</div>';
    }

    html += '</div>';

    return html;
}

async function runGoalRecommendations() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return;

    const btn = document.getElementById('runGoalsBtn');
    const btnText = document.getElementById('goalsBtnText');

    btn.disabled = true;
    btnText.textContent = '‚è≥ Analyzing...';

    try {
        // Build comprehensive competency context
        let currentCompetenciesDetail = '';
        if (resource.currentCompetencies && resource.currentCompetencies.length > 0) {
            currentCompetenciesDetail = '\n\nCurrent Competencies:';
            resource.currentCompetencies.forEach(comp => {
                const competency = competencyLibrary.find(c => c.id === comp.competencyId);
                if (competency) {
                    const levelName = getLevelName(comp.level);
                    currentCompetenciesDetail += `\n- ${competency.name} (${competency.category}): ${levelName} (Level ${comp.level}/5)`;
                }
            });
        }

        let desiredCompetenciesDetail = '';
        if (resource.desiredCompetencies && resource.desiredCompetencies.length > 0) {
            desiredCompetenciesDetail = '\n\nAlready Desired Competencies (Goals):';
            resource.desiredCompetencies.forEach(comp => {
                const competency = competencyLibrary.find(c => c.id === comp.competencyId);
                if (competency) {
                    const targetLevelName = getLevelName(comp.targetLevel);
                    desiredCompetenciesDetail += `\n- ${competency.name}: Target Level ${comp.targetLevel}/5 (${targetLevelName})`;
                }
            });
        }

        // Include AI assessment if available
        let aiAssessmentContext = '';
        if (wizardState.data.aiOutputs.competencyAssessment) {
            aiAssessmentContext = '\n\nAI Competency Assessment Results:\n' + JSON.stringify(wizardState.data.aiOutputs.competencyAssessment, null, 2);
        }

        const userPrompt = `Suggest 3-5 training goals for:
Name: ${resource.name}
Title: ${resource.jobTitle || 'Not specified'}
Department: ${resource.department || 'Not specified'}
Location: ${resource.location || 'Not specified'}${currentCompetenciesDetail}${desiredCompetenciesDetail}${aiAssessmentContext}

Based on their current competencies and existing goals, suggest ambitious but achievable NEW training goals that will advance their career. Consider both deepening existing skills and acquiring complementary new competencies.`;

        const response = await callClaudeAPI(wizardState.prompts.goalRecommendation, userPrompt);

        // Try to parse JSON response
        let parsedResponse;
        try {
            parsedResponse = JSON.parse(response);
        } catch (e) {
            const jsonMatch = response.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                parsedResponse = JSON.parse(jsonMatch[0]);
            } else {
                parsedResponse = response;
            }
        }

        wizardState.data.aiOutputs.trainingGoals = parsedResponse;
        renderTrainingPlans();

    } catch (error) {
        alert(`AI Goal Recommendations Failed: ${error.message}`);
    } finally {
        btn.disabled = false;
        btnText.textContent = 'ü§ñ Get AI Goal Recommendations';
    }
}

function renderWizardStep4() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return '<p>Resource not found</p>';

    const hasCourses = wizardState.data.aiOutputs.courseRecommendations;
    const hasGoals = wizardState.data.aiOutputs.trainingGoals;

    let html = `
        <h3>Step 4: AI Course Discovery & Recommendations</h3>
        <p style="margin-bottom: 20px;">Get AI-powered course recommendations with detailed reasoning about WHY each course is valuable.</p>

        ${!hasGoals ? '<div class="alert alert-warning" style="margin-bottom: 20px;"><strong>Tip:</strong> Define training goals in Step 3 first for better course recommendations.</div>' : ''}
        ${!hasApiKey() ? '<div class="alert alert-warning" style="margin-bottom: 20px;"><strong>‚ö†Ô∏è API Key Required:</strong> Configure your AI API key in Settings to use AI features.</div>' : ''}

        <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">AI Prompt (Customizable)</h4>
                <button class="btn btn-ghost btn-sm" onclick="togglePromptEdit('courseDiscovery')" id="togglePromptBtn_courseDiscovery">
                    ${wizardState.showPromptEdit?.courseDiscovery ? 'Hide' : 'Edit Prompt'}
                </button>
            </div>
            <div id="promptView_courseDiscovery" style="${wizardState.showPromptEdit?.courseDiscovery ? 'display: none;' : ''}">
                <div style="font-size: 13px; color: var(--neutral-700); line-height: 1.6; white-space: pre-wrap; font-family: monospace; background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--neutral-200);">
                    ${escapeHtml(wizardState.prompts.courseDiscovery)}
                </div>
            </div>
            <div id="promptEdit_courseDiscovery" style="${wizardState.showPromptEdit?.courseDiscovery ? '' : 'display: none;'}">
                <textarea id="promptText_courseDiscovery" style="width: 100%; min-height: 200px; font-family: monospace; font-size: 13px; padding: 12px; border: 1px solid var(--neutral-300); border-radius: 4px; resize: vertical;">${escapeHtml(wizardState.prompts.courseDiscovery)}</textarea>
                <div style="margin-top: 8px; display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick="savePromptEdit('courseDiscovery')">Save Prompt</button>
                    <button class="btn btn-ghost btn-sm" onclick="resetPrompt('courseDiscovery')">Reset to Default</button>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="runCourseDiscovery()" ${!hasApiKey() ? 'disabled' : ''} id="runCoursesBtn">
                <span id="coursesBtnText">ü§ñ Discover Courses with AI</span>
            </button>
        </div>

        <div id="coursesResults" style="margin-top: 20px;">
    `;

    if (hasCourses) {
        html += '<div class="alert alert-success" style="margin-bottom: 16px;">‚úì AI Course Discovery Complete</div>';

        if (Array.isArray(hasCourses)) {
            html += '<div style="background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-md); padding: 20px;">';
            html += '<h4 style="margin: 0 0 16px 0; font-size: 15px;">AI-Recommended Courses</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 16px;">';
            hasCourses.forEach((course, idx) => {
                const relevancePercent = (course.relevanceScore || 0) * 10;
                const relevanceColor = relevancePercent >= 80 ? '#22c55e' : relevancePercent >= 60 ? '#f59e0b' : '#ef4444';
                html += `
                    <div style="border: 1px solid var(--neutral-200); padding: 16px; border-radius: var(--radius-md); background: var(--neutral-50);">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${idx + 1}. ${escapeHtml(course.title)}</div>
                                <div style="font-size: 13px; color: var(--neutral-700);">
                                    ${escapeHtml(course.provider || 'Unknown')} ‚Ä¢
                                    ${formatCurrency(course.cost || 0)} ‚Ä¢
                                    ${course.duration || 'Unknown duration'} ‚Ä¢
                                    ${escapeHtml(course.format || 'Unknown')}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 2px;">Relevance</div>
                                <div style="font-weight: 700; font-size: 18px; color: ${relevanceColor};">${relevancePercent}%</div>
                            </div>
                        </div>
                        <div style="background: #fffbeb; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 4px; margin-top: 8px;">
                            <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">üí° WHY THIS COURSE IS RECOMMENDED:</div>
                            <div style="font-size: 13px; color: #78350f; line-height: 1.5;">
                                ${escapeHtml(course.rationale || 'This course aligns with the training goals and helps develop required competencies.')}
                            </div>
                        </div>
                        ${course.url ? `<div style="margin-top: 8px;"><a href="${escapeHtml(course.url)}" target="_blank" style="font-size: 13px; color: var(--primary-color); text-decoration: none;">üîó View Course Details ‚Üí</a></div>` : ''}
                    </div>
                `;
            });
            html += '</div></div>';
        } else {
            html += `<div class="alert alert-info">${escapeHtml(String(hasCourses))}</div>`;
        }
    } else {
        html += '<div class="alert alert-info">Click "Discover Courses with AI" to get personalized course recommendations with detailed rationale.</div>';
    }

    html += '</div>';

    return html;
}

async function runCourseDiscovery() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return;

    const btn = document.getElementById('runCoursesBtn');
    const btnText = document.getElementById('coursesBtnText');

    btn.disabled = true;
    btnText.textContent = '‚è≥ Discovering Courses...';

    try {
        const goals = wizardState.data.aiOutputs.trainingGoals || [];

        // Build competency context for course recommendations
        let currentCompetenciesContext = '';
        if (resource.currentCompetencies && resource.currentCompetencies.length > 0) {
            currentCompetenciesContext = '\n\nCurrent Competencies:';
            resource.currentCompetencies.forEach(comp => {
                const competency = competencyLibrary.find(c => c.id === comp.competencyId);
                if (competency) {
                    const levelName = getLevelName(comp.level);
                    currentCompetenciesContext += `\n- ${competency.name} (${competency.category}): ${levelName} (Level ${comp.level}/5)`;
                }
            });
        }

        let desiredCompetenciesContext = '';
        if (resource.desiredCompetencies && resource.desiredCompetencies.length > 0) {
            desiredCompetenciesContext = '\n\nDesired Competencies / Goals:';
            resource.desiredCompetencies.forEach(comp => {
                const competency = competencyLibrary.find(c => c.id === comp.competencyId);
                if (competency) {
                    const currentComp = resource.currentCompetencies.find(cc => cc.competencyId === comp.competencyId);
                    const currentLevel = currentComp ? currentComp.level : 0;
                    const targetLevelName = getLevelName(comp.targetLevel);
                    desiredCompetenciesContext += `\n- ${competency.name}: From Level ${currentLevel} ‚Üí ${comp.targetLevel} (${targetLevelName})`;
                }
            });
        }

        const userPrompt = `Find and recommend 4-6 high-quality training courses for:

Resource: ${resource.name} (${resource.jobTitle || 'No title'})
Department: ${resource.department || 'Not specified'}
Location: ${resource.location || 'Remote'}
Budget: ${formatCurrency(resource.annualTrainingBudget || 5000)}${currentCompetenciesContext}${desiredCompetenciesContext}

Training Goals: ${JSON.stringify(goals, null, 2)}

For EACH course, provide:
1. A detailed explanation of HOW this course addresses the specific training goals
2. WHY this course is the best choice compared to alternatives
3. WHAT specific skills and knowledge the learner will gain
4. HOW it fits into their overall career development journey
5. How it builds upon their CURRENT competencies to reach their DESIRED competency levels

Be very specific and insightful. Focus on the VALUE and IMPACT of each course. Ensure courses are appropriate for their current skill level and will help them reach their goals.`;

        const response = await callClaudeAPI(wizardState.prompts.courseDiscovery, userPrompt);

        // Try to parse JSON response
        let parsedResponse;
        try {
            parsedResponse = JSON.parse(response);
        } catch (e) {
            const jsonMatch = response.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                parsedResponse = JSON.parse(jsonMatch[0]);
            } else {
                parsedResponse = response;
            }
        }

        wizardState.data.aiOutputs.courseRecommendations = parsedResponse;
        wizardState.data.selectedCourses = parsedResponse; // Also save to selectedCourses
        renderTrainingPlans();

    } catch (error) {
        alert(`AI Course Discovery Failed: ${error.message}`);
    } finally {
        btn.disabled = false;
        btnText.textContent = 'ü§ñ Discover Courses with AI';
    }
}

function renderWizardStep5() {
    return `
        <h3>Schedule Training</h3>
        <p>Optimize the training schedule based on availability and constraints.</p>

        <div class="alert alert-info">
            <strong>AI Schedule Optimization:</strong> Let AI create an optimal schedule considering holidays, workload, and learning pace.
        </div>

        <div style="margin-top: 20px;">
            <p>Proceed to review the complete training plan.</p>
        </div>
    `;
}

function renderWizardStep6() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return '<p>Resource not found</p>';

    const hasAssessment = wizardState.data.aiOutputs.competencyAssessment;
    const hasGoals = wizardState.data.aiOutputs.trainingGoals;
    const hasCourses = wizardState.data.aiOutputs.courseRecommendations;

    // Calculate estimated budgets from courses
    let estimatedTrainingBudget = 0;
    let estimatedTravelBudget = 0;
    if (Array.isArray(hasCourses)) {
        estimatedTrainingBudget = hasCourses.reduce((sum, course) => sum + (course.cost || 0), 0);
        estimatedTravelBudget = hasCourses.reduce((sum, course) => {
            const requiresTravel = course.requiresTravel || false;
            const travelCost = requiresTravel ? (course.estimatedTravelCost || 0) : 0;
            return sum + travelCost;
        }, 0);
    }

    // Calculate training budget availability
    const totalTrainingBudget = resource.annualTrainingBudget || 0;
    const spentTrainingBudget = resource.budgetSpent || 0;
    const existingPlans = trainingPlans.filter(p => p.resourceId === resource.id);
    const committedTrainingBudget = existingPlans.reduce((sum, plan) => sum + (plan.totalCost || 0), 0);
    const availableTrainingBudget = totalTrainingBudget - spentTrainingBudget - committedTrainingBudget;
    const trainingBudgetAfterPlan = availableTrainingBudget - estimatedTrainingBudget;
    const trainingBudgetOverrun = trainingBudgetAfterPlan < 0;

    // Calculate travel budget availability
    const totalTravelBudget = resource.annualTravelBudget || 0;
    const spentTravelBudget = resource.travelBudgetSpent || 0;
    const committedTravelBudget = existingPlans.reduce((sum, plan) => sum + (plan.totalTravelCost || 0), 0);
    const availableTravelBudget = totalTravelBudget - spentTravelBudget - committedTravelBudget;
    const travelBudgetAfterPlan = availableTravelBudget - estimatedTravelBudget;
    const travelBudgetOverrun = travelBudgetAfterPlan < 0;

    // Overall budget status
    const budgetOverrun = trainingBudgetOverrun || travelBudgetOverrun;

    // Calculate estimated time from courses
    let estimatedHours = 0;
    if (Array.isArray(hasCourses)) {
        hasCourses.forEach(course => {
            const duration = course.duration || '';
            const hoursMatch = duration.match(/(\d+)\s*(?:hour|hr)/i);
            if (hoursMatch) {
                estimatedHours += parseInt(hoursMatch[1]);
            }
        });
    }

    const weeklyHours = resource.weeklyTrainingHours || 0;
    const estimatedWeeks = weeklyHours > 0 ? Math.ceil(estimatedHours / weeklyHours) : 0;
    const timeWarning = estimatedWeeks > 52; // More than a year

    let html = `
        <h3>Step 6: Review & Finalize Training Plan</h3>
        <p style="margin-bottom: 20px;">Review all AI recommendations before creating the training plan for ${resource.name}.</p>

        <div style="background: white; border: 2px solid var(--primary-color); padding: 20px; border-radius: var(--radius-lg); margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; color: var(--primary-color);">Plan Overview</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                    <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Resource</div>
                    <div style="font-weight: 600;">${escapeHtml(resource.name)}</div>
                    <div style="font-size: 13px; color: var(--neutral-600);">${escapeHtml(resource.jobTitle || 'No title')}</div>
                    ${resource.canAttendInPerson === false ? '<div style="font-size: 12px; color: #f59e0b; margin-top: 4px;">‚ö†Ô∏è Remote Only</div>' : ''}
                </div>
                <div>
                    <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Training Budget</div>
                    <div style="font-weight: 600; font-size: 18px; color: var(--primary-color);">${formatCurrency(totalTrainingBudget)}</div>
                    <div style="font-size: 12px; color: var(--neutral-600);">Spent: ${formatCurrency(spentTrainingBudget)} | Committed: ${formatCurrency(committedTrainingBudget)}</div>
                </div>
                <div>
                    <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Available Training Budget</div>
                    <div style="font-weight: 600; font-size: 18px; color: ${trainingBudgetOverrun ? '#ef4444' : '#22c55e'};">${formatCurrency(availableTrainingBudget)}</div>
                    <div style="font-size: 12px; color: var(--neutral-600);">After plan: ${formatCurrency(trainingBudgetAfterPlan)}</div>
                </div>
                <div>
                    <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Plan Training Cost</div>
                    <div style="font-weight: 600; font-size: 18px; ${trainingBudgetOverrun ? 'color: #ef4444;' : 'color: #22c55e;'}">${formatCurrency(estimatedTrainingBudget)}</div>
                    <div style="font-size: 12px; color: var(--neutral-600);">${hasCourses && Array.isArray(hasCourses) ? hasCourses.length : 0} courses</div>
                </div>
            </div>
            ${estimatedTravelBudget > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--neutral-200);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Travel & Expense Budget</div>
                            <div style="font-weight: 600; font-size: 18px; color: var(--primary-color);">${formatCurrency(totalTravelBudget)}</div>
                            <div style="font-size: 12px; color: var(--neutral-600);">Spent: ${formatCurrency(spentTravelBudget)} | Committed: ${formatCurrency(committedTravelBudget)}</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Available Travel Budget</div>
                            <div style="font-weight: 600; font-size: 18px; color: ${travelBudgetOverrun ? '#ef4444' : '#22c55e'};">${formatCurrency(availableTravelBudget)}</div>
                            <div style="font-size: 12px; color: var(--neutral-600);">After plan: ${formatCurrency(travelBudgetAfterPlan)}</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Plan Travel Cost</div>
                            <div style="font-weight: 600; font-size: 18px; ${travelBudgetOverrun ? 'color: #ef4444;' : 'color: #22c55e;'}">${formatCurrency(estimatedTravelBudget)}</div>
                            <div style="font-size: 12px; color: var(--neutral-600);">For in-person courses</div>
                        </div>
                    </div>
                </div>
            ` : ''}
            ${estimatedHours > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--neutral-200);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Estimated Time</div>
                            <div style="font-weight: 600;">${estimatedHours} hours total</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Weekly Allocation</div>
                            <div style="font-weight: 600;">${weeklyHours} hours/week</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">Duration</div>
                            <div style="font-weight: 600; ${timeWarning ? 'color: #f59e0b;' : ''}">${estimatedWeeks > 0 ? `~${estimatedWeeks} weeks` : 'Unknown'}</div>
                        </div>
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">AI Status</div>
                            <div style="font-weight: 600; color: ${hasAssessment && hasGoals && hasCourses ? '#22c55e' : '#f59e0b'};">
                                ${hasAssessment && hasGoals && hasCourses ? '‚úì Fully AI-Assisted' : '‚ö†Ô∏è Partial AI Data'}
                            </div>
                        </div>
                    </div>
                </div>
            ` : `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--neutral-200);">
                    <div style="display: grid; grid-template-columns: 1fr;">
                        <div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 4px;">AI Status</div>
                            <div style="font-weight: 600; color: ${hasAssessment && hasGoals && hasCourses ? '#22c55e' : '#f59e0b'};">
                                ${hasAssessment && hasGoals && hasCourses ? '‚úì Fully AI-Assisted' : '‚ö†Ô∏è Partial AI Data'}
                            </div>
                        </div>
                    </div>
                </div>
            `}
        </div>

        ${trainingBudgetOverrun ? `
            <div class="alert alert-warning" style="margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Training Budget Overrun:</strong> This plan costs ${formatCurrency(estimatedTrainingBudget)} for training, but only ${formatCurrency(availableTrainingBudget)} is available (${formatCurrency(spentTrainingBudget)} already spent, ${formatCurrency(committedTrainingBudget)} committed to other plans). You will exceed the annual training budget by ${formatCurrency(Math.abs(trainingBudgetAfterPlan))}.
            </div>
        ` : ''}

        ${travelBudgetOverrun ? `
            <div class="alert alert-warning" style="margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Travel Budget Overrun:</strong> This plan costs ${formatCurrency(estimatedTravelBudget)} for travel & expenses, but only ${formatCurrency(availableTravelBudget)} is available (${formatCurrency(spentTravelBudget)} already spent, ${formatCurrency(committedTravelBudget)} committed to other plans). You will exceed the annual travel budget by ${formatCurrency(Math.abs(travelBudgetAfterPlan))}.
            </div>
        ` : ''}

        ${resource.canAttendInPerson === false && hasCourses && Array.isArray(hasCourses) && hasCourses.some(c => c.format === 'In-Person' || c.format === 'Hybrid') ? `
            <div class="alert alert-warning" style="margin-bottom: 20px;">
                <strong>‚ö†Ô∏è In-Person Course Warning:</strong> ${escapeHtml(resource.name)} is marked as unable to attend in-person classes, but this plan includes in-person or hybrid courses. Please verify the resource's availability or select alternative online courses.
            </div>
        ` : ''}

        ${timeWarning ? `
            <div class="alert alert-warning" style="margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Time Alert:</strong> With ${estimatedHours} hours of training and ${weeklyHours} hours/week available, this plan will take approximately ${estimatedWeeks} weeks (over 1 year). Consider adjusting the course selection or weekly time allocation.
            </div>
        ` : ''}
    `;

    // AI Competency Assessment Review
    if (hasAssessment && Array.isArray(hasAssessment)) {
        html += `
            <div style="margin-bottom: 24px;">
                <h4 style="margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>‚úì</span> Competency Assessment (${hasAssessment.length} identified)
                </h4>
                <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); border-left: 3px solid var(--secondary-color);">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${hasAssessment.map(c => `<span class="badge badge-secondary">${escapeHtml(c.name)} (${c.currentLevel}/5)</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    // AI Training Goals Review
    if (hasGoals && Array.isArray(hasGoals)) {
        html += `
            <div style="margin-bottom: 24px;">
                <h4 style="margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>‚úì</span> Training Goals (${hasGoals.length} goals)
                </h4>
                <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); border-left: 3px solid #f59e0b;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${hasGoals.map(g => {
                            const priorityColor = {
                                'Critical': '#ef4444',
                                'High': '#f97316',
                                'Medium': '#f59e0b',
                                'Low': '#22c55e'
                            }[g.priority] || '#6b7280';
                            return `<div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                <span style="font-size: 11px; padding: 2px 8px; background: ${priorityColor}; color: white; border-radius: 12px; min-width: 60px; text-align: center;">${g.priority}</span>
                                <span style="font-weight: 600;">${escapeHtml(g.competencyName)}</span>
                                <span style="color: var(--neutral-600);">‚Üí Level ${g.targetLevel}/5</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    // AI Course Recommendations Review
    if (hasCourses && Array.isArray(hasCourses)) {
        html += `
            <div style="margin-bottom: 24px;">
                <h4 style="margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>‚úì</span> Recommended Courses (${hasCourses.length} courses)
                </h4>
                <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md); border-left: 3px solid var(--primary-color);">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${hasCourses.map((course, idx) => {
                            const relevancePercent = (course.relevanceScore || 0) * 10;
                            return `<div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid var(--neutral-200);">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">${idx + 1}. ${escapeHtml(course.title)}</div>
                                        <div style="font-size: 13px; color: var(--neutral-700);">
                                            ${escapeHtml(course.provider || 'Unknown')} ‚Ä¢ ${formatCurrency(course.cost || 0)} ‚Ä¢ ${course.duration || 'Unknown'}
                                        </div>
                                    </div>
                                    <div style="font-weight: 700; color: ${relevancePercent >= 80 ? '#22c55e' : '#f59e0b'}; font-size: 16px;">
                                        ${relevancePercent}%
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    // Warnings if missing AI data
    if (!hasAssessment || !hasGoals || !hasCourses) {
        html += '<div class="alert alert-info" style="margin-bottom: 20px;">';
        html += '<strong>Note:</strong> Some AI features were not used. ';
        if (!hasAssessment) html += 'No competency assessment. ';
        if (!hasGoals) html += 'No training goals. ';
        if (!hasCourses) html += 'No course recommendations. ';
        html += 'You can go back to complete these steps for better results.';
        html += '</div>';
    }

    html += `
        <div class="alert alert-success" style="margin-top: 24px;">
            <strong>Ready to Create!</strong> Click "Finish" below to create this AI-assisted training plan.
            All recommendations and insights will be saved with the plan.
        </div>
    `;

    return html;
}

function wizardNextStep() {
    if (wizardState.currentStep === 1 && !wizardState.data.resourceId) {
        alert('Please select a resource');
        return;
    }

    if (wizardState.currentStep < wizardState.totalSteps) {
        wizardState.currentStep++;
        renderTrainingPlans();
    }
}

function wizardPreviousStep() {
    if (wizardState.currentStep > 1) {
        wizardState.currentStep--;
        renderTrainingPlans();
    }
}

function wizardCancel() {
    if (confirm('Are you sure you want to cancel? Progress will be lost.')) {
        wizardState.active = false;
        renderTrainingPlans();
    }
}

function wizardFinish() {
    const resource = resources.find(r => r.id === wizardState.data.resourceId);
    if (!resource) return;

    // Calculate estimated budgets from courses
    let estimatedBudget = 0;
    let estimatedTravelBudget = 0;
    const courses = wizardState.data.aiOutputs.courseRecommendations || [];
    if (Array.isArray(courses)) {
        estimatedBudget = courses.reduce((sum, course) => sum + (course.cost || 0), 0);
        estimatedTravelBudget = courses.reduce((sum, course) => {
            // Check if course requires travel
            const requiresTravel = course.requiresTravel || false;
            const travelCost = requiresTravel ? (course.estimatedTravelCost || 0) : 0;
            return sum + travelCost;
        }, 0);
    }

    // Build scheduled courses array with proper structure
    const scheduledCourses = [];
    if (Array.isArray(courses)) {
        courses.forEach(course => {
            scheduledCourses.push({
                title: course.title || 'Unknown Course',
                provider: course.provider || 'Unknown Provider',
                cost: course.cost || 0,
                duration: course.duration || 'Unknown',
                format: course.format || 'Unknown',
                url: course.url || '',
                requiresTravel: course.requiresTravel || false,
                estimatedTravelCost: course.estimatedTravelCost || 0,
                startDate: new Date().toISOString().split('T')[0],
                status: 'Planned',
                relevanceScore: course.relevanceScore || 0,
                rationale: course.rationale || ''
            });
        });
    }

    // Build primary objective from goals
    let primaryObjective = 'Skill development and career growth';
    const goals = wizardState.data.aiOutputs.trainingGoals;
    if (Array.isArray(goals) && goals.length > 0) {
        const criticalGoals = goals.filter(g => g.priority === 'Critical');
        if (criticalGoals.length > 0) {
            primaryObjective = `Develop ${criticalGoals.map(g => g.competencyName).join(', ')} to advance career progression`;
        }
    }

    const newPlan = {
        id: nextPlanId++,
        resourceId: resource.id,
        planName: `${resource.name} Training Plan ${new Date().getFullYear()}`,
        planDescription: `AI-assisted training plan${Array.isArray(goals) && goals.length > 0 ? ` focusing on ${goals.length} key development goal${goals.length > 1 ? 's' : ''}` : ''}`,
        planPeriod: {
            startDate: new Date().toISOString().split('T')[0],
            endDate: new Date(Date.now() + 180*24*60*60*1000).toISOString().split('T')[0]
        },
        primaryObjective: primaryObjective,
        desiredOutcomes: Array.isArray(goals) ? goals.map(g => `Achieve ${g.competencyName} at level ${g.targetLevel}/5`) : [],
        successMetrics: Array.isArray(goals) ? goals.map(g => `${g.competencyName} proficiency improvement`) : [],
        allocatedBudget: resource.annualTrainingBudget || 0,
        projectedSpend: estimatedBudget,
        contingencyBuffer: Math.max(0, (resource.annualTrainingBudget || 0) - estimatedBudget),
        totalCost: estimatedBudget,
        totalTravelCost: estimatedTravelBudget,
        scheduledCourses: scheduledCourses,
        gapAnalysis: {
            criticalGaps: Array.isArray(goals) ? goals.filter(g => g.priority === 'Critical').map(g => g.competencyName) : [],
            levelGaps: Array.isArray(goals) ? goals.map(g => ({competency: g.competencyName, targetLevel: g.targetLevel})) : [],
            estimatedTimeToClose: scheduledCourses.length > 0 ? 180 : 0
        },
        aiRecommendations: {
            competencyAssessment: wizardState.data.aiOutputs.competencyAssessment || null,
            trainingGoals: wizardState.data.aiOutputs.trainingGoals || null,
            courseRecommendations: wizardState.data.aiOutputs.courseRecommendations || null
        },
        status: 'Draft',
        approvedDate: null,
        approvedBy: null,
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        version: 1
    };

    trainingPlans.push(newPlan);
    wizardState.active = false;
    triggerSave();
    renderTrainingPlans();

    // Show success message with plan summary
    const hasAI = (wizardState.data.aiOutputs.competencyAssessment || wizardState.data.aiOutputs.trainingGoals || wizardState.data.aiOutputs.courseRecommendations);

    openModal('Training Plan Created Successfully', `
        <div class="alert alert-success" style="margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">‚úì Training Plan Created!</div>
            <div>Successfully created training plan for ${escapeHtml(resource.name)}</div>
        </div>

        <div style="background: var(--neutral-50); padding: 16px; border-radius: var(--radius-md);">
            <h4 style="margin: 0 0 12px 0; font-size: 15px;">Plan Summary</h4>
            <div style="display: grid; gap: 8px; font-size: 14px;">
                <div><strong>Courses:</strong> ${scheduledCourses.length} scheduled</div>
                <div><strong>Estimated Cost:</strong> ${formatCurrency(estimatedBudget)}</div>
                <div><strong>Budget Remaining:</strong> ${formatCurrency(Math.max(0, (resource.annualTrainingBudget || 0) - estimatedBudget))}</div>
                <div><strong>AI-Assisted:</strong> ${hasAI ? '‚úì Yes' : 'No'}</div>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-primary" onclick="closeModal(); viewPlanDetails(${newPlan.id});">View Plan Details</button>
        </div>
    `);
}

// === CALENDARS (TAB 6) ===
function renderCalendars() {
    const content = document.getElementById('calendarsContent');

    const html = `
        <div class="card-header mb-2">
            <h2 class="card-title">Regional Calendars</h2>
            <button class="btn btn-primary" onclick="showAddCalendarForm()">+ Add Calendar</button>
        </div>

        <div id="calendarsList">
            ${renderCalendarsList()}
        </div>
    `;

    content.innerHTML = html;
}

function renderCalendarsList() {
    if (regionalCalendars.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <div class="empty-state-title">No Calendars Yet</div>
            <div class="empty-state-description">Add regional calendars to track holidays and plan training schedules.</div>
            <button class="btn btn-primary" onclick="showAddCalendarForm()">+ Add Calendar</button>
        </div>`;
    }

    let html = '<div class="table-container"><table><thead><tr>';
    html += '<th>Name</th><th>Region</th><th>Year</th><th>Holidays</th><th>Used By</th><th>Actions</th>';
    html += '</tr></thead><tbody>';

    regionalCalendars.forEach(cal => {
        const useCount = resources.filter(r => {
            // Handle both old single ID and new array format
            if (r.regionalCalendarIds && Array.isArray(r.regionalCalendarIds)) {
                return r.regionalCalendarIds.includes(cal.id);
            }
            // Legacy support for old format
            return r.regionalCalendarId === cal.id;
        }).length;

        html += `
            <tr>
                <td><strong>${escapeHtml(cal.name)}</strong></td>
                <td>${escapeHtml(cal.region)}</td>
                <td>${cal.year}</td>
                <td>${cal.holidays?.length || 0}</td>
                <td>${useCount} resources</td>
                <td class="table-actions">
                    <button class="btn btn-sm btn-ghost" onclick="viewCalendarDetail(${cal.id})">View</button>
                    <button class="btn btn-sm btn-ghost" onclick="deleteCalendar(${cal.id})">Delete</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function showAddCalendarForm() {
    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Name</label>
            <input type="text" class="form-input" id="newCalName" placeholder="US Federal Holidays">
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label">Region</label>
                <input type="text" class="form-input" id="newCalRegion" placeholder="US">
            </div>

            <div class="form-group">
                <label class="form-label">Year</label>
                <input type="number" class="form-input" id="newCalYear" value="${new Date().getFullYear()}" min="2020">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="newCalDescription" placeholder="Calendar description..."></textarea>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewCalendar()">Add Calendar</button>
    `;

    openModal('Add New Calendar', html, footer);
}

function saveNewCalendar() {
    const name = document.getElementById('newCalName').value.trim();
    if (!name) {
        alert('Please enter a name');
        return;
    }

    const newCal = {
        id: nextCalendarId++,
        name: name,
        region: document.getElementById('newCalRegion').value.trim() || 'Custom',
        description: document.getElementById('newCalDescription').value.trim(),
        year: parseInt(document.getElementById('newCalYear').value) || new Date().getFullYear(),
        holidays: [],
        isTemplate: false,
        useCount: 0,
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };

    regionalCalendars.push(newCal);
    closeModal();
    triggerSave();
    renderCalendars();
}

function viewCalendarDetail(calendarId) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal) return;

    // Get resources using this calendar
    const assignedResources = resources.filter(r => {
        // Handle both old single ID and new array format
        if (r.regionalCalendarIds && Array.isArray(r.regionalCalendarIds)) {
            return r.regionalCalendarIds.includes(calendarId);
        }
        // Legacy support for old format
        return r.regionalCalendarId === calendarId;
    });

    let resourcesHtml = '';
    if (assignedResources.length === 0) {
        resourcesHtml = '<p style="color: var(--text-muted); font-style: italic;">No resources assigned to this calendar</p>';
    } else {
        resourcesHtml = '<div class="table-container" style="margin-top: 16px;"><table><thead><tr><th>Name</th><th>Title</th><th>Location</th><th>Actions</th></tr></thead><tbody>';
        assignedResources.forEach(res => {
            resourcesHtml += `
                <tr>
                    <td><strong>${escapeHtml(res.name)}</strong></td>
                    <td>${escapeHtml(res.jobTitle || '-')}</td>
                    <td>${escapeHtml(res.location || '-')}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-ghost" onclick="closeModal(); switchTab(2); setTimeout(() => viewResourceDetail(${res.id}), 100)">View</button>
                    </td>
                </tr>`;
        });
        resourcesHtml += '</tbody></table></div>';
    }

    // Build holidays table
    let holidaysHtml = '';
    if (!cal.holidays || cal.holidays.length === 0) {
        holidaysHtml = '<p style="color: var(--text-muted); font-style: italic;">No holidays defined</p>';
    } else {
        // Sort holidays by date
        const sortedHolidays = [...cal.holidays].sort((a, b) => new Date(a.date) - new Date(b.date));

        holidaysHtml = '<div class="table-container"><table><thead><tr><th>Date</th><th>Holiday Name</th><th>Type</th><th>Recurring</th></tr></thead><tbody>';
        sortedHolidays.forEach(holiday => {
            const formattedDate = formatDate(holiday.date);
            const recurringBadge = holiday.isRecurring
                ? `<span class="badge badge-info" style="font-size: 11px;" title="${escapeHtml(holiday.recurringRule || '')}">Recurring</span>`
                : '<span class="badge badge-secondary" style="font-size: 11px;">One-time</span>';

            holidaysHtml += `
                <tr>
                    <td><strong>${formattedDate}</strong></td>
                    <td>${escapeHtml(holiday.name)}</td>
                    <td>${escapeHtml(holiday.type || 'Public')}</td>
                    <td>${recurringBadge}</td>
                </tr>`;
        });
        holidaysHtml += '</tbody></table></div>';
    }

    const html = `
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <!-- Calendar Info -->
            <div class="card" style="background: var(--neutral-50);">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-color);">Calendar Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                    <div><strong>Name:</strong> ${escapeHtml(cal.name)}</div>
                    <div><strong>Region:</strong> ${escapeHtml(cal.region)}</div>
                    <div><strong>Year:</strong> ${cal.year}</div>
                    <div><strong>Holidays:</strong> ${cal.holidays?.length || 0}</div>
                    <div style="grid-column: 1 / -1;"><strong>Description:</strong> ${escapeHtml(cal.description || 'No description')}</div>
                </div>
            </div>

            <!-- Holidays Section -->
            <div>
                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: var(--primary-color);">Holidays (${cal.holidays?.length || 0})</h3>
                ${holidaysHtml}
            </div>

            <!-- Assigned Resources Section -->
            <div>
                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: var(--primary-color);">Assigned Resources (${assignedResources.length})</h3>
                ${resourcesHtml}
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-primary" onclick="editCalendar(${calendarId})">Edit Calendar</button>
        <button class="btn btn-error" onclick="deleteCalendar(${calendarId})">Delete</button>
    `;

    openModal(`Calendar: ${cal.name}`, html, footer, 'modal-large');
}

function editCalendar(calendarId) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal) return;

    // Ensure holidays array exists
    if (!cal.holidays) {
        cal.holidays = [];
    }

    // Build holidays table for editing
    let holidaysTableHtml = '';
    if (cal.holidays.length === 0) {
        holidaysTableHtml = '<p style="color: var(--text-muted); font-style: italic; margin: 12px 0;">No holidays defined yet. Click "Add Holiday" to get started.</p>';
    } else {
        // Sort holidays by date
        const sortedHolidays = [...cal.holidays].sort((a, b) => new Date(a.date) - new Date(b.date));

        holidaysTableHtml = '<div class="table-container"><table><thead><tr><th>Date</th><th>Holiday Name</th><th>Type</th><th>Recurring</th><th style="width: 100px;">Actions</th></tr></thead><tbody>';
        sortedHolidays.forEach((holiday, index) => {
            const originalIndex = cal.holidays.indexOf(holiday);
            const formattedDate = formatDate(holiday.date);
            const recurringText = holiday.isRecurring ? 'Yes' : 'No';

            holidaysTableHtml += `
                <tr>
                    <td>${formattedDate}</td>
                    <td><strong>${escapeHtml(holiday.name)}</strong></td>
                    <td>${escapeHtml(holiday.type || 'Public')}</td>
                    <td>${recurringText}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-ghost" onclick="editHoliday(${calendarId}, ${originalIndex})" title="Edit">Edit</button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteHoliday(${calendarId}, ${originalIndex})" title="Delete">‚úï</button>
                    </td>
                </tr>`;
        });
        holidaysTableHtml += '</tbody></table></div>';
    }

    const html = `
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <!-- Calendar Metadata -->
            <div class="card" style="background: var(--neutral-50);">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--primary-color);">Calendar Information</h3>

                <div class="form-group">
                    <label class="form-label form-label-required">Calendar Name</label>
                    <input type="text" class="form-input" id="editCalName" value="${escapeHtml(cal.name)}" placeholder="US Federal Holidays">
                </div>

                <div class="form-inline">
                    <div class="form-group">
                        <label class="form-label">Region</label>
                        <input type="text" class="form-input" id="editCalRegion" value="${escapeHtml(cal.region)}" placeholder="US">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Year</label>
                        <input type="number" class="form-input" id="editCalYear" value="${cal.year}" min="2020">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="editCalDescription" placeholder="Calendar description...">${escapeHtml(cal.description || '')}</textarea>
                </div>
            </div>

            <!-- Holidays Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--primary-color);">Holidays (${cal.holidays.length})</h3>
                    <button class="btn btn-sm btn-primary" onclick="addHoliday(${calendarId})">+ Add Holiday</button>
                </div>
                <div id="holidaysTableContainer">
                    ${holidaysTableHtml}
                </div>
            </div>
        </div>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="viewCalendarDetail(${calendarId})">Cancel</button>
        <button class="btn btn-primary" onclick="saveCalendarEdits(${calendarId})">Save Changes</button>
    `;

    openModal(`Edit Calendar: ${cal.name}`, html, footer, 'modal-large');
}

function saveCalendarEdits(calendarId) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal) return;

    const name = document.getElementById('editCalName').value.trim();
    if (!name) {
        alert('Please enter a calendar name');
        return;
    }

    // Update calendar metadata
    cal.name = name;
    cal.region = document.getElementById('editCalRegion').value.trim() || 'Custom';
    cal.year = parseInt(document.getElementById('editCalYear').value) || new Date().getFullYear();
    cal.description = document.getElementById('editCalDescription').value.trim();
    cal.lastModified = new Date().toISOString();

    triggerSave();
    renderCalendars();
    viewCalendarDetail(calendarId);
}

function addHoliday(calendarId) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal) return;

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Holiday Name</label>
            <input type="text" class="form-input" id="newHolidayName" placeholder="New Year's Day" autofocus>
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label form-label-required">Date</label>
                <input type="date" class="form-input" id="newHolidayDate" value="${cal.year}-01-01">
            </div>

            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-input" id="newHolidayType">
                    <option value="Public">Public Holiday</option>
                    <option value="Corporate">Corporate Event</option>
                    <option value="Training">Training Blackout</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="newHolidayRecurring" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
                <span style="vertical-align: middle;">Recurring Holiday</span>
            </label>
            <div class="form-help">Check if this holiday repeats annually (e.g., Christmas, New Year)</div>
        </div>

        <div class="form-group" id="recurringRuleGroup" style="display: none;">
            <label class="form-label">Recurring Rule</label>
            <input type="text" class="form-input" id="newHolidayRecurringRule" placeholder="e.g., Fourth Thursday of November">
            <div class="form-help">Describe when this holiday occurs each year</div>
        </div>

        <script>
            document.getElementById('newHolidayRecurring').addEventListener('change', function(e) {
                document.getElementById('recurringRuleGroup').style.display = e.target.checked ? 'block' : 'none';
            });
        <\/script>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal(); editCalendar(${calendarId})">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewHoliday(${calendarId})">Add Holiday</button>
    `;

    openModal('Add Holiday', html, footer);
}

function saveNewHoliday(calendarId) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal) return;

    const name = document.getElementById('newHolidayName').value.trim();
    const date = document.getElementById('newHolidayDate').value;

    if (!name) {
        alert('Please enter a holiday name');
        return;
    }

    if (!date) {
        alert('Please select a date');
        return;
    }

    const isRecurring = document.getElementById('newHolidayRecurring').checked;
    const recurringRule = isRecurring ? document.getElementById('newHolidayRecurringRule').value.trim() : '';

    const newHoliday = {
        date: date,
        name: name,
        type: document.getElementById('newHolidayType').value,
        isRecurring: isRecurring,
        recurringRule: recurringRule
    };

    if (!cal.holidays) {
        cal.holidays = [];
    }

    cal.holidays.push(newHoliday);
    cal.lastModified = new Date().toISOString();

    triggerSave();
    renderCalendars();
    closeModal();
    editCalendar(calendarId);
}

function editHoliday(calendarId, holidayIndex) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal || !cal.holidays || !cal.holidays[holidayIndex]) return;

    const holiday = cal.holidays[holidayIndex];

    // Ensure date is in yyyy-MM-dd format
    let dateValue = '';
    if (holiday.date) {
        // If date is ISO format (with time), extract just the date part
        dateValue = holiday.date.split('T')[0];
    }

    const html = `
        <div class="form-group">
            <label class="form-label form-label-required">Holiday Name</label>
            <input type="text" class="form-input" id="editHolidayName" value="${escapeHtml(holiday.name)}" placeholder="New Year's Day" autofocus>
        </div>

        <div class="form-inline">
            <div class="form-group">
                <label class="form-label form-label-required">Date</label>
                <input type="date" class="form-input" id="editHolidayDate" value="${dateValue}">
            </div>

            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-input" id="editHolidayType">
                    <option value="Public" ${holiday.type === 'Public' ? 'selected' : ''}>Public Holiday</option>
                    <option value="Corporate" ${holiday.type === 'Corporate' ? 'selected' : ''}>Corporate Event</option>
                    <option value="Training" ${holiday.type === 'Training' ? 'selected' : ''}>Training Blackout</option>
                    <option value="Other" ${holiday.type === 'Other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="editHolidayRecurring" ${holiday.isRecurring ? 'checked' : ''} style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
                <span style="vertical-align: middle;">Recurring Holiday</span>
            </label>
            <div class="form-help">Check if this holiday repeats annually (e.g., Christmas, New Year)</div>
        </div>

        <div class="form-group" id="editRecurringRuleGroup" style="display: ${holiday.isRecurring ? 'block' : 'none'};">
            <label class="form-label">Recurring Rule</label>
            <input type="text" class="form-input" id="editHolidayRecurringRule" value="${escapeHtml(holiday.recurringRule || '')}" placeholder="e.g., Fourth Thursday of November">
            <div class="form-help">Describe when this holiday occurs each year</div>
        </div>

        <script>
            document.getElementById('editHolidayRecurring').addEventListener('change', function(e) {
                document.getElementById('editRecurringRuleGroup').style.display = e.target.checked ? 'block' : 'none';
            });
        <\/script>
    `;

    const footer = `
        <button class="btn btn-ghost" onclick="closeModal(); editCalendar(${calendarId})">Cancel</button>
        <button class="btn btn-primary" onclick="saveHolidayEdits(${calendarId}, ${holidayIndex})">Save Changes</button>
    `;

    openModal('Edit Holiday', html, footer);
}

function saveHolidayEdits(calendarId, holidayIndex) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal || !cal.holidays || !cal.holidays[holidayIndex]) return;

    const name = document.getElementById('editHolidayName').value.trim();
    const date = document.getElementById('editHolidayDate').value;

    if (!name) {
        alert('Please enter a holiday name');
        return;
    }

    if (!date) {
        alert('Please select a date');
        return;
    }

    const isRecurring = document.getElementById('editHolidayRecurring').checked;
    const recurringRule = isRecurring ? document.getElementById('editHolidayRecurringRule').value.trim() : '';

    // Update the holiday
    cal.holidays[holidayIndex] = {
        date: date,
        name: name,
        type: document.getElementById('editHolidayType').value,
        isRecurring: isRecurring,
        recurringRule: recurringRule
    };

    cal.lastModified = new Date().toISOString();

    triggerSave();
    renderCalendars();
    closeModal();
    editCalendar(calendarId);
}

function deleteHoliday(calendarId, holidayIndex) {
    const cal = regionalCalendars.find(c => c.id === calendarId);
    if (!cal || !cal.holidays || !cal.holidays[holidayIndex]) return;

    const holiday = cal.holidays[holidayIndex];

    if (settings.confirmBeforeDelete) {
        if (!confirm(`Delete holiday "${holiday.name}"?`)) {
            return;
        }
    }

    cal.holidays.splice(holidayIndex, 1);
    cal.lastModified = new Date().toISOString();

    triggerSave();
    renderCalendars();
    editCalendar(calendarId);
}

function deleteCalendar(calendarId) {
    const useCount = resources.filter(r => {
        // Handle both old single ID and new array format
        if (r.regionalCalendarIds && Array.isArray(r.regionalCalendarIds)) {
            return r.regionalCalendarIds.includes(calendarId);
        }
        // Legacy support for old format
        return r.regionalCalendarId === calendarId;
    }).length;

    if (useCount > 0 && settings.confirmBeforeDelete) {
        if (!confirm(`This calendar is used by ${useCount} resources. Continue?`)) {
            return;
        }
    }

    const index = regionalCalendars.findIndex(c => c.id === calendarId);
    if (index > -1) {
        regionalCalendars.splice(index, 1);
        closeModal();
        triggerSave();
        renderCalendars();
    }
}

// === REPORTS (TAB 7) ===
function renderReports() {
    const content = document.getElementById('reportsContent');

    const html = `
        <h2 class="mb-2">Reports & Analytics</h2>

        <div class="grid-2">
            <div class="card">
                <h3 class="card-title">Budget Utilization</h3>
                <div class="card-body">
                    ${renderBudgetReport()}
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Training Progress</h3>
                <div class="card-body">
                    ${renderProgressReport()}
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Competency Gap Analysis</h3>
                <div class="card-body">
                    ${renderGapAnalysis()}
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Course Effectiveness</h3>
                <div class="card-body">
                    ${renderCourseEffectiveness()}
                </div>
            </div>
        </div>

        <div class="card mt-2">
            <h3 class="card-title">Data Management</h3>
            <div class="card-body">
                <div class="quick-actions">
                    <button class="btn btn-secondary" onclick="exportToJSON()">üì• Export to JSON</button>
                    <button class="btn btn-secondary" onclick="importFromJSON()">üì§ Import from JSON</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">üìä Export to Excel</button>
                    <button class="btn btn-warning" onclick="loadSampleData()">üîÑ Load Sample Data</button>
                    <button class="btn btn-error" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>
    `;

    content.innerHTML = html;
}

function renderBudgetReport() {
    const totalBudget = resources.reduce((sum, r) => sum + (r.annualTrainingBudget || 0), 0);
    const totalSpent = resources.reduce((sum, r) => sum + (r.budgetSpent || 0), 0);
    const remaining = totalBudget - totalSpent;
    const utilization = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;

    return `
        <div style="margin-bottom: 20px;">
            <div class="progress-labeled">
                <div class="progress-bar" style="flex: 1;">
                    <div class="progress-fill" style="width: ${utilization}%"></div>
                </div>
                <div class="progress-label">${utilization}%</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">Total Budget</div>
                <div style="font-size: 20px; font-weight: 600;">${formatCurrency(totalBudget)}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">Spent</div>
                <div style="font-size: 20px; font-weight: 600;">${formatCurrency(totalSpent)}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">Remaining</div>
                <div style="font-size: 20px; font-weight: 600;">${formatCurrency(remaining)}</div>
            </div>
        </div>
    `;
}

function renderProgressReport() {
    let totalCourses = 0;
    let completedCourses = 0;

    resources.forEach(r => {
        if (r.assignedCourses) {
            totalCourses += r.assignedCourses.length;
            completedCourses += r.assignedCourses.filter(c => c.status === 'Completed').length;
        }
    });

    const completionRate = totalCourses > 0 ? Math.round((completedCourses / totalCourses) * 100) : 0;

    return `
        <div style="margin-bottom: 20px;">
            <div class="progress-labeled">
                <div class="progress-bar progress-bar-success" style="flex: 1;">
                    <div class="progress-fill" style="width: ${completionRate}%"></div>
                </div>
                <div class="progress-label">${completionRate}%</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">Total Courses</div>
                <div style="font-size: 20px; font-weight: 600;">${totalCourses}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">Completed</div>
                <div style="font-size: 20px; font-weight: 600;">${completedCourses}</div>
            </div>
        </div>
    `;
}

function renderGapAnalysis() {
    const totalGaps = resources.reduce((sum, r) => sum + (r.desiredCompetencies?.length || 0), 0);

    return `
        <div>
            <p style="font-size: 28px; font-weight: 600; text-align: center; margin: 20px 0;">
                ${totalGaps}
            </p>
            <p style="text-align: center; color: var(--text-muted);">
                Competency gaps to close
            </p>
        </div>
    `;
}

function renderCourseEffectiveness() {
    return `
        <div>
            <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                Course effectiveness metrics will be calculated as team members complete courses and provide feedback.
            </p>
        </div>
    `;
}

// === IMPORT/EXPORT FUNCTIONS ===
function exportToJSON() {
    const exportData = {
        version: '1.0.24',
        exportDate: new Date().toISOString(),
        resources: resources,
        competencyLibrary: competencyLibrary,
        courseCatalog: courseCatalog,
        regionalCalendars: regionalCalendars,
        trainingPlans: trainingPlans,
        settings: settings
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `training-plan-manager-export-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    URL.revokeObjectURL(url);

    openModal('Export Complete', `
        <div class="alert alert-success">
            Your data has been exported successfully!
        </div>
        <p>The file has been downloaded to your computer.</p>
    `);
}

function importFromJSON() {
    const input = document.getElementById('fileInput');
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importData = JSON.parse(event.target.result);

                // Validate data structure
                if (!importData.resources || !Array.isArray(importData.resources)) {
                    throw new Error('Invalid data format');
                }

                if (!confirm('This will replace all current data. Are you sure?')) {
                    return;
                }

                // Import data
                resources = importData.resources || [];
                competencyLibrary = importData.competencyLibrary || [];
                courseCatalog = importData.courseCatalog || [];
                regionalCalendars = importData.regionalCalendars || [];
                trainingPlans = importData.trainingPlans || [];
                if (importData.settings) {
                    settings = { ...settings, ...importData.settings };
                }

                // Update IDs
                nextResourceId = Math.max(...resources.map(r => r.id), 0) + 1;
                nextCompetencyId = Math.max(...competencyLibrary.map(c => c.id), 0) + 1;
                nextCourseId = Math.max(...courseCatalog.map(c => c.id), 0) + 1;
                nextCalendarId = Math.max(...regionalCalendars.map(c => c.id), 0) + 1;
                nextPlanId = Math.max(...trainingPlans.map(p => p.id), 0) + 1;

                triggerSave();
                renderAllViews();

                openModal('Import Complete', `
                    <div class="alert alert-success">
                        Your data has been imported successfully!
                    </div>
                    <p>Imported: ${resources.length} resources, ${competencyLibrary.length} competencies, ${courseCatalog.length} courses</p>
                `);
            } catch (error) {
                openModal('Import Failed', `
                    <div class="alert alert-error">
                        Failed to import data: ${error.message}
                    </div>
                `);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function exportToExcel() {
    if (typeof XLSX === 'undefined') {
        alert('Excel export library not loaded');
        return;
    }

    // Create workbook
    const wb = XLSX.utils.book_new();

    // Resources sheet
    const resourcesData = resources.map(r => ({
        'Name': r.name,
        'Job Title': r.jobTitle || '',
        'Department': r.department || '',
        'Location': r.location || '',
        'Email': r.email || '',
        'Budget': r.annualTrainingBudget || 0,
        'Budget Spent': r.budgetSpent || 0,
        'Competencies': r.currentCompetencies?.length || 0,
        'Courses': r.assignedCourses?.length || 0
    }));
    const resourcesSheet = XLSX.utils.json_to_sheet(resourcesData);
    XLSX.utils.book_append_sheet(wb, resourcesSheet, 'Resources');

    // Competencies sheet
    const competenciesData = competencyLibrary.map(c => ({
        'Name': c.name,
        'Category': c.category || '',
        'Subcategory': c.subcategory || '',
        'Description': c.description || ''
    }));
    const competenciesSheet = XLSX.utils.json_to_sheet(competenciesData);
    XLSX.utils.book_append_sheet(wb, competenciesSheet, 'Competencies');

    // Courses sheet
    const coursesData = courseCatalog.map(c => ({
        'Title': c.title,
        'Provider': c.provider,
        'Cost': c.cost || 0,
        'Duration (hrs)': c.duration?.totalHours || 0,
        'Format': c.format,
        'Level': c.skillLevel,
        'Rating': c.rating || 0,
        'Certification': c.hasCertification ? 'Yes' : 'No'
    }));
    const coursesSheet = XLSX.utils.json_to_sheet(coursesData);
    XLSX.utils.book_append_sheet(wb, coursesSheet, 'Courses');

    // Training Plans sheet
    const plansData = trainingPlans.map(p => {
        const resource = resources.find(r => r.id === p.resourceId);
        return {
            'Plan Name': p.planName,
            'Resource': resource ? resource.name : 'Unknown',
            'Status': p.status,
            'Budget': p.allocatedBudget || 0,
            'Courses': p.scheduledCourses?.length || 0,
            'Start Date': p.planPeriod?.startDate || '',
            'End Date': p.planPeriod?.endDate || ''
        };
    });
    const plansSheet = XLSX.utils.json_to_sheet(plansData);
    XLSX.utils.book_append_sheet(wb, plansSheet, 'Training Plans');

    // Write file
    XLSX.writeFile(wb, `training-plan-manager-export-${new Date().toISOString().split('T')[0]}.xlsx`);

    openModal('Export Complete', `
        <div class="alert alert-success">
            Excel file exported successfully!
        </div>
    `);
}

function clearAllData() {
    if (!confirm('Are you SURE you want to delete ALL data? This cannot be undone!')) {
        return;
    }

    if (!confirm('Final confirmation: This will permanently delete all resources, competencies, courses, calendars, and training plans.')) {
        return;
    }

    resources = [];
    competencyLibrary = [];
    courseCatalog = [];
    regionalCalendars = [];
    trainingPlans = [];

    nextResourceId = 1;
    nextCompetencyId = 1;
    nextCourseId = 1;
    nextCalendarId = 1;
    nextPlanId = 1;

    triggerSave();
    renderAllViews();

    openModal('Data Cleared', `
        <div class="alert alert-success">
            All data has been cleared. You can load sample data to get started.
        </div>
    `);
}

// === AI INTEGRATION ===
async function callClaudeAPI(systemPrompt, userPrompt) {
    const apiKey = getEffectiveApiKey();
    if (!apiKey) {
        throw new Error('API key not configured. Please add your API key in Settings.');
    }

    const provider = settings.aiProvider || 'anthropic';
    const model = settings.aiModel || 'claude-3-5-sonnet-20241022';
    const temperature = settings.aiTemperature || 0.7;
    const corsProxy = settings.corsProxy || '';

    let apiUrl, headers, body;

    // Configure API call based on provider
    if (provider === 'anthropic') {
        apiUrl = 'https://api.anthropic.com/v1/messages';
        headers = {
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'content-type': 'application/json'
        };
        body = {
            model: model,
            max_tokens: 4096,
            temperature: temperature,
            system: systemPrompt,
            messages: [{ role: 'user', content: userPrompt }]
        };
    } else if (provider === 'openai') {
        apiUrl = 'https://api.openai.com/v1/chat/completions';
        headers = {
            'Authorization': `Bearer ${apiKey}`,
            'content-type': 'application/json'
        };
        body = {
            model: model,
            max_tokens: 4096,
            temperature: temperature,
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
            ]
        };
    } else if (provider === 'google') {
        // Google Gemini API uses a different URL pattern
        apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        headers = {
            'content-type': 'application/json'
        };
        body = {
            contents: [{
                parts: [{
                    text: `${systemPrompt}\n\n${userPrompt}`
                }]
            }],
            generationConfig: {
                temperature: temperature,
                maxOutputTokens: 4096
            }
        };
    } else {
        throw new Error(`Unsupported AI provider: ${provider}`);
    }

    // Apply CORS proxy if configured
    if (corsProxy && corsProxy.trim()) {
        apiUrl = corsProxy + apiUrl;
    }

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            let errorMessage = `AI API request failed (${response.status})`;
            try {
                const error = await response.json();
                if (provider === 'anthropic') {
                    errorMessage = error.error?.message || errorMessage;
                } else if (provider === 'openai') {
                    errorMessage = error.error?.message || errorMessage;
                } else if (provider === 'google') {
                    errorMessage = error.error?.message || errorMessage;
                }
            } catch (e) {
                // If we can't parse error JSON, use the status text
                errorMessage = response.statusText || errorMessage;
            }
            throw new Error(errorMessage);
        }

        const data = await response.json();

        // Extract text based on provider response format
        if (provider === 'anthropic') {
            return data.content[0].text;
        } else if (provider === 'openai') {
            return data.choices[0].message.content;
        } else if (provider === 'google') {
            return data.candidates[0].content.parts[0].text;
        }

    } catch (error) {
        // Handle network errors (including CORS)
        if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
            const providerName = provider.toUpperCase();
            const corsHelpText = corsProxy ?
                `\n\nYour CORS proxy (${corsProxy}) may be unavailable or incorrectly configured.` :
                `\n\nSolution: Configure a CORS proxy in Settings (Advanced). Example: https://cors-anywhere.herokuapp.com/`;

            throw new Error(`Cannot connect to ${providerName} API.${corsHelpText}\n\nPossible causes:\n‚Ä¢ CORS restrictions (browser blocks direct API calls)\n‚Ä¢ Network/firewall blocking the request\n‚Ä¢ Invalid API key or endpoint\n‚Ä¢ CORS proxy not configured\n\nFor details, see the API Integration guide.`);
        }
        throw error;
    }
}

async function analyzeCompetenciesWithAI(resourceData) {
    const systemPrompt = `You are an expert HR consultant specializing in technical competency assessment.
Analyze the provided job role and suggest relevant technical competencies with proficiency levels.
Return your response as a JSON array of objects with: name, category, currentLevel (1-5), rationale.`;

    const userPrompt = `Analyze this role and suggest 5-8 key competencies:
Job Title: ${resourceData.jobTitle}
Department: ${resourceData.department}
Additional context: ${resourceData.context || 'None'}`;

    try {
        const response = await callClaudeAPI(systemPrompt, userPrompt);
        return JSON.parse(response);
    } catch (error) {
        console.error('AI analysis failed:', error);
        throw error;
    }
}

async function suggestGoalsWithAI(resource, currentCompetencies) {
    const systemPrompt = `You are a career development advisor. Based on the resource's current competencies and role,
suggest training goals that will help them advance in their career. Return JSON array with: competencyName,
targetLevel (1-5), priority (Critical/High/Medium/Low), rationale.`;

    const userPrompt = `Suggest 3-5 training goals for:
Name: ${resource.name}
Title: ${resource.jobTitle}
Current Competencies: ${JSON.stringify(currentCompetencies)}`;

    try {
        const response = await callClaudeAPI(systemPrompt, userPrompt);
        return JSON.parse(response);
    } catch (error) {
        console.error('AI goal suggestions failed:', error);
        throw error;
    }
}

async function discoverCoursesWithAI(goals, constraints) {
    const systemPrompt = `You are a training course advisor. Search for and recommend training courses
that match the specified goals and constraints. Return JSON array with: title, provider, cost, duration,
url, format, skillLevel, relevanceScore (1-10), rationale.`;

    const userPrompt = `Find courses for these goals:
Goals: ${JSON.stringify(goals)}
Budget: ${constraints.budget}
Format Preference: ${constraints.format}
Location: ${constraints.location}`;

    try {
        const response = await callClaudeAPI(systemPrompt, userPrompt);
        return JSON.parse(response);
    } catch (error) {
        console.error('AI course discovery failed:', error);
        throw error;
    }
}

// === SAMPLE DATA ===
function loadSampleData() {
    if (!confirm('This will replace all existing data with sample data. Continue?')) {
        return;
    }

    // Clear existing
    resources = [];
    competencyLibrary = [];
    courseCatalog = [];
    regionalCalendars = [];
    trainingPlans = [];

    // Reset IDs
    nextResourceId = 1;
    nextCompetencyId = 1;
    nextCourseId = 1;
    nextCalendarId = 1;
    nextPlanId = 1;

    // Load sample data
    loadSampleCompetencies();
    loadSampleCourses();
    loadSampleCalendars();
    loadSampleResources();

    triggerSave();
    renderAllViews();

    openModal('Sample Data Loaded', `
        <div class="alert alert-success">
            Sample data has been loaded successfully!
        </div>
        <p>Loaded: ${resources.length} resources, ${competencyLibrary.length} competencies, ${courseCatalog.length} courses</p>
    `);
}

function loadSampleCompetencies() {
    const sampleCompetencies = [
        { name: 'Python Programming', category: 'Programming Languages', subcategory: 'Backend Development' },
        { name: 'JavaScript/TypeScript', category: 'Programming Languages', subcategory: 'Full Stack Development' },
        { name: 'Java Development', category: 'Programming Languages', subcategory: 'Enterprise Development' },
        { name: 'Go Programming', category: 'Programming Languages', subcategory: 'Backend Development' },
        { name: 'AWS Cloud', category: 'Cloud Platforms', subcategory: 'Public Cloud' },
        { name: 'Azure Cloud', category: 'Cloud Platforms', subcategory: 'Public Cloud' },
        { name: 'Google Cloud Platform', category: 'Cloud Platforms', subcategory: 'Public Cloud' },
        { name: 'Kubernetes', category: 'Cloud Platforms', subcategory: 'Container Orchestration' },
        { name: 'Docker', category: 'DevOps', subcategory: 'Containerization' },
        { name: 'CI/CD Pipelines', category: 'DevOps', subcategory: 'Automation' },
        { name: 'Terraform', category: 'DevOps', subcategory: 'Infrastructure as Code' },
        { name: 'Security Best Practices', category: 'Security', subcategory: 'Application Security' },
        { name: 'OWASP Top 10', category: 'Security', subcategory: 'Web Security' },
        { name: 'SQL Databases', category: 'Data', subcategory: 'Databases' },
        { name: 'NoSQL Databases', category: 'Data', subcategory: 'Databases' },
        { name: 'Data Engineering', category: 'Data', subcategory: 'Data Pipelines' },
        { name: 'Leadership', category: 'Soft Skills', subcategory: 'Management' },
        { name: 'Technical Communication', category: 'Soft Skills', subcategory: 'Communication' }
    ];

    sampleCompetencies.forEach(comp => {
        competencyLibrary.push({
            id: nextCompetencyId++,
            name: comp.name,
            category: comp.category,
            subcategory: comp.subcategory,
            description: `Professional knowledge and skills in ${comp.name}`,
            levelDefinitions: {
                1: { name: 'Awareness', description: 'Basic understanding. Can follow documentation with guidance.' },
                2: { name: 'Beginner', description: 'Can perform basic tasks independently. Needs help with complex scenarios.' },
                3: { name: 'Intermediate', description: 'Handles most tasks independently. Good working knowledge.' },
                4: { name: 'Advanced', description: 'Expert-level skills. Handles complex scenarios confidently.' },
                5: { name: 'Expert', description: 'Industry-recognized expertise. Thought leader.' }
            },
            frameworkMappings: {},
            relatedCompetencies: [],
            prerequisites: [],
            useCount: 0,
            lastUsed: new Date().toISOString(),
            createdDate: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            createdBy: 'System',
            isActive: true
        });
    });
}

function loadSampleCourses() {
    const sampleCourses = [
        { title: 'Complete Python Bootcamp', provider: 'Udemy', cost: 89, duration: 35, format: 'Online Self-Paced', level: 'Beginner', rating: 4.6, cert: false, travel: false, travelCost: 0 },
        { title: 'AWS Certified Solutions Architect', provider: 'A Cloud Guru', cost: 299, duration: 50, format: 'Online Self-Paced', level: 'Intermediate', rating: 4.7, cert: true, travel: false, travelCost: 0 },
        { title: 'Kubernetes for Developers', provider: 'Linux Foundation', cost: 299, duration: 40, format: 'Online Live', level: 'Intermediate', rating: 4.5, cert: true, travel: false, travelCost: 0 },
        { title: 'Advanced JavaScript Concepts', provider: 'Frontend Masters', cost: 390, duration: 15, format: 'Online Self-Paced', level: 'Advanced', rating: 4.8, cert: false, travel: false, travelCost: 0 },
        { title: 'Docker Mastery', provider: 'Udemy', cost: 89, duration: 25, format: 'Online Self-Paced', level: 'Intermediate', rating: 4.7, cert: false, travel: false, travelCost: 0 },
        { title: 'Terraform Associate Certification', provider: 'HashiCorp', cost: 495, duration: 45, format: 'Online Self-Paced', level: 'Intermediate', rating: 4.6, cert: true, travel: false, travelCost: 0 },
        { title: 'OWASP Top 10 Security', provider: 'SANS Institute', cost: 1500, duration: 40, format: 'In-Person', level: 'Advanced', rating: 4.9, cert: true, travel: true, travelCost: 2500 },
        { title: 'Data Engineering Nanodegree', provider: 'Udacity', cost: 1200, duration: 120, format: 'Online Self-Paced', level: 'Intermediate', rating: 4.5, cert: true, travel: false, travelCost: 0 },
        { title: 'React Complete Guide', provider: 'Udemy', cost: 89, duration: 40, format: 'Online Self-Paced', level: 'Intermediate', rating: 4.7, cert: false, travel: false, travelCost: 0 },
        { title: 'Go Programming Language', provider: 'Pluralsight', cost: 299, duration: 30, format: 'Online Self-Paced', level: 'Beginner', rating: 4.6, cert: false, travel: false, travelCost: 0 },
        { title: 'Azure Fundamentals', provider: 'Microsoft Learn', cost: 0, duration: 25, format: 'Online Self-Paced', level: 'Beginner', rating: 4.5, cert: true, travel: false, travelCost: 0 },
        { title: 'Leadership for Tech Managers', provider: 'Coursera', cost: 200, duration: 20, format: 'Hybrid', level: 'All Levels', rating: 4.4, cert: true, travel: true, travelCost: 1800 }
    ];

    sampleCourses.forEach(course => {
        courseCatalog.push({
            id: nextCourseId++,
            title: course.title,
            provider: course.provider,
            providerType: 'MOOC',
            url: '',
            description: `Comprehensive training on ${course.title}`,
            format: course.format,
            duration: { totalHours: course.duration, weeksToComplete: 0, hoursPerWeek: 0 },
            location: '',
            language: 'English',
            cost: course.cost,
            costCurrency: 'USD',
            costNotes: '',
            rating: course.rating,
            ratingCount: Math.floor(Math.random() * 10000) + 1000,
            sentiment: 'Excellent',
            sentimentSummary: 'Highly recommended by learners',
            skillLevel: course.level,
            keyTopics: [],
            learningObjectives: [],
            prerequisites: [],
            hasCertification: course.cert,
            certificationName: course.cert ? `${course.title} Certificate` : '',
            certificationBody: course.cert ? course.provider : '',
            certificationValidityYears: course.cert ? 3 : 0,
            requiresTravel: course.travel,
            estimatedTravelCost: course.travelCost,
            relevantCompetencies: [],
            discoveredBy: 'Sample Data',
            discoveryDate: new Date().toISOString(),
            discoveryContext: '',
            timesAssigned: 0,
            completionRate: 0,
            averageRating: 0,
            isActive: true,
            isRecommended: course.rating > 4.6,
            isDeprecated: false,
            deprecationNote: '',
            createdDate: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            lastVerified: new Date().toISOString()
        });
    });
}

function loadSampleCalendars() {
    // US Federal Holidays
    regionalCalendars.push({
        id: nextCalendarId++,
        name: 'US Federal Holidays 2024',
        region: 'US',
        description: 'United States Federal Holidays',
        year: 2024,
        holidays: [
            { date: '2024-01-01', name: "New Year's Day", type: 'Public', isRecurring: true, recurringRule: 'January 1' },
            { date: '2024-01-15', name: 'Martin Luther King Jr. Day', type: 'Public', isRecurring: true, recurringRule: 'Third Monday of January' },
            { date: '2024-02-19', name: "Presidents' Day", type: 'Public', isRecurring: true, recurringRule: 'Third Monday of February' },
            { date: '2024-05-27', name: 'Memorial Day', type: 'Public', isRecurring: true, recurringRule: 'Last Monday of May' },
            { date: '2024-07-04', name: 'Independence Day', type: 'Public', isRecurring: true, recurringRule: 'July 4' },
            { date: '2024-09-02', name: 'Labor Day', type: 'Public', isRecurring: true, recurringRule: 'First Monday of September' },
            { date: '2024-11-28', name: 'Thanksgiving Day', type: 'Public', isRecurring: true, recurringRule: 'Fourth Thursday of November' },
            { date: '2024-12-25', name: 'Christmas Day', type: 'Public', isRecurring: true, recurringRule: 'December 25' }
        ],
        isTemplate: true,
        useCount: 0,
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString()
    });

    // UK Bank Holidays
    regionalCalendars.push({
        id: nextCalendarId++,
        name: 'UK Bank Holidays 2024',
        region: 'UK',
        description: 'United Kingdom Bank Holidays',
        year: 2024,
        holidays: [
            { date: '2024-01-01', name: "New Year's Day", type: 'Public', isRecurring: true, recurringRule: 'January 1' },
            { date: '2024-03-29', name: 'Good Friday', type: 'Public', isRecurring: false, recurringRule: '' },
            { date: '2024-04-01', name: 'Easter Monday', type: 'Public', isRecurring: false, recurringRule: '' },
            { date: '2024-05-06', name: 'Early May Bank Holiday', type: 'Public', isRecurring: true, recurringRule: 'First Monday of May' },
            { date: '2024-05-27', name: 'Spring Bank Holiday', type: 'Public', isRecurring: true, recurringRule: 'Last Monday of May' },
            { date: '2024-08-26', name: 'Summer Bank Holiday', type: 'Public', isRecurring: true, recurringRule: 'Last Monday of August' },
            { date: '2024-12-25', name: 'Christmas Day', type: 'Public', isRecurring: true, recurringRule: 'December 25' },
            { date: '2024-12-26', name: 'Boxing Day', type: 'Public', isRecurring: true, recurringRule: 'December 26' }
        ],
        isTemplate: true,
        useCount: 0,
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString()
    });
}

function loadSampleResources() {
    const sampleResourcesData = [
        { name: 'John Smith', title: 'Senior Developer', dept: 'Engineering', location: 'New York, USA', budget: 5000, spent: 2500 },
        { name: 'Jane Doe', title: 'Security Engineer', dept: 'Security', location: 'London, UK', budget: 4000, spent: 3800 },
        { name: 'Bob Wilson', title: 'DevOps Engineer', dept: 'Infrastructure', location: 'Remote', budget: 3000, spent: 500 },
        { name: 'Sarah Lee', title: 'QA Lead', dept: 'Quality', location: 'Singapore', budget: 5000, spent: 2000 },
        { name: 'Mike Chen', title: 'Data Engineer', dept: 'Data', location: 'San Francisco, USA', budget: 4500, spent: 1500 },
        { name: 'Emma Brown', title: 'Frontend Developer', dept: 'Engineering', location: 'Berlin, Germany', budget: 3500, spent: 1000 }
    ];

    sampleResourcesData.forEach((data, index) => {
        const resource = {
            id: nextResourceId++,
            name: data.name,
            email: `${data.name.toLowerCase().replace(' ', '.')}@company.com`,
            jobTitle: data.title,
            department: data.dept,
            location: data.location,
            hireDate: new Date(2020 + index, index % 12, 1).toISOString().split('T')[0],
            canAttendInPerson: data.location !== 'Remote',
            annualTrainingBudget: data.budget,
            budgetSpent: data.spent,
            annualTravelBudget: data.location !== 'Remote' ? 3000 : 0,
            travelBudgetSpent: 0,
            budgetYear: new Date().getFullYear(),
            currentCompetencies: [],
            desiredCompetencies: [],
            weeklyTrainingHours: 5,
            preferredTrainingDays: ['Tuesday', 'Thursday'],
            learningPace: 'Moderate',
            formatPreference: 'Online',
            regionalCalendarIds: data.location.includes('US') ? [1] : (data.location.includes('UK') ? [2] : []),
            personalTimeOff: [],
            blackoutPeriods: [],
            assignedCourses: [],
            notes: '',
            tags: [],
            createdDate: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            createdBy: 'System'
        };

        // Add some sample competencies
        if (index === 0) { // John - Developer
            resource.currentCompetencies = [
                { competencyId: 1, currentLevel: 4, assessmentDate: new Date().toISOString(), assessedBy: 'Manager', notes: '' },
                { competencyId: 2, currentLevel: 3, assessmentDate: new Date().toISOString(), assessedBy: 'Manager', notes: '' }
            ];
            resource.desiredCompetencies = [
                { competencyId: 5, targetLevel: 3, priority: 'High', targetDate: '2024-06-30', rationale: 'Cloud migration project' }
            ];
        }

        resources.push(resource);
    });
}

</script>
</body>
</html>
