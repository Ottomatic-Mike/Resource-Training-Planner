<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Plan Manager - Setup</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, Roboto, sans-serif;
            background: linear-gradient(135deg, #044d4b 0%, #056663 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #1e293b;
        }
        .setup-container { width: 100%; max-width: 520px; }
        .setup-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            padding: 36px 40px;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        .setup-header { text-align: center; margin-bottom: 28px; }
        .setup-header h1 { font-size: 20px; font-weight: 700; color: #0f172a; }
        .setup-header p { font-size: 14px; color: #64748b; margin-top: 6px; line-height: 1.5; }

        .section-label {
            font-size: 11px; font-weight: 700; color: #044d4b;
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 12px; margin-top: 4px;
        }
        .divider { height: 1px; background: #e5e7eb; margin: 22px 0; }

        /* Mode selector */
        .mode-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }
        .mode-option {
            padding: 16px 14px; border: 2px solid #e5e7eb; border-radius: 10px;
            cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .mode-option:hover { border-color: #0a8a87; background: #f0fafa; }
        .mode-option.selected { border-color: #044d4b; background: #e6f5f5; }
        .mode-option .mode-icon { font-size: 28px; margin-bottom: 6px; }
        .mode-option .mode-title { font-size: 14px; font-weight: 700; color: #0f172a; }
        .mode-option .mode-desc { font-size: 12px; color: #64748b; margin-top: 3px; line-height: 1.3; }
        .mode-option.selected .mode-title { color: #044d4b; }
        .mode-option .badge {
            display: inline-block; font-size: 9px; font-weight: 700;
            color: white; background: #044d4b; padding: 2px 6px;
            border-radius: 3px; margin-top: 6px;
        }

        /* Form elements */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .form-input {
            width: 100%; padding: 9px 12px; border: 1.5px solid #d1d5db; border-radius: 8px;
            font-size: 14px; font-family: inherit; background: white;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-input:focus { outline: none; border-color: #044d4b; box-shadow: 0 0 0 3px rgba(4,77,75,0.1); }
        .form-input::placeholder { color: #9ca3af; }
        .form-input.mono { font-family: "SF Mono", "Fira Code", "Consolas", monospace; font-size: 13px; }
        .form-help { font-size: 12px; color: #6b7280; margin-top: 3px; line-height: 1.4; }

        /* AI key rows */
        .ai-key-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .ai-key-row .provider-label { width: 80px; font-size: 13px; font-weight: 600; color: #374151; flex-shrink: 0; }
        .ai-key-row .provider-label small { display: block; font-weight: 400; color: #9ca3af; font-size: 11px; }
        .ai-key-row input { flex: 1; }

        /* Buttons */
        .btn {
            padding: 10px 24px; border: none; border-radius: 8px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #044d4b; color: white; width: 100%; justify-content: center; }
        .btn-primary:hover:not(:disabled) { background: #033d3b; }

        /* Alert boxes */
        .alert { padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-bottom: 14px; line-height: 1.5; }
        .alert-info { background: #e6f5f5; border: 1px solid #b3e0df; color: #044d4b; }
        .alert-error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .alert-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }

        /* Spinner */
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }

        .skip-link { text-align: center; margin-top: 14px; font-size: 13px; color: rgba(255,255,255,0.7); }
        .skip-link a { color: white; text-decoration: none; font-weight: 500; }
        .skip-link a:hover { text-decoration: underline; }

        /* SSO info panel */
        .sso-info {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;
            padding: 20px; text-align: center;
        }
        .sso-info h3 { font-size: 15px; font-weight: 700; color: #0f172a; margin-bottom: 8px; }
        .sso-info p { font-size: 13px; color: #64748b; line-height: 1.5; margin-bottom: 14px; }
        .sso-info .cmd-line {
            background: #1e293b; color: #e2e8f0; border-radius: 8px;
            font-family: "SF Mono", "Fira Code", "Consolas", monospace; font-size: 13px;
            text-align: left; margin-bottom: 8px;
            display: flex; align-items: center; overflow: hidden;
        }
        .sso-info .cmd-line code { flex: 1; padding: 10px 14px; -webkit-user-select: all; user-select: all; }
        .sso-info .cmd-line .cmd-label { color: #94a3b8; font-size: 11px; padding-left: 14px; white-space: nowrap; }
        .sso-info .cmd-copy {
            background: #334155; border: none; color: #94a3b8; padding: 10px 12px;
            font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;
            font-family: inherit; transition: all 0.15s;
        }
        .sso-info .cmd-copy:hover { background: #475569; color: #e2e8f0; }
        .sso-info .cmd-copy.copied { background: #166534; color: #bbf7d0; }
        .sso-info .providers { font-size: 12px; color: #94a3b8; }
        .sso-info .providers strong { color: #64748b; }

        /* Saving overlay */
        .saving-overlay { text-align: center; padding: 40px 0; }
        .saving-spinner {
            width: 36px; height: 36px; border: 3px solid #e2e8f0;
            border-top: 3px solid #044d4b; border-radius: 50%;
            animation: spin 0.7s linear infinite; margin: 0 auto 20px;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-card" id="setupForm">
            <div class="setup-header">
                <h1>Set Up Team Access</h1>
                <p>Choose how your team will sign in and configure AI API keys.</p>
            </div>

            <!-- Mode selection -->
            <div class="section-label">Authentication Method</div>
            <div class="mode-select">
                <div class="mode-option" onclick="selectMode('passcode')" id="modePasscode">
                    <div class="mode-icon">&#128273;</div>
                    <div class="mode-title">Access Code</div>
                    <div class="mode-desc">Set a shared code for your team</div>
                    <div class="badge">Quick Setup</div>
                </div>
                <div class="mode-option" onclick="selectMode('sso')" id="modeSSO">
                    <div class="mode-icon">&#128274;</div>
                    <div class="mode-title">SSO Login</div>
                    <div class="mode-desc">Okta, Microsoft, Google</div>
                </div>
            </div>

            <!-- Passcode setup (in-browser) -->
            <div id="passcodePanel" class="hidden">
                <div class="section-label">Access Code</div>
                <div class="form-group">
                    <label class="form-label">Set a shared access code</label>
                    <input type="password" class="form-input" id="passcodeInput"
                           placeholder="Enter an access code for your team" oninput="validatePasscode()">
                    <div class="form-help">Share this code with team members so they can sign in.</div>
                </div>

                <div class="divider"></div>

                <div class="section-label">AI API Keys <span style="font-weight:400; text-transform:none; letter-spacing:0; color:#6b7280;">&mdash; optional</span></div>
                <div class="ai-key-row">
                    <div class="provider-label">Anthropic <small>Claude</small></div>
                    <input type="password" class="form-input mono" id="keyAnthropic" placeholder="sk-ant-api03-...">
                </div>
                <div class="ai-key-row">
                    <div class="provider-label">OpenAI <small>GPT</small></div>
                    <input type="password" class="form-input mono" id="keyOpenai" placeholder="sk-...">
                </div>
                <div class="ai-key-row">
                    <div class="provider-label">Google <small>Gemini</small></div>
                    <input type="password" class="form-input mono" id="keyGoogle" placeholder="AIza...">
                </div>

                <div class="alert alert-info" style="margin-top: 14px;">
                    Keys are encrypted and stored server-side. Team members sign in with the access code and never see API keys.
                </div>

                <div id="saveError" class="alert alert-error hidden"></div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="savePasscode()" id="saveBtn" disabled>
                        Save &amp; Activate
                    </button>
                </div>
            </div>

            <!-- SSO info (directs to CLI script) -->
            <div id="ssoPanel" class="hidden">
                <div class="sso-info">
                    <h3>Browser-Based SSO Setup</h3>
                    <p>SSO setup uses a script that opens your identity provider in a browser.
                       You authenticate normally â€” credentials are captured and encrypted automatically.</p>
                    <div class="cmd-line">
                        <span class="cmd-label">Windows</span>
                        <code>scripts\setup.bat</code>
                        <button class="cmd-copy" onclick="copyCmd(this, 'scripts\\setup.bat')">Copy</button>
                    </div>
                    <div class="cmd-line">
                        <span class="cmd-label">Mac/Linux</span>
                        <code>scripts/setup.sh</code>
                        <button class="cmd-copy" onclick="copyCmd(this, 'scripts/setup.sh')">Copy</button>
                    </div>
                    <p>The script will:</p>
                    <div style="text-align: left; font-size: 13px; color: #475569; line-height: 1.8; padding-left: 8px;">
                        1. Open a browser to your identity provider<br>
                        2. You sign in with your company credentials<br>
                        3. Your identity is captured automatically<br>
                        4. Credentials are encrypted (AES-256-GCM)<br>
                        5. An access token is generated for the app
                    </div>
                    <div style="margin-top: 16px;" class="providers">
                        <strong>Supported:</strong> Okta, Microsoft Entra ID, Google Workspace
                    </div>
                </div>
            </div>

            <!-- Initial prompt -->
            <div id="modePrompt" style="text-align: center; padding: 12px 0 0; color: #9ca3af; font-size: 13px;">
                Select an authentication method above to continue.
            </div>
        </div>

        <!-- Saving/activating overlay -->
        <div class="setup-card hidden" id="savingCard">
            <div class="saving-overlay">
                <div class="saving-spinner"></div>
                <h2 style="font-size: 18px; font-weight: 600; color: #0f172a;">Activating...</h2>
                <p style="font-size: 14px; color: #64748b; margin-top: 8px;">The server is restarting. You'll be redirected to sign in shortly.</p>
                <p style="margin-top: 16px; font-size: 13px; color: #94a3b8;">If not redirected in 15 seconds, <a href="/login" style="color: #044d4b;">click here</a>.</p>
            </div>
        </div>

        <div class="skip-link">
            <a href="/">Skip &mdash; use without authentication</a>
        </div>
    </div>

    <script>
        let selectedMode = null;

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(mode === 'passcode' ? 'modePasscode' : 'modeSSO').classList.add('selected');
            document.getElementById('modePrompt').classList.add('hidden');
            document.getElementById('passcodePanel').classList.toggle('hidden', mode !== 'passcode');
            document.getElementById('ssoPanel').classList.toggle('hidden', mode !== 'sso');
        }

        function validatePasscode() {
            const code = document.getElementById('passcodeInput').value.trim();
            document.getElementById('saveBtn').disabled = code.length < 1;
        }

        async function savePasscode() {
            const btn = document.getElementById('saveBtn');
            const errEl = document.getElementById('saveError');
            errEl.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Saving...';

            const payload = {
                mode: 'passcode',
                passcode: document.getElementById('passcodeInput').value.trim(),
                aiKeys: {
                    anthropic: document.getElementById('keyAnthropic').value.trim(),
                    openai: document.getElementById('keyOpenai').value.trim(),
                    google: document.getElementById('keyGoogle').value.trim()
                }
            };

            try {
                const res = await fetch('/admin/api/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Unknown error');

                document.getElementById('setupForm').classList.add('hidden');
                document.getElementById('savingCard').classList.remove('hidden');
                pollForRestart();
            } catch (err) {
                errEl.textContent = 'Error: ' + err.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = 'Save &amp; Activate';
            }
        }

        function copyCmd(btn, text) {
            function showCopied() {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
            }
            function fallbackCopy() {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showCopied();
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(showCopied).catch(fallbackCopy);
            } else {
                fallbackCopy();
            }
        }

        function pollForRestart() {
            let attempts = 0;
            setTimeout(() => {
                const interval = setInterval(async () => {
                    attempts++;
                    try {
                        const res = await fetch('/health', { cache: 'no-store' });
                        if (res.ok) {
                            clearInterval(interval);
                            window.location.href = '/login';
                        }
                    } catch (e) { /* server still restarting */ }
                    if (attempts >= 30) {
                        clearInterval(interval);
                        window.location.href = '/login';
                    }
                }, 1000);
            }, 2000);
        }
    </script>
</body>
</html>
